# Яндекс.Метрика - Интеграция аналитики

## Обзор

Сервис аналитики автоматически отслеживает ключевые действия пользователей на сайте и отправляет их в Яндекс.Метрику для анализа поведения.

## Установка

Код счётчика Яндекс.Метрики добавлен в `functions.php` через хук `wp_head` и загружается на всех страницах сайта.

Сервис аналитики инициализируется автоматически при загрузке страницы через `app/app.js`.

## Отслеживаемые события

### Корзина

- **`cart_add_item`** - добавление товара в корзину
  - Параметры: `item_id`, `item_type`, `item_price`
  - Также отправляется ecommerce событие `add`

- **`cart_remove_item`** - удаление товара из корзины
  - Параметры: `item_id`, `item_type`
  - Также отправляется ecommerce событие `remove`

- **`cart_updated`** - обновление корзины
  - Параметры: `items_count`, `total_price`

### Авторизация

- **`user_login`** - вход пользователя
  - Параметры: `user_id`

- **`user_register`** - регистрация нового пользователя
  - Параметры: `user_id`

- **`user_logout`** - выход пользователя

- **`auth_error`** - ошибка авторизации/регистрации
  - Параметры: `error_message`, `error_type`

### Просмотр товаров

- **`product_view`** - просмотр товара (экземпляра игрушки или аксессуара)
  - Параметры: `product_id`, `product_type`, `product_title`
  - Отслеживается при открытии модального окна с детальной информацией о товаре

### Формы

- **`form_submit`** - отправка формы
  - Параметры: `form_type`

- **`form_success`** - успешная отправка формы
  - Параметры: `form_type`, `form_data`

- **`form_error`** - ошибка отправки формы
  - Параметры: `form_id`, `form_type`, `error_message`, `error_type`

- **`form_validation_error`** - ошибка валидации формы
  - Параметры: `form_id`, `form_type`, `validation_errors`

- **`order_form_error`** - ошибка формы заказа
  - Параметры: `form_step`, `error_message`, `error_type`
  - Шаги: `personal`, `personal-authorized`, `payment`, `logistics`

- **`profile_error`** - ошибка обновления профиля
  - Параметры: `action`, `error_message`, `error_type`
  - Действия: `password_change`, `update`

### Заказы

- **`order_created`** - создание заказа
  - Параметры: `order_id`, `order_total`, `items_count`
  - Также отправляется ecommerce событие `purchase` с полными данными о заказе

- **`order_error`** - ошибка создания заказа
  - Параметры: `error_message`, `error_type`

### Каталог (планируется)

- **`catalog_search`** - поиск в каталоге
  - Параметры: `query`, `results_count`

- **`catalog_filters`** - применение фильтров
  - Параметры: `filters`, `results_count`

> **Примечание:** События поиска и фильтров каталога будут отслеживаться, когда компоненты каталога начнут отправлять соответствующие события `elkaretro:catalog:search` и `elkaretro:catalog:filters-applied`.

## Использование API

### Отправка кастомного события

Если нужно отправить кастомное событие из кода:

```javascript
import { trackEvent } from './app/analytics/yandex-metrika.js';

trackEvent('my_custom_event', {
  param1: 'value1',
  param2: 123
});
```

### Отправка ecommerce события

Для отправки ecommerce событий (покупки, добавления в корзину):

```javascript
import { trackEcommerce } from './app/analytics/yandex-metrika.js';

trackEcommerce('purchase', {
  transaction_id: '12345',
  value: 1000,
  currency: 'RUB',
  items: [{
    id: 'toy-instance-123',
    name: 'Игрушка #123',
    category: 'toy_instance',
    price: 500,
    quantity: 2
  }]
});
```

### Отслеживание просмотра страницы

```javascript
import { trackPageView } from './app/analytics/yandex-metrika.js';

trackPageView('/my-page', 'Моя страница');
```

## Настройка целей в Яндекс.Метрике

Для отслеживания конверсий создайте цели в Яндекс.Метрике:

### Успешные действия

1. **Добавление в корзину**: цель по событию `cart_add_item`
2. **Создание заказа**: цель по событию `order_created`
3. **Регистрация**: цель по событию `user_register`
4. **Просмотр товара**: цель по событию `product_view`
5. **Успешная отправка формы**: цель по событию `form_success`

### Отслеживание ошибок

Для анализа проблемных мест создайте цели по событиям ошибок:

1. **Ошибки авторизации**: цель по событию `auth_error`
2. **Ошибки форм**: цель по событию `form_error`
3. **Ошибки валидации**: цель по событию `form_validation_error`
4. **Ошибки заказа**: цель по событию `order_error` или `order_form_error`
5. **Ошибки профиля**: цель по событию `profile_error`

Эти цели помогут понять, на каких этапах пользователи сталкиваются с проблемами и где нужно улучшить UX.

## Ecommerce

Сервис автоматически отправляет ecommerce события для:
- Добавления товаров в корзину (`add`)
- Удаления товаров из корзины (`remove`)
- Покупки (`purchase`)

Эти события доступны в разделе "Электронная торговля" в Яндекс.Метрике.

## Отладка

Для проверки работы аналитики:

1. Откройте консоль браузера (F12)
2. Проверьте, что Метрика загружена: `typeof window.ym === 'function'`
3. Проверьте очередь событий: `window._ymQueue`
4. Используйте расширение "Яндекс.Метрика: Debugger" для Chrome

## Технические детали

- ID счётчика: `105476039`
- Счётчик загружается асинхронно
- События, отправленные до загрузки Метрики, сохраняются в очереди и отправляются после загрузки
- Максимальное время ожидания загрузки Метрики: 5 секунд


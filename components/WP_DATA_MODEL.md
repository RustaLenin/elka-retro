# Data Model для компонентов WordPress

## Система индексации склада

### Формат индекса
**Структура:** `категории-номер_типа-номер_экземпляра`

**Пример:**
- Полный индекс экземпляра: `1-2-4-1-4-2`
  - `1-2-4-1-4` = индекс типа (категории + номер типа)
  - `2` = номер экземпляра (последняя цифра)

### Хранение индексов

#### Toy Type (Тип игрушки)
- **`toy_type_index`** (meta field): хранит только номер типа (например, `2`)
- **Полный индекс типа** вычисляется: `[иерархия категорий через category-of-toys]-[toy_type_index]`

#### Toy Instance (Экземпляр)
- **`title`** (WP post title): полный индекс экземпляра (например, `1-2-4-1-4-2`)
- **`toy_instance_index`** (meta field): только последняя цифра (номер экземпляра, например `2`)

### Правила нумерации
- Нумерация экземпляров последовательная (1, 2, 3...)
- При "удалении" экземпляра: не физическое удаление, а архивация (статус `archived` или custom статус)
- Пропуски в нумерации сохраняются (не перенумеровывать)

### Отображение индексов
- **Для пользователей (frontend):**
  - Показывать `title` (полный индекс) в карточках и модалках экземпляров
  - Индексы типов и категорий пользователю не показывать
- **Для админки:**
  - Показывать все индексы везде где нужно для управления складом

### Поиск по индексу
- **MVP:** не требуется на фронтенде
- **Админка:** нужен поиск по индексу (не в MVP фронтенда)

---

## Toy Type (Тип игрушки) - Custom Post Type `toy_type`

### WP Standard Fields
- `title` - название типа (например, "Малыш с погремушкой")
- `content` - описание типа
- `excerpt` - краткое описание
- `thumbnail` - основное изображение
- `slug` - URL slug

### Meta Fields (Pods)
- `instances` - связи с экземплярами (multi pick → `toy_instance`, через REST: массив полных объектов)
  - **Двусторонняя связь**: можно редактировать как из типа (выбрать несколько экземпляров), так и из экземпляра (выбрать тип)
  - **На странице типа:** используется для отображения всех доступных экземпляров этого типа
  - **REST API:** возвращается как массив полных объектов экземпляров (depth=1, response type="All fields")
- `toy_type_index` - номер типа в категории (number, required)
- `toy_type_photos` - множественные фотографии типа (multi file, images)
- `occurrences` - встречаемость (single pick → taxonomy `occurrence`)
- `year_of_productions` - годы производства (multi pick → taxonomy `year_of_production`)
- `materials` - материалы (multi pick → taxonomy `material`)
- `manufacturers` - производители (multi pick → taxonomy `manufacturer`)
- `sizes` - размеры (multi pick → taxonomy `size`)
- `glass_thicknes` - толщина стекла (multi pick → taxonomy `glass_thickness`)
- `mounting_types` - типы крепления (multi pick → taxonomy `mounting_type`)

### Taxonomies
- `year_of_production` - **годы производства** (не hierarchical)
  - **Описание:** Указывает десятилетия, в которые производился тип игрушки. Один и тот же тип может производиться на протяжении нескольких десятилетий (например, 1950-е, 1960-е, 1970-е)
  - **Использование:** Используется для фильтрации и отображения в карточках типов. Multi pick - можно выбрать несколько вариантов
  - **Возможные значения:**
    1. До 1930-х (`before-the-1930s`) - производство до 1930-х годов
    2. 1930-е (`the-1930s`) - производство в 1930-х годах
    3. 1940-е (`the-1940s`) - производство в 1940-х годах
    4. 1950-е (`the-1950s`) - производство в 1950-х годах
    5. 1960-е (`the-1960s`) - производство в 1960-х годах
    6. 1970-е (`the-1970s`) - производство в 1970-х годах
    7. 1980-е (`the-1980s`) - производство в 1980-х годах
    8. 1990-е (`the-1990s`) - производство в 1990-х годах
    9. 21 век (`21st-century`) - производство в 21 веке
- `manufacturer` - **производители** (не hierarchical)
  - **Описание:** Указывает производителя/завод, на котором производился тип игрушки. Каждый производитель имеет подробное описание с историей предприятия
  - **Использование:** Используется для фильтрации и отображения в карточках типов. Описания производителей показывать в хинтах (tooltips)
  - **Важно:** Описания производителей содержат историческую информацию о предприятиях и их переименованиях
  - **Основные производители:**
    1. Завидово (`завидово`) - Завидовский промкомбинат Калининского (позднее — Тверского) облпотребсоюза
    2. Иней-1 (`иней-1`) - Условное название фабрики «Спортигрушка №2 Бауманского райтреста»
    3. Иней-2 (`иней-2`) - Артель «оптик» (третье название предприятия), ставшая впоследствии МПО «Иней»
    4. Иней-3 (`иней-3`) - «Завод стеклянных ёлочных украшений и оптических изделий»
    5. Иней-4 (`иней-4`) - «Московский завод ёлочных украшений»
    6. Иней-5 (`иней-5`) - С 1991 года Московское Производственное Объединение «Иней»
    7. Клин (`клин`) - Группа производств работавших в г. Клин и Клинской области
    8. Конаково (`конаково`) - Калининское (позднее - Тверское) производственное объединение художественных товаров и игрушек
    9. Культигрушка (`kultigrushka`)
    10. Ленигрушка (`ленигрушка`) - Ленинградское производственное объединение «Игрушка»
    11. Малая Вишера (`by-svetlana-malaya-vishera`) - Филиал ПО «Светлана» (Ленинград)
    12. Не установлен (`unknown`) - производитель не определен
    13. НИИигрушки (`toy-research-institute`)
    14. ПО «Ёлочка» (`по-ёлочка`) - Производственное объединение «Елочка», Клинский район, Московская область
    15. Уфа (`уфа`) - АО Уфимский электроламповый завод СВЕТ
- `size` - **размеры** (не hierarchical)
  - **Описание:** Указывает размер игрушки
  - **Использование:** Используется для фильтрации и отображения в карточках типов
  - **Возможные значения:**
    1. Малютки (`tinys`) - самые маленькие игрушки
    2. Крупная мелочь (`large_tinys`) - крупные мелкие игрушки
    3. Стандарт (`standard`) - стандартный размер
    4. Гигант (`giant`) - очень большие игрушки
- `material` - **материалы** (не hierarchical)
  - **Описание:** Указывает материал, из которого изготовлена игрушка
  - **Использование:** Используется для фильтрации и отображения в карточках типов (multi pick)
  - **Статистика:** Около 95% игрушек - стеклянные, остальные 5% - другие материалы
  - **Текущие значения:**
    1. Стекло (`glass`) - стеклянные игрушки (основной материал)
  - **В будущем:** могут появиться другие варианты материалов
- `glass_thickness` - **толщины стекла** (не hierarchical)
  - **Описание:** Указывает толщину стекла игрушки. Применимо только для стеклянных игрушек
  - **Важно:** Для нестеклянных игрушек (например, деревянных) значение будет пустым/не установлено
  - **Использование:** Используется для фильтрации и отображения в карточках типов (multi pick)
  - **Возможные значения:**
    1. Тонкое (`thin`) - тонкое стекло
    2. Стандарт (`standard`) - стандартная толщина стекла
    3. Толстое (`thick`) - толстое стекло
- `mounting_type` - **типы крепления** (не hierarchical)
  - **Описание:** Указывает способ крепления игрушки к ёлке или другой поверхности. В редких случаях один и тот же тип может иметь несколько типов креплений
  - **Использование:** Используется для фильтрации и отображения в карточках типов (multi pick)
  - **Примечание:** В MVP не требуется специальная логика для обработки множественных значений креплений
  - **Возможные значения:**
    1. Подвес (`pendant`) - подвешивается на нитке/петле
    2. Прищепка (`pin`) - крепится прищепкой
    3. Подставка (`base`) - стоит на подставке
    4. Накидка (`wrap`) - накидывается/оборачивается
- `occurrence` - встречаемость (не hierarchical)
  - Возможные значения: "Часто" (often), "Не часто" (not-often), "Редко" (rarely), "Раритет" (rare)
- `category-of-toys` - **категории игрушек** (hierarchical, с `category_index`)
  - **Основная категоризация каталога**
  - Используется в карточках типов и поисковой выдаче
  - Иерархическая структура (родители-дети)
  - Каждая категория имеет `category_index` для формирования полного индекса типа

### REST API Response Structure
```json
{
  "id": 123,
  "title": { "rendered": "Малыш с погремушкой" },
  "content": { "rendered": "Описание типа..." },
  "excerpt": { "rendered": "Краткое описание..." },
  "featured_media": 456,
  "meta": {
    "toy_type_index": "2",
    "toy_type_photos": [789, 790, 791],
    "occurrences": [10],
    "year_of_productions": [20, 21],
    "materials": [30],
    "manufacturers": [40],
    "sizes": [50],
    "glass_thicknes": [60],
    "mounting_types": [70],
    "instances": [
      { "id": 101, "title": { "rendered": "1-2-4-1-4-2" }, "meta": { "cost": "3000.00", ... }, ... },
      { "id": 102, "title": { "rendered": "1-2-4-1-4-3" }, "meta": { "cost": "3500.00", ... }, ... },
      { "id": 103, "title": { "rendered": "1-2-4-1-4-4" }, "meta": { "cost": "3200.00", ... }, ... }
    ]
  },
  "toy_type_category-of-toys": [5, 6],
  "toy_type_year_of_production": [20, 21],
  "toy_type_manufacturer": [40],
  "toy_type_size": [50],
  "toy_type_material": [30],
  "toy_type_glass_thickness": [60],
  "toy_type_mounting_type": [70],
  "toy_type_occurrence": [10],
  "_links": { ... }
}
```

---

## Toy Instance (Экземпляр игрушки) - Custom Post Type `toy_instance`

### WP Standard Fields
- `title` - **полный индекс экземпляра** (например, `1-2-4-1-4-2`)
- `content` - описание состояния, размеров, ремонтов (например, "4 х 9,5 х 3 см Полный перекрас игрушки. Ремонт трубочки.")
- `excerpt` - краткое описание
- `thumbnail` - основное изображение
- `slug` - URL slug (формируется из title)

### Meta Fields (Pods)
- `photos_of_the_toy_instance` - множественные фотографии экземпляра (multi file, images)
- `toy_instance_index` - **номер экземпляра** (последняя цифра полного индекса, number)
- `cost` - **цена экземпляра** (number, формат 9,999.99)
  - Единственное поле для цены - только для экземпляра
  - У типа игрушки нет цены (цена привязана только к конкретному экземпляру)
- `connection_type_of_toy` - **связь с типом** (single pick → `toy_type`, required, через REST: ID или объект)
  - **Двусторонняя связь**: обратная сторона поля `instances` в типе
  - У экземпляра всегда один родитель (тип), у типа может быть много детей (экземпляров)
- `authenticitys` - аутентичность (single pick → taxonomy `authenticity`)
- `lot_configuration` - комплектация лота (single pick → taxonomy `lot_configurations`)
- `propertys` - собственности (single pick → taxonomy `property`)
- `conditions` - состояние (single pick → taxonomy `condition`)
- `tube_conditions` - состояние трубочки (single pick → taxonomy `tube_condition`)
- `paint_types` - тип окраса (single pick → taxonomy `paint_type`)
- `color_types` - характер окраса (multi pick → taxonomy `color_type`)
- `back_colors` - цвет фона (single pick → taxonomy `back_color`)

### Taxonomies
- `authenticity` - **аутентичность** (не hierarchical)
  - **Описание:** Указывает, является ли игрушка оригинальной, восстановленной или репликой
  - **Использование:** Используется для фильтрации в каталоге и поиске (отдельный фильтр)
  - **Возможные значения:**
    1. Оригинал (`origin`) - оригинальная игрушка без изменений
    2. Ремонтированная (`repaired`) - игрушка была отремонтирована
    3. Реновация краски (`renovation-of-paint`) - была проведена реновация краски
    4. Реставрация краски (`restoration-of-paint`) - была проведена реставрация краски
    5. Современная реплика (`modern-replica`) - современная реплика оригинальной игрушки
- `condition` - **состояния** (не hierarchical)
  - **Описание:** Указывает в каком состоянии сохранился конкретный экземпляр игрушки
  - **Использование:** Используется для фильтрации и отображения в карточках экземпляров
  - **Возможные значения:**
    1. Люкс (`excellence`) - отличное состояние
    2. Хорошее (`good`) - хорошее состояние
    3. Так себе (`so-so`) - удовлетворительное состояние
    4. Плохое (`bad`) - плохое состояние
- `lot_configurations` - **комплектации лотов** (не hierarchical)
  - **Описание:** Указывает способ продажи игрушки из набора. Завод выпускал наборы игрушек (например, набор "Чипполино"), и из такого набора можно продавать игрушки разными способами
  - **Использование:** Используется для фильтрации и отображения в карточках экземпляров
  - **Возможные значения:**
    1. Поштучно (`individually`) - продается отдельная игрушка из набора
    2. Не полный набор (`incomplete_set`) - продается неполный набор игрушек из оригинального набора
    3. Полный набор (`the_complete_set`) - продается полный набор игрушек (весь набор целиком)
- `property` - собственности (не hierarchical)
- `tube_condition` - **состояния трубочек** (не hierarchical)
  - **Описание:** Указывает качество сохранности трубочки (стеклянной трубочки внутри игрушки) в процентах
  - **Использование:** Используется для фильтрации и отображения в карточках экземпляров
  - **Возможные значения:**
    1. 100% (`100`) - трубочка полностью сохранилась
    2. Более 75% (`more_75`) - трубочка сохранилась более чем на 75%
    3. 50-75% (`50-75`) - трубочка сохранилась на 50-75%
    4. 25-50% (`25-50`) - трубочка сохранилась на 25-50%
    5. Менее 25% (`less_25`) - трубочка сохранилась менее чем на 25%
- `paint_type` - **типы окрасов** (не hierarchical)
  - **Описание:** Указывает тип окраски игрушки (глянец, матовый и т.д.). Один и тот же тип игрушки может быть окрашен разной краской
  - **Использование:** Используется для фильтрации и отображения в карточках экземпляров
  - **Возможные значения:**
    1. Глянец (`gloss`) - глянцевая краска
    2. Матовый (`matte`) - матовая краска
    3. Не определён (`undefined` или будет добавлен позже) - когда качество не позволяет точно установить тип окраса
- `back_color` - **цвета фона** (не hierarchical)
  - **Описание:** Указывает цвет фона/исполнения игрушки. Один и тот же тип игрушки может быть исполнен в разных цветах (например, морковка может быть не только оранжевой, но и красной, розовой, желтой)
  - **Использование:** Используется для фильтрации и отображения в карточках экземпляров
  - **Возможные значения:**
    1. Белый (`white`)
    2. Голубой (`голубой`)
    3. Другой (`other`) - цвет не указан или не входит в основные варианты
    4. Жёлтый (`yellow`)
    5. Зелёный (`green`)
    6. Золотистый (`gold`)
    7. Красный (`red`)
    8. Малиновый (`малиновый`)
    9. Оранжевый (`orange`)
    10. Прозрачный (`transparent`)
    11. Розовый (`pink`)
    12. Серебристый (`silver`)
    13. Синий (`blue`)
    14. Фиолетовый (`purple`)
    15. Чёрный (`black`)
- `color_type` - **характер окраса** (не hierarchical)
  - **Описание:** Указывает степень непрозрачности покрытия краски. Один и тот же тип может иметь разную степень непрозрачности по покрытию краски
  - **Использование:** Используется для фильтрации и отображения в карточках экземпляров
  - **Возможные значения:**
    1. Прозрачный (`transparent`) - прозрачное покрытие
    2. Полупрозрачный (`half_transparent`) - полупрозрачное покрытие
    3. Сплошной (`full_coverage`) - непрозрачное (сплошное) покрытие

### Статусы публикации
- `publish` - **доступен к продаже** (стандартный статус WP)
- Другие статусы (например, `archived`, `draft`) - не показывать в каталоге, экземпляр недоступен

### REST API Response Structure
```json
{
  "id": 101,
  "title": { "rendered": "1-2-4-1-4-2" },
  "content": { "rendered": "4 х 9,5 х 3 см Полный перекрас игрушки. Ремонт трубочки." },
  "excerpt": { "rendered": "..." },
  "featured_media": 456,
  "status": "publish",
  "meta": {
    "toy_instance_index": "2",
    "cost": "3000.00",
    "photos_of_the_toy_instance": [789, 790, 791],
    "connection_type_of_toy": 123,
    "authenticitys": [15],
    "lot_configuration": [18],
    "propertys": [26],
    "conditions": [28],
    "tube_conditions": [30],
    "paint_types": [46],
    "color_types": [50],
    "back_colors": [52]
  },
  "toy_instance_authenticity": [15],
  "toy_instance_condition": [28],
  "toy_instance_lot_configurations": [18],
  "toy_instance_property": [26],
  "toy_instance_tube_condition": [30],
  "toy_instance_paint_type": [46],
  "toy_instance_back_color": [52],
  "toy_instance_color_type": [50],
  "_links": { ... }
}
```

---

## Post (Новости) - Standard WP Post Type `post`

### WP Standard Fields
- `title` - заголовок новости
- `content` - содержание
- `excerpt` - краткое описание
- `thumbnail` - изображение
- `date` - дата публикации
- `slug` - URL slug

### REST API Response Structure
```json
{
  "id": 456,
  "title": { "rendered": "Новая коллекция" },
  "content": { "rendered": "Полное описание..." },
  "excerpt": { "rendered": "Краткое описание..." },
  "featured_media": 789,
  "date": "2024-01-15T10:00:00",
  "link": "/news/new-collection",
  "_links": { ... }
}
```

---

## Page (Страница) - Standard WP Post Type `page`

### WP Standard Fields
- `title` - заголовок страницы
- `content` - содержание страницы
- `excerpt` - краткое описание (опционально)
- `thumbnail` - изображение (опционально)
- `parent` - родительская страница (для иерархии)
- `slug` - URL slug

### REST API Response Structure
```json
{
  "id": 789,
  "title": { "rendered": "Условия доставки" },
  "content": { "rendered": "Полное содержание страницы..." },
  "parent": 0,
  "link": "/shipping",
  "_links": { ... }
}
```

---

## Вычисление полного индекса типа

**Алгоритм:**
1. Получить связанную категорию через `toy_type_category-of-toys` (может быть несколько, берём первую или главную)
2. Пройти по иерархии категорий, собирая `category_index` каждой
3. Объединить через `-`: `[category_index_1]-[category_index_2]-...-[toy_type_index]`

**Пример:**
- Категория: "Стеклянная игрушка" (индекс `1`) → "агитация" (индекс `8`) → "звёзды, серп и молот" (индекс `1`)
- Тип имеет `toy_type_index = 2`
- Полный индекс типа: `1-8-1-2`

---

## REST API

### Стандартный WP REST API
- **Все данные** отдаются через стандартный WP REST API (`/wp-json/wp/v2/`)
- **Все поля Pods** доступны через `meta` в ответе
- **Все связи** возвращаются как настроено в Pods (например, `instances` как массив полных объектов)
- **Кастомные endpoints:** не требуются для MVP, используем стандартный REST API

⚠️ **ВАЖНО**: Структура данных в Pods REST API может отличаться в зависимости от способа создания (моки vs реальные данные). Подробности см. в [WP_PODS_REST_API.md](./WP_PODS_REST_API.md).

- **Исключения (будут позже):**
  - Формирование заказа из корзины - потребуется кастомный endpoint
  - Оптимизация множественных последовательных запросов (если понадобится)

### Примеры endpoints
- `/wp-json/wp/v2/toy_type/{id}` - получить тип игрушки
- `/wp-json/wp/v2/toy_instance/{id}` - получить экземпляр
- `/wp-json/wp/v2/toy_instance?connection_type_of_toy={type_id}&status=publish` - получить экземпляры по типу
- `/wp-json/wp/v2/toy_instance?toy_instance_authenticity={term_id}&status=publish` - фильтрация по аутентичности
- `/wp-json/wp/v2/toy_instance?toy_instance_condition={term_id}&toy_instance_authenticity={term_id}&status=publish` - множественная фильтрация

---

## Фотографии (Images)

### MVP (текущая реализация)
- **Карточка типа (`toy-type-card`):** показывает только одну картинку типа
  - Используется `thumbnail` (featured_media) или первая из `toy_type_photos`
  - Фото экземпляров в карточке типа не отображаются
- **Страница типа (`toy-type-single`):** показывает картинки типа и список экземпляров с их фото
- **Карточка экземпляра (`toy-instance-card`):** показывает основную фотографию экземпляра

### Post-MVP (будущие версии)
- **Карточка типа с миниатюрами экземпляров:**
  - Асинхронная загрузка миниатюр всех доступных экземпляров типа
  - Горизонтальный скроллер с миниатюрами под основной картинкой типа
  - При клике на миниатюру экземпляра - переход к карточке экземпляра или открытие модалки
  - Отображение min/max цены из доступных экземпляров
  - Кнопка "Заказать" прямо на карточке типа (быстрый заказ)

### Поля для фотографий
- `toy_type.thumbnail` (WP стандарт) - основное изображение типа
- `toy_type.toy_type_photos` (Pods, multi file) - множественные фотографии типа
- `toy_instance.thumbnail` (WP стандарт) - основное изображение экземпляра
- `toy_instance.photos_of_the_toy_instance` (Pods, multi file) - множественные фотографии экземпляра

---

## Цены (Pricing)

### Текущая реализация (MVP)
- **Единственное поле цены:** `cost` в `toy_instance` (экземпляр игрушки)
- **Тип игрушки не имеет цены:** цена привязана только к конкретному экземпляру

### Min/Max цена для типа
- **MVP:** не требуется вычислять или сохранять min/max цены для типа
- **В будущем:** можно подумать о кешировании min/max для оптимизации поиска
- **Отображение:**
  - **На странице типа:** не показывать диапазон цен (показывать только цены конкретных экземпляров)
  - **В карточке типа (результаты поиска):** возможно пригодится в будущем, но не в MVP

### Использование в компонентах
- `toy-instance-card`: отображает `cost` конкретного экземпляра
- `toy-type-card`: цена не отображается (или по требованию - минимальная из доступных экземпляров)
- `toy-type-single`: показывает цены всех доступных экземпляров этого типа (список с `toy-instance-card`)

---

## Важные замечания

1. **Индексы в админке:** важны для работы со складом, но не показывать пользователям
2. **Архивация:** экземпляры не удаляются физически, только меняют статус
3. **Последовательность:** нумерация экземпляров последовательная, но пропуски допустимы при архивации
4. **REST API:** используем стандартный WP REST API для всех операций в MVP
5. **Цены:** только на уровне экземпляров, типы не имеют цен в MVP


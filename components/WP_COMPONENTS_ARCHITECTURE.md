# Архитектура компонентов WordPress

## Общая структура

Все компоненты разделены по сущностям WordPress и используют единую архитектуру на базе `BaseElement`.

```
components/
├── pages/              # Страницы WP (page post type)
│   └── page/
├── posts/              # Новости/посты
│   ├── post-card/      # Карточка новости (статичная)
│   └── post-single/    # Страница новости (автономная)
├── toy-type/           # Тип игрушки (custom post type)
│   ├── toy-type-card/  # Карточка типа (статичная)
│   └── toy-type-single/# Страница типа (автономная)
└── toy-instance/       # Экземпляр игрушки (custom post type)
    ├── toy-instance-card/  # Карточка экземпляра (статичная)
    └── toy-instance-modal/ # Модалка детального просмотра (автономная)
├── category-breadcrumbs/   # Хлебные крошки категорий (автономная)
└── category-catalog/       # Каталог с навигацией по категориям (автономная)
```

## Типы компонентов

### 1. Статичные компоненты (Static)
Данные получают из HTML-атрибутов или значений по умолчанию.

**Примеры:**
- `post-card` - карточка новости
- `toy-type-card` - карточка типа игрушки
- `toy-instance-card` - карточка экземпляра

**Особенности:**
- `stateSchema` с атрибутами `observed: true`
- Инициализация через `initStateFromAttributes()`
- Рендер вызывается после установки атрибутов

### 2. Автономные компоненты (Autonomous)
Минимальные атрибуты (обычно `id`), данные загружают через WP REST API.

**Примеры:**
- `wp-page` - страница WP
- `post-single` - отдельная новость
- `toy-type-single` - страница типа игрушки
- `toy-instance-modal` - модалка экземпляра

**Особенности:**
- `stateSchema` с внутренними полями `loading`, `error`, `data`
- Метод `loadData()` для загрузки через API
- `onStateChanged('id')` для перезагрузки при смене ID

## Сущности и компоненты

### Pages (Страницы WP)
**Описание:** Базовые публичные страницы WordPress, иерархичные, не показываются в ленте.

**Компоненты:**
- `wp-page` - автономный компонент для отдельной страницы

**Использование:**
```html
<wp-page id="123"></wp-page>
```

---

### Posts (Новости)
**Описание:** Новости, акции, объявления о новых категориях товаров или распродажах.

**Компоненты:**
- `post-card` - статичная карточка для ленты
- `post-single` - автономный компонент для отдельной новости

**Использование:**
```html
<!-- Карточка -->
<post-card 
  id="456" 
  title="Новая коллекция"
  excerpt="Описание..."
  date="2024-01-15"
  image="/path/to/image.jpg"
  link="/news/new-collection">
</post-card>

<!-- Страница новости -->
<post-single id="456"></post-single>
```

---

### Toy Type (Тип игрушки)
**Описание:** Тип игрушки (год, завод, редкость). Сам тип не продаётся, но может иметь множество экземпляров.

**Компоненты:**
- `toy-type-card` - статичная карточка для каталога/поиска
- `toy-type-single` - автономный компонент для страницы типа

**Особенности:**
- На странице типа автоматически загружаются доступные экземпляры
- Карточки экземпляров отображаются под описанием типа
- Связана с основной категоризацией через `category-of-toys`
- **Фотографии:** MVP - только одна картинка типа в карточке (thumbnail или первая из toy_type_photos)

**Использование:**
```html
<!-- Карточка типа -->
<toy-type-card 
  id="789"
  title="Ёлочная игрушка 'Космонавт'"
  year="1958"
  factory="Гусевский хрустальный завод"
  rarity="rare"
  image="/path/to/image.jpg"
  link="/toys/cosmonaut-1958"
  available-count="3"
  min-price="5000"
  max-price="8500">
</toy-type-card>

<!-- Страница типа -->
<toy-type-single id="789"></toy-type-single>
```

---

### Toy Instance (Экземпляр игрушки)
**Описание:** Конкретный экземпляр игрушки, выставленный на продажу. Относится к типу.

**Компоненты:**
- `toy-instance-card` - статичная карточка (отображается под страницей типа)
- `toy-instance-modal` - модальное окно с детальной информацией

**Особенности:**
- Экземпляры не имеют отдельных страниц по URL
- Детальный просмотр только через модальное окно
- Карточка кликабельна и открывает модалку

**Использование:**
```html
<!-- Карточка экземпляра -->
<toy-instance-card
  id="101"
  condition="excellent"
  price="7500"
  image="/path/to/instance.jpg"
  available="true">
</toy-instance-card>

<!-- Модалка (открывается программно) -->
<toy-instance-modal instance-id="101"></toy-instance-modal>
```

## Интеграция в WordPress

### Подключение компонентов через PHP

Компоненты подключаются условно в зависимости от типа страницы:

```php
// В functions.php или template
add_filter('elkaretro_required_components', function($list) {
  if (is_page()) {
    $list[] = 'wp-page';
  } elseif (is_single() && get_post_type() === 'post') {
    $list[] = 'post-single';
  } elseif (is_single() && get_post_type() === 'toy_type') {
    $list[] = 'toy-type-single';
  }
  return $list;
});
```

### Реестр компонентов

В `components/components.js`:

```js
const registry = {
  'wp-page': () => import('./pages/page/page.js'),
  'post-card': () => import('./posts/post-card/post-card.js'),
  'post-single': () => import('./posts/post-single/post-single.js'),
  'toy-type-card': () => import('./toy-type/toy-type-card/toy-type-card.js'),
  'toy-type-single': () => import('./toy-type/toy-type-single/toy-type-single.js'),
  'toy-instance-card': () => import('./toy-instance/toy-instance-card/toy-instance-card.js'),
  'toy-instance-modal': () => import('./toy-instance/toy-instance-modal/toy-instance-modal.js'),
};
```

## Поисковая выдача и фильтрация

**Требуется продумать:**
- Приоритет показа типов над экземплярами
- Отображение фото доступных экземпляров внутри карточек типов
- Показ общего количества доступных экземпляров
- Отображение диапазона цен (min-max)

**Фильтры (используются в каталоге и поиске):**
- **Аутентичность** (`authenticity`) - отдельный фильтр с вариантами:
  - Оригинал, Ремонтированная, Реновация краски, Реставрация краски, Современная реплика
- **Состояние** (`condition`) - состояние сохранности экземпляра:
  - Люкс, Хорошее, Так себе, Плохое
- **Комплектация лота** (`lot_configurations`) - способ продажи игрушки из набора:
  - Поштучно, Не полный набор, Полный набор
- Собственность (`property`)
- **Состояние трубочки** (`tube_condition`) - качество сохранности трубочки в процентах:
  - 100%, Более 75%, 50-75%, 25-50%, Менее 25%
- **Тип окраса** (`paint_type`) - тип краски (один и тот же тип игрушки может быть окрашен разной краской):
  - Глянец, Матовый, Не определён (в будущем)
- **Характер окраса** (`color_type`) - степень непрозрачности покрытия краски (один и тот же тип может иметь разную степень):
  - Прозрачный, Полупрозрачный, Сплошной
- **Цвет фона** (`back_color`) - цвет исполнения игрушки (один и тот же тип может быть в разных цветах):
  - Белый, Голубой, Жёлтый, Зелёный, Золотистый, Красный, Малиновый, Оранжевый, Прозрачный, Розовый, Серебристый, Синий, Фиолетовый, Чёрный, Другой
- **Год производства** (`year_of_production`) - десятилетия производства (один тип может производиться в несколько десятилетий, multi pick):
  - До 1930-х, 1930-е, 1940-е, 1950-е, 1960-е, 1970-е, 1980-е, 1990-е, 21 век
- **Производитель** (`manufacturer`) - завод/предприятие производства (multi pick):
  - Завидово, Иней-1, Иней-2, Иней-3, Иней-4, Иней-5, Клин, Конаково, Культигрушка, Ленигрушка, Малая Вишера, Не установлен, НИИигрушки, ПО «Ёлочка», Уфа
  - Описания производителей показывать в tooltips (хинтах)
  - **TODO:** Создать отдельный компонент для страницы производителя с историей предприятия
- **Размер** (`size`) - размер игрушки:
  - Малютки, Крупная мелочь, Стандарт, Гигант
- **Материал** (`material`) - материал изготовления (95% игрушек - стекло):
  - Стекло (другие материалы будут добавлены в будущем)
- **Толщина стекла** (`glass_thickness`) - толщина стекла (только для стеклянных игрушек, для других - пусто):
  - Тонкое, Стандарт, Толстое
- **Тип крепления** (`mounting_type`) - способ крепления игрушки (в редких случаях может быть несколько, multi pick):
  - Подвес, Прищепка, Подставка, Накидка
- Встречаемость (`occurrence`)

**Возможные решения:**
- Расширить `toy-type-card` атрибутами `available-count`, `min-price`, `max-price`
- Загружать миниатюры экземпляров через API при рендере карточки типа
- Создать отдельный компонент для поисковой выдачи
- Компонент фильтров с использованием WP REST API параметров фильтрации

**TODO (Post-MVP):**
- Асинхронная загрузка миниатюр экземпляров в карточке типа
- Горизонтальный скроллер с миниатюрами экземпляров
- Подтягивание min/max цены и кнопка "Заказать" на карточке типа

---

### Category Components (Компоненты категорий)

**Компоненты:**
- `category-breadcrumbs` - автономный компонент хлебных крошек
- `category-catalog` - автономный компонент каталога с навигацией по категориям

**Особенности:**
- **Хлебные крошки:**
  - Если указана только дочерняя категория - автоматически загружают всех родителей через иерархию
  - Строят полный путь от корня до текущей категории
  - Каждая категория в пути кликабельна
  
- **Каталог категорий** (аналог Яндекс.Маркет):
  - **Левая часть (сайдбар):** дерево категорий с иконками
    - Раскрытие/скрытие дочерних категорий (chevron icons)
    - Выделение активной категории
    - Автоматическое раскрытие пути к выбранной категории
  - **Правая часть:** подкатегории выбранной категории
    - Группировка подкатегорий (если есть вложенность)
    - Карточки типов игрушек (`toy-type-card`) для категории
    - Отображение количества товаров в категории

**Использование:**
```html
<!-- Хлебные крошки -->
<category-breadcrumbs category-id="15"></category-breadcrumbs>

<!-- Каталог категорий -->
<category-catalog category-id="15"></category-catalog>
```

**Референс:** Яндекс.Маркет - левый сайдбар с деревом категорий, правая часть с подкатегориями

---

## Data Model

Полная спецификация data model для каждой сущности описана в отдельном файле:
📄 **`components/WP_DATA_MODEL.md`**

Ключевые моменты:
- Система индексации склада (категории-тип-экземпляр)
- Структура REST API ответов для всех сущностей
- Правила вычисления полных индексов
- Особенности полей (например, поле `_` в toy_instance)

---

## Следующие шаги

1. ✅ Структура файлов создана
2. ✅ Фиксация data model для каждой сущности (см. `WP_DATA_MODEL.md`)
3. ⏳ Реализация рендера компонентов
4. ⏳ Стилизация под текущую тему
5. ⏳ Интеграция с WP REST API
6. ⏳ Обработка поисковой выдачи


# Спецификация: Иерархический фильтр категорий (`category-tree-filter`)

## Контекст

Таксономия `category-of-toys` иерархическая (родитель-потомок). Нужен кастомный компонент для отображения дерева категорий с возможностью фильтрации каталога по выбранным категориям.

**Это не универсальный компонент UI Kit**, а специфичный для каталога компонент, который:
- Не является полем формы (не интегрируется в `ui-form-controller`)
- Имеет собственную логику выбора и синхронизации с URL
- Работает напрямую с `window.taxonomy_terms['category-of-toys']`

## Требования пользователя

### 1. Логика выбора категорий

**Действия пользователя:**
- ✅ Разворачивать каталог на весь экран (он большой, большое древо)
- ✅ Сворачивать его обратно
- ✅ Выбирать родительскую категорию → автоматически выбираются все дочерние (влияет на фильтрацию)
- ✅ Выбирать дочернюю категорию → выбирается только она (влияет на фильтрацию)
- ✅ Разворачивать категорию, если у неё есть дочерние (чистый UI)
- ✅ Сворачивать категорию, если у неё есть дочерние (чистый UI)

**Правила выбора:**
- При выборе родителя → автоматически выбираются все дочерние (рекурсивно)
- При выборе дочерней → выбирается только она
- При снятии родителя → снимаются все дочерние
- При снятии дочерней → проверка: если все дочерние сняты, снять родителя

### 2. Визуальное представление

**UI элементы:**
- ✅ Чекбоксы слева от названия категории
- ✅ Шевроны справа для раскрытия/сворачивания (chevron_right/chevron_down, переворачиваются в зависимости от состояния)
- ✅ Линии для отображения иерархии (отступы, визуальные линии)
- ✅ Поисковая строка сверху (поиск по названию категорий)
- ✅ Кнопка развернуть/свернуть фильтр на весь экран

**Раскрытие/сворачивание:**
- По умолчанию: всё свёрнуто, видим только категории верхнего порядка
- Сохранять состояние раскрытия в `localStorage` (НЕ в URL)
- Автоматически раскрывать путь к выбранным категориям

**Поиск:**
- Текстовый поиск по названиям категорий
- При поиске: показывать путь к найденным с раскрытием родителей
- Фильтровать видимые категории, но показывать контекст (родителей)

### 3. Состояние при сворачивании фильтра

**Поведение:**
- Если ничего не выбрано → показывать только верхние категории (корневые)
- Если что-то выбрано → показывать выбранные категории (с их родителями для контекста)

### 4. Интеграция с каталогом

**Синхронизация с URL:**
- Формат: `?category-of-toys=id1,id2,id3` (плоский список ID через запятую)
- Синхронизация с `catalog-store` через событие `elkaretro:catalog:updated`

**Отображение в чипсах:**
- Один общий чипс "Категории: X, Y, Z" (названия выбранных категорий)
- При клике на чипс → разворачивать фильтр и подсвечивать выбранные

**Разворот на весь экран:**
- Расширение сайдбара и прятание остальных фильтров
- Кнопка для разворота/сворачивания

### 5. Данные

**Источник данных:**
- `window.taxonomy_terms['category-of-toys']`
- Структура: `{ term_id: { id, name, slug, description, parent } }`
- Поле `parent` должно быть добавлено в PHP функцию `elkaretro_get_taxonomy_terms_for_js()`

**Загрузка:**
- Всё дерево загружается сразу (данные уже в JS)
- Ожидаемое количество: 100-500 категорий
- Виртуализация не требуется (всё сразу)

### 6. Производительность

**Ограничения:**
- 100-500 категорий
- Виртуализация не нужна (всё загружается сразу)
- Оптимизация рендеринга через условный рендеринг (показывать только видимые узлы)

## Backlog

См. `CATEGORY_FILTER_BACKLOG.md`

## Архитектурные принципы

Компонент следует архитектурным принципам проекта:
- Использует `BaseElement` как базовый класс
- State management через `stateSchema`
- Синхронизация с глобальным стором через события
- Разделение на JS, template и styles файлы
- Использование существующих UI Kit компонентов где возможно (иконки, кнопки)


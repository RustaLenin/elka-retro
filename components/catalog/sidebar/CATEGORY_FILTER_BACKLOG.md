# Backlog: Иерархический фильтр категорий

## Этап 1: Подготовка данных (PHP)

### 1.1. Добавить поле `parent` в `elkaretro_get_taxonomy_terms_for_js()`
**Файл:** `functions.php`
**Задача:** Добавить поле `parent` для иерархических таксономий
**Детали:**
- Проверять `is_taxonomy_hierarchical($taxonomy_slug)`
- Добавлять `'parent' => $term->parent` в массив термина
- Тестировать на `category-of-toys`

**Критерии готовности:**
- ✅ Поле `parent` присутствует в `window.taxonomy_terms['category-of-toys']`
- ✅ Для корневых категорий `parent === 0`
- ✅ Для дочерних категорий `parent === term_id` родителя

---

## Этап 2: Базовый компонент (Web Component)

### 2.1. Создать структуру файлов
**Файлы:**
- `components/catalog/sidebar/category-tree-filter.js`
- `components/catalog/sidebar/category-tree-filter-template.js`
- `components/catalog/sidebar/category-tree-filter-styles.css`

**Задачи:**
- ✅ Создать класс `CategoryTreeFilter extends BaseElement`
- ✅ Определить `stateSchema` с полями:
  - `selectedCategories: Set<id>` (внутреннее состояние)
  - `expandedNodes: Set<id>` (внутреннее состояние)
  - `searchQuery: string`
  - `isExpanded: boolean` (развёрнут ли на весь экран)
- ✅ Зарегистрировать custom element `category-tree-filter`

**Критерии готовности:**
- ✅ Компонент создаётся и рендерится
- ✅ State schema работает корректно

---

### 2.2. Построение дерева категорий
**Файл:** `category-tree-filter.js`
**Метод:** `_buildTree(flatTerms)`

**Задачи:**
- ✅ Преобразовать плоский объект `{ term_id: { id, name, slug, parent } }` в иерархическую структуру
- ✅ Создать структуру `{ id, name, slug, parent, children: [] }`
- ✅ Рекурсивно построить дерево, начиная с корневых (parent === 0)
- ✅ Сохранить ссылки на родительские узлы для навигации

**Критерии готовности:**
- ✅ Дерево строится корректно
- ✅ Все категории включены в дерево
- ✅ Связи родитель-потомок работают

---

### 2.3. Базовый рендеринг дерева
**Файл:** `category-tree-filter-template.js`
**Метод:** `renderCategoryTree(categories, level = 0)`

**Задачи:**
- ✅ Рекурсивный рендеринг узлов дерева
- ✅ Отступы для иерархии (level * indent)
- ✅ Линии для визуального отображения иерархии
- ✅ Чекбокс слева от названия
- ✅ Шеврон справа (если есть дочерние)
- ✅ Обработка состояния раскрытия/сворачивания

**Критерии готовности:**
- ✅ Дерево отображается с правильной иерархией
- ✅ Визуальные элементы (чекбоксы, шевроны) присутствуют
- ✅ Отступы и линии корректны

---

## Этап 3: Логика выбора

### 3.1. Обработка выбора категорий
**Файл:** `category-tree-filter.js`
**Методы:** `_onCategorySelect(categoryId)`, `_selectCategory(categoryId)`, `_deselectCategory(categoryId)`

**Задачи:**
- ✅ При выборе родителя → рекурсивно выбрать все дочерние
- ✅ При выборе дочерней → выбрать только её
- ✅ При снятии родителя → снять все дочерние
- ✅ При снятии дочерней → проверить, нужно ли снять родителя
- ✅ Обновление визуального состояния чекбоксов

**Критерии готовности:**
- ✅ Логика выбора работает корректно
- ✅ Визуальное состояние синхронизировано с логическим

---

### 3.2. Синхронизация с каталогом
**Файл:** `category-tree-filter.js`
**Методы:** `_syncWithStore()`, `_onCatalogUpdate(event)`

**Задачи:**
- ✅ Слушать событие `elkaretro:catalog:updated`
- ✅ Обновлять `selectedCategories` из стора
- ✅ При изменении выбора → обновлять стор через `catalogStore.updateState()`
- ✅ Формат URL: `?category-of-toys=id1,id2,id3`

**Критерии готовности:**
- ✅ Синхронизация с URL работает
- ✅ Изменения в фильтре обновляют каталог
- ✅ Изменения в URL обновляют фильтр

---

## Этап 4: Раскрытие/сворачивание

### 4.1. Управление состоянием раскрытия
**Файл:** `category-tree-filter.js`
**Методы:** `_toggleNode(categoryId)`, `_expandNode(categoryId)`, `_collapseNode(categoryId)`

**Задачи:**
- ✅ Переключение состояния раскрытия узла
- ✅ Сохранение состояния в `localStorage` (ключ: `elkaretro_category_filter_expanded`)
- ✅ Загрузка состояния из `localStorage` при инициализации
- ✅ Обновление визуального состояния шевронов

**Критерии готовности:**
- ✅ Раскрытие/сворачивание работает
- ✅ Состояние сохраняется между сессиями

---

### 4.2. Автоматическое раскрытие пути
**Файл:** `category-tree-filter.js`
**Метод:** `_expandPathToCategory(categoryId)`

**Задачи:**
- ✅ Найти путь от корня до выбранной категории
- ✅ Раскрыть все узлы на пути
- ✅ Вызывать при выборе категории
- ✅ Вызывать при загрузке состояния из URL

**Критерии готовности:**
- ✅ Путь к выбранным категориям автоматически раскрывается
- ✅ Работает при загрузке из URL

---

## Этап 5: Поиск

### 5.1. Поисковая строка
**Файл:** `category-tree-filter-template.js`
**Задача:** Добавить поле поиска сверху дерева

**Детали:**
- ✅ Использовать `ui-input-text` или нативный input
- ✅ Debounce для оптимизации
- ✅ Очистка поиска

**Критерии готовности:**
- ✅ Поисковая строка отображается
- ✅ Ввод работает

---

### 5.2. Фильтрация и отображение результатов поиска
**Файл:** `category-tree-filter.js`
**Методы:** `_filterTree(searchQuery)`, `_highlightSearchResults()`

**Задачи:**
- ✅ Фильтровать категории по названию (case-insensitive)
- ✅ Показывать путь к найденным категориям (раскрывать родителей)
- ✅ Подсвечивать найденные категории
- ✅ Показывать только релевантные ветки дерева

**Критерии готовности:**
- ✅ Поиск работает корректно
- ✅ Путь к найденным категориям раскрывается
- ✅ Результаты подсвечиваются

---

## Этап 6: Разворот на весь экран

### 6.1. Кнопка разворота
**Файл:** `category-tree-filter-template.js`
**Задача:** Добавить кнопку разворота/сворачивания

**Детали:**
- ✅ Иконка expand/collapse
- ✅ Обработчик клика

**Критерии готовности:**
- ✅ Кнопка отображается
- ✅ Клик работает

---

### 6.2. Логика разворота
**Файл:** `category-tree-filter.js`, `sidebar-styles.css`
**Метод:** `_toggleExpanded()`

**Задачи:**
- ✅ При развороте → расширить сайдбар, скрыть остальные фильтры
- ✅ При сворачивании → вернуть обычное состояние
- ✅ CSS классы для управления состоянием
- ✅ Плавная анимация перехода

**Критерии готовности:**
- ✅ Разворот работает
- ✅ Остальные фильтры скрываются/показываются
- ✅ Анимация плавная

---

## Этап 7: Состояние при сворачивании

### 7.1. Условное отображение
**Файл:** `category-tree-filter.js`
**Метод:** `_getVisibleCategories()`

**Задачи:**
- ✅ Если ничего не выбрано → показывать только корневые категории
- ✅ Если что-то выбрано → показывать выбранные + их родителей
- ✅ Обновлять видимость при изменении выбора

**Критерии готовности:**
- ✅ Условное отображение работает
- ✅ Переключение между состояниями плавное

---

## Этап 8: Интеграция в сайдбар

### 8.1. Обновить `shared-category-filter.js`
**Файл:** `components/catalog/sidebar/shared-category-filter.js`

**Задачи:**
- ✅ Инициализировать `category-tree-filter`
- ✅ Передать данные из `window.taxonomy_terms['category-of-toys']`
- ✅ Подключить обработчики событий
- ✅ Интегрировать в `catalog-sidebar.js`

**Критерии готовности:**
- ✅ Фильтр отображается в сайдбаре
- ✅ События обрабатываются корректно

---

### 8.2. Интеграция в `catalog-sidebar.js`
**Файл:** `components/catalog/sidebar/catalog-sidebar.js`

**Задачи:**
- ✅ Добавить секцию для категорий в шаблон сайдбара
- ✅ Инициализировать `shared-category-filter` при загрузке
- ✅ Обработать события от фильтра категорий
- ✅ Синхронизировать с остальными фильтрами

**Критерии готовности:**
- ✅ Фильтр категорий работает в сайдбаре
- ✅ Синхронизация с другими фильтрами работает

---

## Этап 9: Отображение в чипсах

### 9.1. Обновить `filters-summary.js`
**Файл:** `components/catalog/toolbar/filters-summary.js`

**Задачи:**
- ✅ Обработать `category-of-toys` в списке фильтров
- ✅ Создать один чипс "Категории: X, Y, Z" вместо множества
- ✅ При клике на чипс → разворачивать фильтр и подсвечивать выбранные

**Критерии готовности:**
- ✅ Чипс отображается корректно
- ✅ Клик работает

---

## Этап 10: Стилизация

### 10.1. Базовые стили
**Файл:** `category-tree-filter-styles.css`

**Задачи:**
- ✅ Стили для дерева категорий
- ✅ Стили для чекбоксов и шевронов
- ✅ Стили для линий иерархии
- ✅ Стили для поисковой строки
- ✅ Стили для состояния разворота

**Критерии готовности:**
- ✅ Визуально соответствует требованиям
- ✅ Адаптивность для мобильных устройств

---

### 10.2. Анимации и переходы
**Файл:** `category-tree-filter-styles.css`

**Задачи:**
- ✅ Плавное раскрытие/сворачивание узлов
- ✅ Плавный разворот на весь экран
- ✅ Подсветка при наведении
- ✅ Подсветка выбранных категорий

**Критерии готовности:**
- ✅ Анимации плавные
- ✅ UX приятный

---

## Этап 11: Тестирование и оптимизация

### 11.1. Функциональное тестирование
**Задачи:**
- ✅ Тестирование логики выбора
- ✅ Тестирование синхронизации с URL
- ✅ Тестирование поиска
- ✅ Тестирование разворота
- ✅ Тестирование на разных размерах дерева (100-500 категорий)

**Критерии готовности:**
- ✅ Все функции работают корректно
- ✅ Нет багов

---

### 11.2. Производительность
**Задачи:**
- ✅ Оптимизация рендеринга (условный рендеринг)
- ✅ Оптимизация поиска
- ✅ Проверка производительности на больших деревьях

**Критерии готовности:**
- ✅ Производительность приемлемая
- ✅ Нет лагов при работе с деревом

---

## Backlog (будущие улучшения)

### Показ счётчиков товаров
- Добавить поле `count` в структуру терминов (если доступно)
- Отображать количество товаров рядом с категорией
- Обновлять счётчики при фильтрации

### Виртуализация для очень больших деревьев
- Если дерево станет больше 500 категорий, добавить виртуализацию
- Использовать библиотеку типа `react-window` или аналог для vanilla JS

### Клавиатурная навигация
- Навигация по дереву с клавиатуры (стрелки, Enter, Space)
- Доступность (a11y) для скринридеров


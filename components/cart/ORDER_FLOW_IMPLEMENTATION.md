# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π Flow –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞

–î–æ–∫—É–º–µ–Ω—Ç —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –ø–ª–∞–Ω–æ–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–Ω—è—Ç—ã—Ö —Ä–µ—à–µ–Ω–∏–π.

## ‚úÖ –ü—Ä–∏–Ω—è—Ç—ã–µ —Ä–µ—à–µ–Ω–∏—è

1. **–®–∞–≥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:**
   - –ö–Ω–æ–ø–∫–∞ "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è" (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ)
   - –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏" —Å –ø–æ–¥–ø–∏—Å—å—é "—É–∫–∞–∑–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞"

2. **–ü–æ–∫–∞–∑ —à–∞–≥–æ–≤:**
   - –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–µ —à–∞–≥–∏, –¥–∞–∂–µ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å
   - –ü—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏/–æ—Ç–∫—Ä—ã—Ç–∏–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö - –≤–æ–ø—Ä–æ—Å: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è?" –∏–ª–∏ "–ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å –Ω—É–ª—è"

3. **–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:**
   - –†–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –¥–≤–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞:
     - `POST /wp-json/elkaretro/v1/orders/guest` - –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
     - `POST /wp-json/elkaretro/v1/orders` - –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
   - –î–≤–∞ —á–∏—Å—Ç—ã—Ö –º–µ—Ç–æ–¥–∞ –≤ `Order_Service`:
     - `create_guest_order()` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è + —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
     - `create_authenticated_order()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è + —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞

---

## üìã –ó–∞–¥–∞—á–∏ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –ò–∑–º–µ–Ω–µ–Ω–∏–µ step-auth

**–§–∞–π–ª—ã:**
- `components/cart/order-wizard/steps/step-auth.js`
- `components/cart/order-wizard/steps/step-auth-template.js`
- `components/cart/order-wizard/steps/step-auth-styles.css`

**–ó–∞–¥–∞—á–∏:**
1. –ò–∑–º–µ–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω:
   - –£–±—Ä–∞—Ç—å –≤—ã–±–æ—Ä "–í–æ–π—Ç–∏" / "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è"
   - –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è" (primary)
   - –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏" (secondary)
   - –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å—å –ø–æ–¥ –≤—Ç–æ—Ä–æ–π –∫–Ω–æ–ø–∫–æ–π: "—É–∫–∞–∑–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞"

2. –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏–∫—É:
   - `handleLogin()` - –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
   - `handleContinueWithoutAuth()` - –ø–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É 2 (–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)

3. –°—Ç–∏–ª–∏:
   - –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –∏ –ø–æ–¥–ø–∏—Å–∏
   - –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å "–∏–ª–∏" –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏

---

### –≠—Ç–∞–ø 2: –ú–µ—Ç–æ–¥—ã OrderWizard

**–§–∞–π–ª:** `components/cart/order-wizard/order-wizard.js`

**–ó–∞–¥–∞—á–∏:**

1. **`refreshAuthState()`** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
```javascript
async refreshAuthState() {
  try {
    const response = await fetch('/wp-json/wp/v2/users/me', {
      credentials: 'same-origin',
      headers: {
        'X-WP-Nonce': window.wpApiSettings?.nonce || '',
      },
    });
    
    if (response.ok) {
      const user = await response.json();
      // –ó–∞–≥—Ä—É–∂–∞–µ–º user meta —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
      const metaResponse = await fetch(`/wp-json/elkaretro/v1/user/profile`, {
        credentials: 'same-origin',
        headers: {
          'X-WP-Nonce': window.wpApiSettings?.nonce || '',
        },
      });
      
      if (metaResponse.ok) {
        const profile = await metaResponse.json();
        user.meta = profile.meta || {};
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º window.app.auth
      if (window.app) {
        window.app.auth = {
          authenticated: true,
          user: user,
        };
      }
      return user;
    }
  } catch (error) {
    console.error('[OrderWizard] Failed to refresh auth state:', error);
  }
  return null;
}
```

2. **`askUseProfileData()`** - –≤–æ–ø—Ä–æ—Å –æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è:
```javascript
async askUseProfileData() {
  return new Promise((resolve) => {
    // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å UI –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞
    // –í–∞—Ä–∏–∞–Ω—Ç—ã:
    // 1. –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–≤—É–º—è –∫–Ω–æ–ø–∫–∞–º–∏
    // 2. –ò–Ω–ª–∞–π–Ω-–≤–æ–ø—Ä–æ—Å –≤ —à–∞–≥–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    // 3. –ß–µ–∫–±–æ–∫—Å –≤ —à–∞–≥–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    
    // –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    if (window.app?.modal) {
      const modalId = 'order-wizard-use-profile';
      window.app.modal.open(modalId);
      // –°–ª—É—à–∞–µ–º –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      // resolve(true) –∏–ª–∏ resolve(false)
    } else {
      // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
      resolve(true);
    }
  });
}
```

3. **`determineNextStep(useProfileData)`** - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞:
```javascript
async determineNextStep(useProfileData = false) {
  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª "–ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å –Ω—É–ª—è" - –Ω–∞—á–∏–Ω–∞–µ–º —Å —à–∞–≥–∞ 2
  if (!useProfileData) {
    return 2; // –®–∞–≥ –ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  if (!window.app?.auth?.user || !window.app.auth.authenticated) {
    return 1; // –®–∞–≥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  }
  
  // –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ–º —Å —à–∞–≥–∞ 2 (–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ) –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏/–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
  // –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
  return 2;
}
```

4. **`getLastOrderData()`** - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞:
```javascript
async getLastOrderData() {
  try {
    const response = await fetch('/wp-json/elkaretro/v1/orders?per_page=1', {
      credentials: 'same-origin',
      headers: {
        'X-WP-Nonce': window.wpApiSettings?.nonce || '',
      },
    });
    
    if (response.ok) {
      const orders = await response.json();
      if (orders && orders.length > 0) {
        return orders[0];
      }
    }
  } catch (error) {
    console.error('[OrderWizard] Failed to get last order:', error);
  }
  return null;
}
```

5. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è `elkaretro:auth:login`:**
```javascript
connectedCallback() {
  super.connectedCallback();
  
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
  
  // –°–ª—É—à–∞–µ–º —É—Å–ø–µ—à–Ω—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
  this._handleAuthSuccess = async () => {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    const user = await this.refreshAuthState();
    if (user) {
      this.setState({ isAuthorized: true });
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –∏–ª–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Å –Ω—É–ª—è?
      const useProfileData = await this.askUseProfileData();
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥
      const nextStep = await this.determineNextStep(useProfileData);
      this.goToStep(nextStep);
    }
  };
  
  window.addEventListener('elkaretro:auth:login', this._handleAuthSuccess);
}

disconnectedCallback() {
  if (this._handleAuthSuccess) {
    window.removeEventListener('elkaretro:auth:login', this._handleAuthSuccess);
  }
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
}
```

---

### –≠—Ç–∞–ø 3: –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è

**–§–∞–π–ª—ã:**
- `components/cart/order-wizard/steps/step-personal.js`
- `components/cart/order-wizard/steps/step-logistics.js`
- `components/cart/order-wizard/steps/step-payment.js`

**–ó–∞–¥–∞—á–∏:**

1. **step-personal.js:**
   - –ï—Å–ª–∏ `useProfileData === true`, –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è—Ç—å:
     - `phone` –∏–∑ `user.meta.phone` –∏–ª–∏ `user.meta.phone_number`
     - `first_name` –∏–∑ `user.meta.first_name` –∏–ª–∏ `user.first_name`
     - `last_name` –∏–∑ `user.meta.last_name` –∏–ª–∏ `user.last_name`

2. **step-logistics.js:**
   - –ï—Å–ª–∏ `useProfileData === true`, –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è—Ç—å:
     - –ê–¥—Ä–µ—Å –∏–∑ `user.meta.delivery_address` (–µ—Å–ª–∏ –µ—Å—Ç—å)
     - –ò–ª–∏ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞ —á–µ—Ä–µ–∑ `getLastOrderData()`
     - `delivery_method` –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞

3. **step-payment.js:**
   - –ï—Å–ª–∏ `useProfileData === true`, –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è—Ç—å:
     - `payment_method` –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞

---

### –≠—Ç–∞–ø 4: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤

**–§–∞–π–ª—ã:**
- `core/orders/order-rest-controller.php`
- `core/orders/order-service.php`

**–ó–∞–¥–∞—á–∏:**

1. **order-rest-controller.php:**
   - –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π route: `POST /wp-json/elkaretro/v1/orders/guest`
   - –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π route: `POST /wp-json/elkaretro/v1/orders` (—Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)

2. **order-service.php:**
   - –°–æ–∑–¥–∞—Ç—å –º–µ—Ç–æ–¥ `create_guest_order($order_data)`:
     - –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
     - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ `register_user_for_order()`
     - –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –°–æ–∑–¥–∞—Ç—å –º–µ—Ç–æ–¥ `create_authenticated_order($order_data)`:
     - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —á–µ—Ä–µ–∑ `update_missing_user_profile_fields()`
     - –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ `create_order()`:
     - –£–¥–∞–ª–∏—Ç—å –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –æ–±–µ—Ä—Ç–∫—É, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç –Ω—É–∂–Ω—ã–π –º–µ—Ç–æ–¥

---

### –≠—Ç–∞–ø 5: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ step-confirmation

**–§–∞–π–ª:** `components/cart/order-wizard/steps/step-confirmation.js`

**–ó–∞–¥–∞—á–∏:**

1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫–∞–∫–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
```javascript
prepareOrderData() {
  const isAuthorized = window.app?.auth?.authenticated;
  const endpoint = isAuthorized 
    ? '/wp-json/elkaretro/v1/orders'
    : '/wp-json/elkaretro/v1/orders/guest';
  
  return {
    endpoint,
    data: {
      cart: {
        items: this.state.orderData.cart.items.map(item => ({
          id: item.id,
          type: item.type,
        })),
      },
      personal: this.state.orderData.personal,
      logistics: this.state.orderData.logistics,
      payment: this.state.orderData.payment,
    }
  };
}

async createOrder() {
  this.setState({ isSubmitting: true, error: '' });
  
  try {
    const { endpoint, data } = this.prepareOrderData();
    
    const response = await fetch(endpoint, {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
        'X-WP-Nonce': window.wpApiSettings?.nonce || '',
      },
      body: JSON.stringify(data),
    });
    
    // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ ...
  }
}
```

---

### –≠—Ç–∞–ø 6: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ user meta

**–§–∞–π–ª—ã:**
- `core/orders/order-service.php`
- `core/user/user-service.php` (–µ—Å–ª–∏ –µ—Å—Ç—å)

**–ó–∞–¥–∞—á–∏:**

1. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º:
   - –°–æ—Ö—Ä–∞–Ω—è—Ç—å –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ user meta:
     - `delivery_country`
     - `delivery_region`
     - `delivery_city`
     - `delivery_street`
     - `delivery_postal_code`
     - `delivery_address` (—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å)

2. –ü—Ä–∏ –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ñ–æ—Ä–º—ã –ª–æ–≥–∏—Å—Ç–∏–∫–∏:
   - –ó–∞–≥—Ä—É–∂–∞—Ç—å –∞–¥—Ä–µ—Å –∏–∑ user meta
   - –ï—Å–ª–∏ –Ω–µ—Ç –≤ user meta - –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞

---

## üîÑ –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### Sprint 1: Frontend –∏–∑–º–µ–Ω–µ–Ω–∏—è
1. ‚úÖ –ò–∑–º–µ–Ω–∏—Ç—å step-auth (–∫–Ω–æ–ø–∫–∏ –∏ –ª–æ–≥–∏–∫–∞)
2. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥—ã OrderWizard (refreshAuthState, determineNextStep, askUseProfileData, getLastOrderData)
3. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ elkaretro:auth:login
4. ‚úÖ –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —à–∞–≥–∞—Ö

### Sprint 2: Backend –∏–∑–º–µ–Ω–µ–Ω–∏—è
1. ‚úÖ –†–∞–∑–¥–µ–ª–∏—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –≤ order-rest-controller.php
2. ‚úÖ –°–æ–∑–¥–∞—Ç—å create_guest_order() –≤ order-service.php
3. ‚úÖ –°–æ–∑–¥–∞—Ç—å create_authenticated_order() –≤ order-service.php
4. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å step-confirmation –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞

### Sprint 3: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è
1. ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ user meta
2. ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∞–¥—Ä–µ—Å–∞ –∏–∑ user meta –ø—Ä–∏ –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏
3. ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ flow

---

## üß™ –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
1. –ù–∞–∂–∏–º–∞–µ—Ç "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑"
2. –í–∏–¥–∏—Ç —à–∞–≥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å –¥–≤—É–º—è –∫–Ω–æ–ø–∫–∞–º–∏
3. –ù–∞–∂–∏–º–∞–µ—Ç "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"
4. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —à–∞–≥—É 2 (–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ) - —Ñ–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
5. –ó–∞–ø–æ–ª–Ω—è–µ—Ç –≤—Å–µ —à–∞–≥–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
6. –ù–∞ —à–∞–≥–µ 5 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–∫–∞–∑ –Ω–∞ `/wp-json/elkaretro/v1/orders/guest`
7. –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–µ—Ç—Å—è, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–Ω–æ–≤—ã–π)
1. –ù–∞–∂–∏–º–∞–µ—Ç "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑"
2. –í–∏–¥–∏—Ç —à–∞–≥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
3. –í–∏–¥–∏—Ç –≤–æ–ø—Ä–æ—Å: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è?"
4. –í—ã–±–∏—Ä–∞–µ—Ç "–ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å –Ω—É–ª—è"
5. –ü—Ä–æ—Ö–æ–¥–∏—Ç –≤—Å–µ —à–∞–≥–∏ —Å –ø—É—Å—Ç—ã–º–∏ —Ñ–æ—Ä–º–∞–º–∏
6. –ù–∞ —à–∞–≥–µ 5 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–∫–∞–∑ –Ω–∞ `/wp-json/elkaretro/v1/orders`

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (—Å –¥–∞–Ω–Ω—ã–º–∏)
1. –ù–∞–∂–∏–º–∞–µ—Ç "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑"
2. –í–∏–¥–∏—Ç —à–∞–≥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
3. –í–∏–¥–∏—Ç –≤–æ–ø—Ä–æ—Å: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è?"
4. –í—ã–±–∏—Ä–∞–µ—Ç "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è"
5. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —à–∞–≥—É 2 - —Ñ–æ—Ä–º–∞ –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∞ (—Ç–µ–ª–µ—Ñ–æ–Ω, –∏–º—è, —Ñ–∞–º–∏–ª–∏—è)
6. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —à–∞–≥—É 3 - –∞–¥—Ä–µ—Å –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è/–ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞
7. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —à–∞–≥—É 4 - —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞
8. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —à–∞–≥—É 5 - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
9. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–∫–∞–∑ –Ω–∞ `/wp-json/elkaretro/v1/orders`

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
1. –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑"
2. –ù–∞ —à–∞–≥–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞–∂–∏–º–∞–µ—Ç "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è"
3. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –∏ –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è
5. –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
6. –ü–æ—è–≤–ª—è–µ—Ç—Å—è –≤–æ–ø—Ä–æ—Å: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è?"
7. –î–∞–ª—å—à–µ –∫–∞–∫ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏ 2 –∏–ª–∏ 3

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **UI –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞ "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è?":**
   - –ú–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–∞–∫ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
   - –ò–ª–∏ –∫–∞–∫ –∏–Ω–ª–∞–π–Ω-–≤–æ–ø—Ä–æ—Å –≤ —à–∞–≥–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
   - –ò–ª–∏ –∫–∞–∫ —á–µ–∫–±–æ–∫—Å –≤ —à–∞–≥–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

2. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ window.app.auth:**
   - –ü–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –Ω–æ –∏ user meta
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `/wp-json/elkaretro/v1/user/profile` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

3. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö:**
   - –ö–∞–∂–¥—ã–π —à–∞–≥ –¥–æ–ª–∂–µ–Ω –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `UIFormController.validate()`
   - –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–æ–ª–µ–π

4. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:**
   - –ü—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ LocalStorage
   - –£—á–∏—Ç—ã–≤–∞—Ç—å –≤—ã–±–æ—Ä "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è" –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏

---

**–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω:** 2024  
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏


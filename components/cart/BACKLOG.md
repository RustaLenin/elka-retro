# Беклог: Корзина и заказы

Список задач для реализации функциональности корзины и заказов.

## MVP (Минимально жизнеспособный продукт)

### Фаза 1: Базовая корзина

#### 1.1. Cart Store (`cart-store.js`)
- [ ] Создать `cart-store.js` для управления состоянием корзины
- [ ] Реализовать методы: `addItem()`, `removeItem()`, `getCart()`, `clearCart()`
- [ ] Реализовать объединенную корзину для `toy_instance` и `ny_accessory`
- [ ] Реализовать сохранение в LocalStorage для неавторизованных (ключ: `elkaretro_cart`)
- [ ] Реализовать синхронизацию с сервером для авторизованных (User Meta: `elkaretro_cart`)
- [ ] Реализовать приоритет User Meta над LocalStorage при конфликте
- [ ] Добавить события для обновления корзины
- [ ] **Примечание:** Резервирование не в MVP, будет добавлено в будущем

#### 1.2. Cart Service (`cart-service.js`)
- [ ] Создать `cart-service.js` с бизнес-логикой
- [ ] Реализовать расчет итоговой стоимости
- [ ] Реализовать синхронизацию с сервером (приоритет User Meta)
- [ ] Реализовать валидацию товаров (проверка доступности)
- [ ] **Примечание:** Резервирование не в MVP

#### 1.3. Cart Item Component (`cart-item/`)
- [ ] Создать компонент `cart-item.js`
- [ ] Реализовать отображение информации о товаре
- [ ] Реализовать удаление товара
- [ ] Добавить стили и шаблон

#### 1.4. Cart Page Component (`cart-page/`)
- [ ] Создать компонент `cart-page.js`
- [ ] Реализовать отображение списка товаров
- [ ] Реализовать интеграцию с `cart-store`
- [ ] Реализовать переход к оформлению заказа
- [ ] Добавить стили и шаблон

#### 1.5. Cart Summary Component (`cart-summary/`)
- [ ] Создать компонент `cart-summary.js`
- [ ] Реализовать расчет итоговой стоимости
- [ ] Реализовать отображение скидок и сборов
- [ ] Добавить стили и шаблон

### Фаза 2: Правила комиссионной торговли

#### 2.1. Commission Rules (`commission-rules.js`)
- [ ] Создать `commission-rules.js`
- [ ] Реализовать расчет сбора на комплектацию (350 руб. при < 3500 руб.)
- [ ] Реализовать расчет оптовых скидок (10% при покупке на 5000 руб., каждая < 2000 руб.)
- [ ] **Примечание:** Резервирование и VIP статус не в MVP, будут добавлены в будущем

#### 2.2. Интеграция правил в корзину
- [ ] Интегрировать `commission-rules.js` в `cart-service.js`
- [ ] Добавить отображение сборов и скидок в `cart-summary`
- [ ] **Примечание:** Предупреждения об истечении резервирования не в MVP

### Фаза 3: Пошаговый Wizard оформления

#### 3.1. Order Wizard Component (`order-wizard/`)
- [ ] Создать компонент `order-wizard.js`
- [ ] Реализовать пошаговую навигацию
- [ ] Реализовать сохранение прогресса в LocalStorage
- [ ] Реализовать валидацию на каждом шаге
- [ ] Добавить стили и шаблон

#### 3.2. Шаг проверки заказа (`steps/step-review.js`)
- [ ] Создать компонент шага проверки
- [ ] Реализовать отображение списка товаров
- [ ] Реализовать отображение итоговой стоимости
- [ ] Реализовать возможность редактирования корзины

#### 3.3. Шаг авторизации/регистрации (`steps/step-auth.js`)
- [ ] Создать компонент шага авторизации
- [ ] Реализовать проверку авторизации при запуске Wizard
- [ ] Реализовать ветвление: ввод новых персональных данных (регистрация) или авторизация
- [ ] Интегрировать с модулем `user-profile`
- [ ] Реализовать создание аккаунта при оформлении (для неавторизованных)
- [ ] Реализовать авторизацию существующего пользователя
- [ ] **Примечание:** Гостевого оформления нет, всегда требуется регистрация или авторизация

#### 3.4. Шаг доставки (`steps/step-delivery.js`)
- [ ] Создать компонент шага доставки
- [ ] Реализовать выбор способа доставки (перечисление типов, без интеграций)
- [ ] Реализовать ввод/редактирование адреса доставки (1 адрес на аккаунт)
- [ ] Реализовать подтягивание адреса из профиля при авторизации
- [ ] Использовать `ui-form-controller` для формы

#### 3.5. Шаг оплаты (`steps/step-payment.js`)
- [ ] Создать компонент шага оплаты
- [ ] Реализовать выбор способа оплаты (без интеграций с платежными системами)
- [ ] Реализовать отображение реквизитов для оплаты
- [ ] Использовать `ui-form-controller` для формы
- [ ] **Примечание:** Онлайн оплата не в MVP

#### 3.6. Шаг подтверждения (`steps/step-confirmation.js`)
- [ ] Создать компонент шага подтверждения
- [ ] Реализовать отображение итоговой информации
- [ ] Реализовать создание заказа через REST API
- [ ] Реализовать отображение номера заказа

### Фаза 4: Backend интеграция

#### 4.1. REST API для корзины (`core/cart/`)
- [ ] Создать `cart-rest-controller.php`
- [ ] Реализовать endpoint `GET /wp-json/elkaretro/v1/cart` (только для авторизованных)
- [ ] Реализовать endpoint `PUT /wp-json/elkaretro/v1/cart/sync` (синхронизация при авторизации)
- [ ] Реализовать проверку прав доступа
- [ ] Реализовать валидацию данных
- [ ] **Примечание:** В MVP для неавторизованных корзина только в LocalStorage, без backend операций

#### 4.2. REST API для заказов (`core/orders/`)
- [ ] Создать `order-rest-controller.php`
- [ ] Реализовать endpoint `POST /wp-json/elkaretro/v1/orders` (принимает данные пользователя + корзину для неавторизованных, или только данные заказа для авторизованных)
- [ ] Реализовать endpoint `GET /wp-json/elkaretro/v1/orders/{orderId}`
- [ ] Реализовать endpoint `GET /wp-json/elkaretro/v1/orders` (история заказов пользователя)
- [ ] Реализовать endpoint `PUT /wp-json/elkaretro/v1/orders/{orderId}/status` (только администратор)
- [ ] Реализовать endpoint `PUT /wp-json/elkaretro/v1/orders/{orderId}` (редактирование адреса доставки, только если заказ не отправлен)
- [ ] Реализовать проверку прав доступа
- [ ] Реализовать валидацию данных

#### 4.3. Order Service (`core/orders/order-service.php`)
- [ ] Создать `order-service.php`
- [ ] Реализовать создание заказа через PODS
- [ ] Реализовать регистрацию пользователя перед созданием заказа (для неавторизованных)
- [ ] Реализовать отправку универсального письма (администраторам и клиенту) при создании заказа
- [ ] Реализовать отправку письма о закрытии заказа с просьбой оставить обратную связь
- [ ] **Примечание:** Резервирование не в MVP

#### 4.4. Сущность Заказ (PODS)
- [ ] Создать Custom Post Type `elkaretro_order` через PODS (⚠️ имя `order` зарезервировано)
- [ ] Настроить поля заказа (см. README.md)
- [ ] Настроить кастомные статусы заказа: `awaiting_payment`, `collecting`, `shipped`, `closed`, `clarification`
- [ ] Настроить связи с пользователем и товарами
- [ ] Настроить REST API для заказа

#### 4.5. Email уведомления
- [ ] Создать универсальный шаблон письма (для администраторов и клиентов) в коде
- [ ] Включить в письмо: все данные заказа (кроме платежных), адрес доставки, перечень позиций, их стоимость, общая стоимость
- [ ] Реализовать поддержку HTML в письмах
- [ ] Реализовать отправку письма при создании заказа
- [ ] Создать шаблон письма о закрытии заказа с просьбой оставить обратную связь
- [ ] Реализовать отправку письма о закрытии заказа
- [ ] **Примечание:** Шаблоны только на одном языке, редактирование через админку не требуется

### Фаза 5: WordPress шаблоны и интеграция

#### 5.1. Шаблон страницы корзины (`page-cart.php`)
- [ ] Создать шаблон `page-cart.php` в корне темы
- [ ] Добавить Template Name: "Корзина"
- [ ] Реализовать подключение компонента `cart-page` через фильтр `elkaretro_required_components`
- [ ] Добавить разметку страницы (header, footer)
- [ ] Реализовать автоматическое создание страницы корзины при инициализации темы (в `functions.php`, хук `after_setup_theme`)
- [ ] Проверить, что страница создается только если её еще не существует
- [ ] Привязать шаблон `page-cart.php` к созданной странице
- [ ] **Примечание:** Аналогично созданию страниц "Блог" и "Каталог" в `functions.php`

**Пример кода для `functions.php` (в хук `after_setup_theme`):**
```php
// Проверяем, существует ли уже страница с slug 'cart'
if (!get_page_by_path('cart')) {
    $cart_page = array(
        'post_title'   => 'Корзина',
        'post_name'    => 'cart',
        'post_content' => '',
        'post_status'  => 'publish',
        'post_type'    => 'page',
        'post_author'  => 1,
        'meta_input'   => array(
            '_wp_page_template' => 'page-cart.php',
        ),
    );
    
    $cart_page_id = wp_insert_post($cart_page);
    
    if (!is_wp_error($cart_page_id)) {
        update_post_meta($cart_page_id, '_wp_page_template', 'page-cart.php');
    }
}
```

#### 5.2. Регистрация компонента корзины
- [ ] Добавить `'cart-page'` в реестр компонентов в `components/components.js`
- [ ] Добавить проверку шаблона `page-cart.php` в фильтр `elkaretro_required_components` в `functions.php`
- [ ] Убедиться, что компонент `cart-page` загружается только на странице корзины

**Пример кода для `functions.php` (в фильтр `elkaretro_required_components`):**
```php
if (is_page_template('page-cart.php')) {
    $components[] = 'cart-page';
}
```

**Пример кода для `components/components.js` (в реестр):**
```javascript
const registry = {
  // ... существующие компоненты
  'cart-page': () => import('./cart/cart-page/cart-page.js'),
};
```

#### 5.3. Интеграция с существующими компонентами
- [ ] Интегрировать кнопку "Добавить в корзину" в `toy-instance-card`
- [ ] Интегрировать кнопку "Добавить в корзину" в `ny-accessory-card`
- [ ] Добавить счетчик корзины в `site-header`
- [ ] Добавить ссылку на корзину в навигацию

#### 5.4. Синхронизация корзины
- [ ] Реализовать синхронизацию LocalStorage → User Meta при авторизации
- [ ] Реализовать синхронизацию User Meta → LocalStorage при выходе
- [ ] Реализовать обработку конфликтов: приоритет User Meta над LocalStorage
- [ ] Реализовать логику: если LocalStorage пуст, а User Meta есть - обновить LocalStorage
- [ ] Реализовать логику: если User Meta пуст, а LocalStorage есть - обновить User Meta

#### 5.5. Тестирование
- [ ] Протестировать добавление/удаление товаров (уникальные товары, без количества)
- [ ] Протестировать расчет стоимости и скидок
- [ ] Протестировать объединенную корзину (toy_instance + ny_accessory)
- [ ] Протестировать Wizard оформления (ветвление для авторизованных/неавторизованных)
- [ ] Протестировать создание заказа (с регистрацией для неавторизованных)
- [ ] Протестировать синхронизацию корзины (приоритет User Meta)
- [ ] Протестировать отправку писем

## Post-MVP (Будущие улучшения)

### Улучшения UX
- [ ] Автосохранение прогресса Wizard при каждом шаге
- [ ] Восстановление сессии Wizard при возврате на страницу
- [ ] Прогресс-бар в Wizard
- [ ] Мини-корзина (dropdown) в хедере
- [ ] Быстрый просмотр корзины без перехода на страницу

### Расширенная функциональность
- [ ] История заказов в профиле пользователя (бессрочное хранение)
- [ ] Повтор заказа
- [ ] Отмена заказа
- [ ] Отслеживание доставки
- [ ] Интеграция с платежными системами
- [ ] Онлайн оплата
- [ ] Интеграция со службами доставки
- [ ] Выбор сохраненных адресов (несколько адресов на аккаунт)
- [ ] Редактирование способа оплаты в заказе

### Оптимизация
- [ ] Кеширование данных корзины
- [ ] Оптимизация запросов к REST API
- [ ] Batch-операции для множественных товаров

## Post-MVP: Резервирование товаров

### Резервирование для авторизованных пользователей
- [ ] Реализовать резервирование товаров на 6 часов для авторизованных пользователей
- [ ] Реализовать обновление таймера при добавлении нового товара в корзину
- [ ] Создать компонент таймера обратного отсчета (общий на всю корзину)
- [ ] Реализовать логику коммуникаций в случае брошенной корзины
- [ ] Реализовать автоматическое освобождение товаров при истечении резервирования
- [ ] Реализовать изменение статуса товаров на `reserved` при резервировании

## Post-MVP: VIP статус

### VIP статус и льготы
- [ ] Реализовать проверку VIP статуса пользователя
- [ ] Реализовать хранение информации о VIP статусе
- [ ] Реализовать автоматическую проверку при достижении суммы 50 000 руб.
- [ ] Реализовать применение VIP льгот (скидка 10%, освобождение от сбора)
- [ ] Реализовать возможность запроса скидки на товары > 2000 руб.

## Приоритеты

**Высокий приоритет (MVP):**
- Базовая корзина (Фаза 1) - объединенная корзина, без резервирования
- Правила комиссионной торговли (Фаза 2) - сборы и скидки, без VIP
- Пошаговый Wizard (Фаза 3) - с ветвлением для авторизованных/неавторизованных
- Backend интеграция (Фаза 4) - создание заказа с регистрацией для неавторизованных

**Средний приоритет:**
- Интеграция с существующими компонентами
- Синхронизация корзины
- Тестирование

**Низкий приоритет (Post-MVP):**
- Улучшения UX
- Расширенная функциональность
- Оптимизация


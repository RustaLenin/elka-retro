# Диагностика проблемы с полем stock в PODS

## Симптомы

При сохранении аксессуара (`ny_accessory`) в админке WordPress появляются warnings:

```
Warning: Trying to access array offset on value of type null in 
C:\OSPanel\domains\elka-retro\wp-content\plugins\pods\classes\PodsAPI.php on line 6452

Warning: Cannot modify header information - headers already sent by 
(output started at C:\OSPanel\domains\elka-retro\wp-content\plugins\pods\classes\fields\pick.php:2003) 
in C:\OSPanel\domains\elka-retro\wp-admin\post.php on line 231
```

**Важно:** Изменения сохраняются, но warnings мешают нормальной работе.

## Гипотезы о причине проблемы

### Гипотеза 1: Неправильная конфигурация поля Number в PODS

**Описание:** Поле `stock` создано как `Number`, но PODS не может правильно обработать его конфигурацию.

**Проверка:**
1. Откройте поле `stock` в PODS Admin
2. Проверьте настройки:
   - **Number Format Type:** должен быть `Integer` (не `Decimal`)
   - **Number Decimals:** должен быть `0` (не пусто и не другое значение)
   - **Default Value:** должен быть `0` (не пусто)
   - **Required:** должен быть `No`

**Решение:** Если настройки отличаются — исправьте и сохраните.

---

### Гипотеза 2: Конфликт с другими полями типа Number

**Описание:** В PODS уже есть другие поля типа `Number` (например, `ny_cost`), и PODS пытается применить к `stock` те же настройки, что вызывают конфликт.

**Проверка:**
1. Проверьте настройки поля `ny_cost` (тоже Number)
2. Сравните настройки `stock` и `ny_cost`
3. Убедитесь, что они идентичны по типу (оба Integer или оба Decimal)

**Решение:** Приведите настройки `stock` в соответствие с `ny_cost`.

---

### Гипотеза 3: Проблема с обработкой default_value = 0

**Описание:** PODS может неправильно обрабатывать `default_value = 0`, считая его пустым значением.

**Проверка:**
1. Временно измените **Default Value** на `1` вместо `0`
2. Попробуйте сохранить аксессуар
3. Если ошибка исчезла — проблема в обработке `0`

**Решение:** 
- Оставьте Default Value = `1` временно
- Или используйте пустое значение по умолчанию и устанавливайте `0` программно

---

### Гипотеза 4: Проблема в PodsAPI.php на строке 6452

**Описание:** PODS пытается обратиться к массиву конфигурации поля, который равен `null`. Это может быть связано с тем, что поле только что создано и PODS еще не обновил свой внутренний кеш.

**Проверка:**
1. Очистите кеш PODS: **PODS Admin → Settings → Clear Pods Cache**
2. Очистите кеш WordPress (если используется плагин кеширования)
3. Очистите OPCache (если используется): перезапустите PHP-FPM или Apache
4. Попробуйте сохранить аксессуар снова

**Решение:** Если помогло — проблема была в кеше.

---

### Гипотеза 5: Проблема с полем pick.php на строке 2003

**Описание:** Ошибка начинается в `pick.php:2003`, что может указывать на проблему с полем типа Relationship или Pick.

**Проверка:**
1. Проверьте, нет ли в аксессуаре полей типа Relationship или Pick, которые ссылаются на несуществующие записи
2. Проверьте, нет ли полей, которые ожидают массив, но получают `null`

**Решение:** Исправьте проблемные поля или временно отключите их проверку.

---

### Гипотеза 6: Версия PODS имеет баг

**Описание:** Версия PODS может иметь известный баг с обработкой полей типа Number.

**Проверка:**
1. Проверьте версию PODS в **PODS Admin → About**
2. Поищите в интернете известные проблемы с этой версией
3. Проверьте changelog последних версий PODS

**Решение:** Обновите PODS до последней версии, если доступна.

---

### Гипотеза 7: Проблема с сохранением пустого значения

**Описание:** При первом сохранении аксессуара поле `stock` может быть пустым, и PODS не может правильно обработать это.

**Проверка:**
1. Убедитесь, что для существующего аксессуара поле `stock` имеет значение (не пустое)
2. Попробуйте сохранить аксессуар с явно указанным значением `stock = 10`

**Решение:** Установите значение по умолчанию для всех существующих аксессуаров:

```php
$accessories = get_posts( array(
    'post_type' => 'ny_accessory',
    'posts_per_page' => -1,
    'post_status' => 'any',
) );

foreach ( $accessories as $accessory ) {
    $stock = get_post_meta( $accessory->ID, 'stock', true );
    if ( $stock === '' || $stock === false || $stock === null ) {
        update_post_meta( $accessory->ID, 'stock', 0 );
    }
}
```

---

## План диагностики

1. ✅ Проверить настройки поля `stock` в PODS
2. ✅ Сравнить с настройками поля `ny_cost`
3. ✅ Очистить все кеши (PODS, WordPress, OPCache)
4. ✅ Установить значение по умолчанию для существующих аксессуаров
5. ✅ Проверить версию PODS и обновить, если нужно
6. ✅ Временно изменить Default Value на `1` для проверки гипотезы 3

## Временное решение

Если warnings не критичны и изменения сохраняются, можно:
1. Игнорировать warnings (они не влияют на функциональность)
2. Отключить отображение warnings в `wp-config.php`:
   ```php
   define('WP_DEBUG', false);
   define('WP_DEBUG_DISPLAY', false);
   ```

Но лучше найти и исправить корневую причину.


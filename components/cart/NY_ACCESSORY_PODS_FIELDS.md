# Настройка PODS для новогодних аксессуаров (ny_accessory)

Дополнительные поля, которые необходимо добавить в PODS для типа `ny_accessory`.

## Поле остатка (stock)

### Настройки поля

⚠️ **ВАЖНО:** Поле должно быть создано в PODS через админку. Добавление в `data-model.json` не создает поле автоматически!

- **Field Type:** `Number`
- **Name:** `stock` (обязательно использовать именно это имя)
- **Label:** `Остаток`
- **Required:** ❌ **НЕТ** (иначе будет ошибка при сохранении существующих аксессуаров без значения)
- **Default Value:** `0` (обязательно установить)
- **Number Format Type:** `Integer` (целое число)
- **Number Decimals:** `0` (без десятичных знаков)
- **Description:** `Количество доступных единиц аксессуара. При создании заказа остаток уменьшается на 1. Статус меняется на "Зарезервировано" только если остаток стал 0.`

**Дополнительные настройки в PODS:**
- **Show in Admin:** ✅ Да
- **Show on Add/Edit:** ✅ Да
- **Show in REST API:** ✅ Да (если нужно в REST API)

### Дополнительные настройки

- **Show on Card:** ✅ Да (отображать на карточке товара)
- **Show in Description:** ✅ Да (отображать в описании)
- **Show in Cart List:** ❌ Нет
- **Show in Filters:** ❌ Нет

### Логика работы

1. **При создании заказа:**
   - Остаток уменьшается на 1 (или на количество, если в будущем будет поддержка количества)
   - Если остаток стал 0: статус меняется на `reserved`
   - Если остаток > 0: статус остается `publish`

2. **При закрытии заказа:**
   - Если аксессуар имеет статус `reserved`: статус меняется на `sold`

3. **Валидация:**
   - Перед добавлением в корзину: проверять, что `stock > 0`
   - Перед созданием заказа: проверять, что `stock > 0` для всех аксессуаров в заказе

### Пример использования в коде

```php
// Получить остаток
$stock = absint( get_post_meta( $accessory_id, 'stock', true ) );

// Уменьшить остаток
$new_stock = max( 0, $stock - 1 );
update_post_meta( $accessory_id, 'stock', $new_stock );

// Проверить доступность
if ( $stock > 0 && $post_status === 'publish' ) {
    // Аксессуар доступен для заказа
}
```

## Связь с заказами

Для отслеживания связи аксессуара с заказом используется мета-поле `_order_id`:

- **Field Type:** Не создается через PODS (используется напрямую через `update_post_meta`)
- **Name:** `_order_id`
- **Description:** `ID заказа, в котором был заказан этот аксессуар`

## Решение проблемы с ошибками при сохранении

Если при сохранении аксессуара появляются ошибки:
```
Warning: Trying to access array offset on value of type null in PodsAPI.php
Warning: Cannot modify header information - headers already sent
```

**⚠️ ВАЖНО:** Проблема может быть связана с тем, что поле `stock` добавлено в `data-model.json`, но PODS пытается его обработать до того, как поле правильно создано в PODS.

**Решение:**

1. **Временно удалите поле `stock` из `data-model.json`:**
   - Откройте `core/data-model.json`
   - Найдите секцию `ny_accessory.fields.stock`
   - Временно закомментируйте или удалите это поле
   - Сохраните файл

2. **Убедитесь, что поле создано в PODS:**
   - Перейдите в **PODS Admin → Edit Pods → ny_accessory**
   - Проверьте, есть ли поле `stock` в списке полей
   - Если нет — создайте его по инструкции выше с настройками:
     - **Required:** ❌ **НЕТ**
     - **Default Value:** `0`
     - **Number Format Type:** `Integer`

3. **Обновите существующие аксессуары:**
   ```php
   // Выполните в консоли WordPress или через WP-CLI
   $accessories = get_posts( array(
       'post_type' => 'ny_accessory',
       'posts_per_page' => -1,
       'post_status' => 'any',
   ) );
   
   foreach ( $accessories as $accessory ) {
       $stock = get_post_meta( $accessory->ID, 'stock', true );
       // Если значение пустое или false, устанавливаем 0
       if ( $stock === '' || $stock === false || $stock === null ) {
           update_post_meta( $accessory->ID, 'stock', 0 );
       }
   }
   ```

4. **Очистите кеш PODS:**
   - Перейдите в **PODS Admin → Settings → Clear Pods Cache**

5. **Проверьте сохранение аксессуара:**
   - Попробуйте сохранить аксессуар
   - Если ошибка исчезла — верните поле `stock` в `data-model.json` (но с `required: false`)

6. **Если ошибка все еще есть:**
   - Проверьте версию PODS (может быть баг в версии)
   - Попробуйте пересоздать поле `stock` в PODS с нуля
   - Проверьте, нет ли других плагинов, которые могут конфликтовать с PODS

## Обновление существующих аксессуаров

После добавления поля `stock` в PODS:

1. Установить значение по умолчанию для существующих аксессуаров (см. код выше)

2. Для аксессуаров, которые уже были проданы (статус `sold`), установить `stock = 0`

3. Для аксессуаров со статусом `publish`, установить разумное значение остатка (например, 10)

## Интеграция с каталогом

При отображении аксессуаров в каталоге:

- Если `stock = 0` и статус `reserved` или `sold`: показывать как "Нет в наличии"
- Если `stock > 0` и статус `publish`: показывать как "В наличии (X шт.)"
- Кнопка "Добавить в корзину" должна быть неактивна, если `stock = 0` или статус не `publish`

## См. также

- [STOCK_MANAGEMENT.md](./STOCK_MANAGEMENT.md) - общая документация по управлению остатками
- [PODS_SETUP.md](./PODS_SETUP.md) - настройка PODS для заказов


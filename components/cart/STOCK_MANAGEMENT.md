# Управление остатками товаров

Документация по логике работы с остатками для разных типов товаров в системе заказов.

## Типы товаров и их особенности

### 1. Экземпляры игрушек (`toy_instance`)

**Характеристика:** Штучные товары, каждый экземпляр уникален.

**Логика работы:**
- ✅ **Статус меняется при создании заказа:**
  - `publish` → `reserved` (при добавлении в заказ)
- ✅ **Статус меняется при закрытии заказа:**
  - `reserved` → `sold` (при закрытии заказа)
- ❌ **Остаток не используется** (каждый экземпляр уникален)

**Реализация:**
- При создании заказа: все экземпляры из `toy_instance_items` получают статус `reserved`
- При закрытии заказа: все экземпляры со статусом `reserved` получают статус `sold`
- В мета-поле экземпляра сохраняется `_order_id` для связи с заказом

### 2. Новогодние аксессуары (`ny_accessory`)

**Характеристика:** Множественные товары с остатком (например, 10 штук одного типа).

**Логика работы:**
- ✅ **Остаток уменьшается при создании заказа:**
  - При добавлении аксессуара в заказ, остаток (`stock`) уменьшается на количество заказанных единиц
- ✅ **Статус меняется только если остаток стал 0:**
  - Если после заказа `stock > 0`: статус остается `publish`
  - Если после заказа `stock === 0`: статус меняется на `reserved`
- ✅ **При закрытии заказа:**
  - Если аксессуар был зарезервирован (`reserved`), статус меняется на `sold`

**Поле остатка:**
- **Field Type:** `Number` (Integer)
- **Name:** `stock`
- **Label:** `Остаток`
- **Required:** ✅ Да
- **Default Value:** `0`
- **Description:** `Количество доступных единиц аксессуара`

**Реализация:**
- При создании заказа:
  1. Для каждого аксессуара из `ny_accessory_items`:
     - Получить текущий остаток `stock`
     - Уменьшить остаток на 1 (или на количество, если в будущем будет поддержка количества)
     - Сохранить новый остаток
     - Если остаток стал 0: изменить статус на `reserved`
     - Сохранить `_order_id` в мета-поле аксессуара
- При закрытии заказа:
  - Если аксессуар имеет статус `reserved`: изменить статус на `sold`

## Схема работы статусов

### Экземпляры игрушек (`toy_instance`)

```
[publish] → [reserved] → [sold]
   ↓            ↓           ↓
 Доступен   В заказе    Продан
```

### Новогодние аксессуары (`ny_accessory`)

```
[publish, stock > 0] → [publish, stock = 0] → [reserved] → [sold]
        ↓                      ↓                ↓           ↓
   Доступен              Остаток 0         В заказе    Продан
```

**Важно:** Статус `reserved` для аксессуаров устанавливается только когда остаток становится 0.

## Код реализации

### Создание заказа (`Order_Service::create_order()`)

```php
// Для toy_instance
$this->reserve_toy_instances($toy_instance_items, $order_id);

// Для ny_accessory
$this->decrease_ny_accessory_stock($ny_accessory_items, $order_id);
```

### Закрытие заказа (`Order_Service::update_order_status('closed')`)

```php
// Для обоих типов
$this->mark_order_items_as_sold($order_id);
```

## Валидация остатков

**Перед созданием заказа необходимо проверить:**

1. Для `toy_instance`:
   - Экземпляр существует
   - Статус экземпляра = `publish` (доступен для заказа)

2. Для `ny_accessory`:
   - Аксессуар существует
   - Статус аксессуара = `publish` (доступен для заказа)
   - Остаток `stock > 0` (есть в наличии)

**Реализация валидации:**

Валидация выполняется в методе `Order_Service::validate_items_availability()` перед созданием заказа:

```php
// В create_order()
$validation_result = $this->validate_items_availability( $order_data['cart']['items'] );
if ( is_wp_error( $validation_result ) ) {
    return $validation_result; // Возвращаем ошибку, заказ не создается
}
```

**Ошибки валидации:**

- `order_item_not_found` - товар не найден
- `order_item_unavailable` - товар недоступен (статус не `publish`)
- `order_item_out_of_stock` - аксессуар закончился (stock <= 0)

**Примечание:** Валидация остатков должна выполняться на этапе добавления товара в корзину (frontend), а также при создании заказа (backend) для защиты от race conditions.

## Будущие улучшения

1. **Поддержка количества в заказе:**
   - Вместо уменьшения остатка на 1, уменьшать на количество заказанных единиц
   - Добавить поле `quantity` в структуру заказа для аксессуаров

2. **Резервирование остатков:**
   - Временное резервирование остатков при добавлении в корзину
   - Автоматическое освобождение при истечении времени резерва

3. **Уведомления о низком остатке:**
   - Уведомление администратора, когда остаток аксессуара становится меньше определенного порога

4. **История изменений остатков:**
   - Логирование всех изменений остатков с привязкой к заказам


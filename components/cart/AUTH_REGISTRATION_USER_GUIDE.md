# Авторизация и регистрация — пользовательское руководство

## Обзор

Система авторизации и регистрации на сайте использует **беспарольную авторизацию** через email и 6-значный код. Это упрощает процесс регистрации и делает его более безопасным.

---

## Как это работает

### Регистрация нового пользователя

1. **Ввод email:**
   - Пользователь вводит свой email адрес
   - Система проверяет, существует ли аккаунт с таким email

2. **Создание аккаунта:**
   - Если аккаунта нет — создаётся новый аккаунт
   - На email отправляется письмо с благодарностью за регистрацию
   - Затем отправляется отдельное письмо с 6-значным кодом

3. **Ввод кода:**
   - Пользователь вводит код из письма
   - При первой успешной авторизации email считается подтверждённым
   - Пользователь авторизован и может оформлять заказы

### Авторизация существующего пользователя

1. **Ввод email:**
   - Пользователь вводит свой email адрес
   - Система определяет, что аккаунт существует

2. **Получение кода:**
   - На email отправляется письмо с 6-значным кодом

3. **Ввод кода:**
   - Пользователь вводит код из письма
   - Пользователь авторизован

---

## Особенности работы с кодом

### Время жизни кода

- Код действителен **24 часа** с момента создания
- Если код истёк, система отправит новый код на email только в следующих случаях:
  - После нового введения почты
  - После попытки ввести код, когда старый код истёк

### Повторная отправка кода

- Можно запросить новый код не ранее чем через **3 минуты** после предыдущего запроса
- При запросе нового кода показывается таймер обратного отсчёта
- Если прошло меньше 3 минут — кнопка "Отправить код повторно" заблокирована

### Неправильный код

- Предоставляется **10 попыток** ввода кода
- Если код введён неправильно — показывается ошибка "Код неверный"
- После 10 неудачных попыток:
  - Код сбрасывается
  - Ввод кода для аккаунта блокируется на **3 часа**
  - После истечения блокировки можно запросить новый код

### Изменение email

- **Нельзя изменить email** после создания аккаунта
- При вводе email система сразу проверяет, существует ли аккаунт с такой почтой
- Если аккаунта нет — создаётся новый аккаунт
- С момента создания аккаунта email закреплён за ним
- Другой email = другой аккаунт
- Если нужно использовать другой email — создайте новый аккаунт

---

## Письма

### Письмо о регистрации

**Отправляется:** Только при создании нового аккаунта

**Содержит:**
- Благодарность за создание аккаунта
- Короткое описание механизма авторизации на сайте
- Ссылки на основные разделы сайта
- Короткий F.A.Q.

**Важно:** Это письмо **не содержит кода**. Код присылается в отдельном письме.

### Письмо с кодом

**Отправляется:**
- При создании нового аккаунта (после письма о регистрации)
- При запросе кода для существующего аккаунта
- При истечении кода (если пользователь пытается использовать истёкший код)

**Содержит:**
- 6-значный код
- Дату создания кода по серверному времени
- Комментарий, что новый код можно создать не ранее чем через 3 минуты
- Информацию о том, что код действителен только в течение суток
- Ссылку на главную страницу
- IP-адрес или устройство, с которого был запрошен код (для безопасности)

---

## Анонимные заказы

### Что это?

Пользователь может оформить заказ **без регистрации и авторизации**, указав только email (и телефон, если требуется способом доставки).

### Как это работает

1. **Выбор опции:**
   - На шаге оформления заказа пользователь видит две кнопки:
     - "Зарегистрироваться/Авторизоваться"
     - "Оставить заказ" (анонимный заказ)

2. **Ввод данных:**
   - В обоих случаях показывается поле для ввода email
   - Для анонимного заказа может потребоваться телефон (если выбран способ доставки, который требует телефон, но его он указывает раньше)
   - Для анонимного заказа показывается дополнительное поле (textarea) для указания предпочитаемых способов связи:
     - Пользователь может указать ссылки на Telegram, WhatsApp, VK, Facebook и т.д.
     - Может написать комментарий о том, когда ему будет удобно связаться через эти способы
     - Поле необязательное, без валидации

3. **Создание заказа:**
   - Заказ создаётся без привязки к аккаунту
   - Email сохраняется в заказе
   - После закрытия заказа данные пользователя очищаются (в соответствии с 152-ФЗ)

### Автоматическое определение аккаунта

- Если пользователь вводит email, на который уже есть аккаунт, система **предлагает авторизоваться**
- Пользователь может **настоять** на создании анонимного заказа
- Пользователь **сам выбирает** опцию, система не настаивает

### Привязка заказа к аккаунту

- Если пользователь создал анонимный заказ, а потом зарегистрировался с тем же email — **заказ автоматически привязывается к аккаунту**
- Это позволяет видеть все заказы в личном кабинете

### Изменение решения

- Если пользователь выбрал "Оставить заказ", но потом передумал — может авторизоваться **после** создания заказа

---

## Безопасность

### Защита от злоупотреблений

- Ограничение частоты запросов кода: не чаще 1 раза в 3 минуты
- Ограничение количества кодов на один email за сутки: не больше 10 кодов
- Блокировка новых попыток авторизации после 10 неудачных попыток ввода кода на 3 часа
- В письме с кодом указывается IP-адрес или устройство, с которого был запрошен код

### Валидация email

- Проверка формата email (на фронте и на бэке)
- Проверка существования email через отправку кода:
  - Если почты не существует — письмо с кодом не будет отправлено
  - Пользователь не сможет подтвердить почту и создать заказ

---

## Проблемы и решения

### Письмо с кодом не пришло

1. **Проверьте папку "Спам"** — письмо могло попасть туда
2. **Нажмите "Отправить код повторно"** — система отправит новый код
3. **После трёх отправок подряд без авторизации:**
   - Система предложит написать письмо на `zakaz@elka-retro.ru` с темой "проблема с авторизацией"
   - Администратор отправит код вручную

### Потеря доступа к email

- Восстановление доступа происходит через коммуникацию с `zakaz@elka-retro.ru`
- Если пользователь указал альтернативные способы связи (другая почта или телефон) и они были подтверждены — можно восстановить доступ через них
- По умолчанию используется альтернативная почта (SMS стоит денег)
- Пользователь всегда может создать новый аккаунт с новым email

### Код истёк

- Если код истёк (прошло больше 24 часов), система отправит новый код на email только как реакция на действие пользователя:
  - После нового введения почты
  - После попытки ввести код, когда старый код истёк
- На экране появится уведомление: "Старый код истёк, мы вам на почту отправили новый код"

### Слишком частые запросы

- Если запрос кода был сделан менее 3 минут назад, система покажет таймер обратного отсчёта
- Кнопка "Отправить код повторно" будет заблокирована до истечения таймера

### Блокировка авторизации

- После 10 неудачных попыток ввода кода блокируются **новые попытки авторизации** на 3 часа
- После истечения блокировки можно запросить новый код
- В будущем администраторы смогут снимать блокировку вручную

---

## Планы на будущее

### Ссылка на авторизацию по GET параметрам

- В будущем в письме с кодом будет ссылка для быстрой авторизации
- При переходе по ссылке откроется форма с кодом
- Код автоматически подставится из ссылки
- Запрос на авторизацию отправится автоматически (без дополнительных кликов)

### Управление блокировками администраторами

- В будущем администраторы смогут устанавливать и снимать блокировки на авторизацию вручную

### Смена email

- В будущем появится возможность сменить email в профиле
- При смене email будет создан новый аккаунт
- Все заказы и данные будут перепривязаны к новому аккаунту
- Старый аккаунт будет заблокирован **совсем** (не только для авторизации)

---

## Способы связи с клиентом

### Для анонимных заказов

При оформлении анонимного заказа пользователь может указать предпочитаемые способы связи:
- Показывается дополнительное поле (textarea) для свободного комментария
- Пользователь может указать ссылки на Telegram, WhatsApp, VK, Facebook и т.д.
- Может написать комментарий о том, когда ему будет удобно связаться через эти способы
- Поле необязательное, без валидации

### Для авторизованных пользователей

При оформлении заказа авторизованный пользователь также может указать предпочитаемые способы связи:
- Показывается аналогичное поле (textarea)
- Пользователя просят указать, как ему будет удобнее, чтобы с ним связались
- Поле необязательное, без валидации

---

## Связь с поддержкой

### Текущие способы связи

- **Email:** `zakaz@elka-retro.ru` — основной способ связи
- **Telegram:** В будущем будет добавлена ссылка на Telegram аккаунт для связи с поддержкой

### Когда обращаться

- Если код не приходит на email
- Если возникли проблемы с авторизацией
- Если нужно восстановить доступ к аккаунту

---

## Связанные документы

- `components/cart/AUTH_REGISTRATION.md` — полная техническая документация
- `components/user-profile/AUTH_REGISTRATION_IMPLEMENTATION.md` — документация для разработчиков
- `components/cart/ORDER_STEPS.md` — описание шагов оформления заказа


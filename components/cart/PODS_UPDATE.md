# Обновление конфигурации PODS для заказов

Инструкция по обновлению полей PODS для сущности `elkaretro_order` с учетом новой системы заказов.

## Новые поля, которые нужно добавить

### 1. Статус заказа (детальный)
- **Field Type**: `Select`
- **Name**: `order_status`
- **Label**: `Статус заказа`
- **Required**: ✅ Да
- **Options**:
  - `pending_confirmation` = Ожидает подтверждения
  - `awaiting_payment` = Ожидает оплаты
  - `awaiting_shippment` = Ожидает отправки
  - `shipped` = Отправлен
  - `awaiting_pickup` = Ожидает получения (самовывоз)
  - `clarification` = Уточнение у клиента
  - `completed` = Завершён
  - `rejected` = Отклонён
  - `cancelled` = Отменён
- **Description**: `Детальный статус заказа (бизнес-логика)`
- **Default Value**: `pending_confirmation`

### 2. Email для анонимных заказов
- **Field Type**: `Email`
- **Name**: `anonymous_email`
- **Label**: `Email (анонимный заказ)`
- **Required**: ❌ Нет (только для анонимных заказов)
- **Description**: `Email адрес для анонимных заказов (очищается после закрытия заказа)`

### 3. Предпочитаемые способы связи
- **Field Type**: `Textarea`
- **Name**: `preferred_communication`
- **Label**: `Предпочитаемые способы связи`
- **Required**: ❌ Нет
- **Description**: `Желаемые способы связи с клиентом (Telegram, WhatsApp, VK, Facebook и т.д.)`

### 4. Данные доставки (текстовая строка)
- **Field Type**: `Textarea`
- **Name**: `delivery_data`
- **Label**: `Данные доставки`
- **Required**: ❌ Нет
- **Description**: `Полные данные доставки в виде упорядоченной текстовой строки (имя, телефон, адрес, дата получения и т.д.)`
- **Note**: Это поле содержит все данные, которые пользователь ввёл в форме доставки, конкатенированные в одну строку в правильной последовательности. Формат зависит от выбранного способа доставки.

### 7. Отдельные поля адреса доставки (если ещё не созданы)

Если вы используете отдельные поля для адреса доставки (вместо одного поля `delivery_address`), создайте:

- **delivery_country** (Text) - Страна
- **delivery_region** (Text) - Регион/Область
- **delivery_city** (Text) - Город
- **delivery_street** (Text) - Улица, дом, квартира
- **delivery_postal_code** (Text) - Почтовый индекс

## Обновление существующих полей

### Поле `user` (Пользователь)
- **Важно**: Теперь это поле может быть пустым (0) для анонимных заказов
- **Required**: ❌ Изменить на "Нет" (было "Да")
- **Description**: Обновить: "Пользователь, оформивший заказ (0 для анонимных заказов)"

### Поле `delivery_method` (Способ доставки)
- **Обновить Options** (если используется Select):
  - `pickup_udelnaya` = Самовывоз с Удельного рынка
  - `pickup_ozon` = Пункт выдачи ОЗОН
  - `pickup_cdek` = Пункт выдачи СДЭК
  - `courier_cdek` = Курьер СДЭК
  - `post_russia` = Почта России

## Порядок добавления полей

1. **Сначала добавьте обязательные поля:**
   - `order_status` (Select)

2. **Затем добавьте поля для анонимных заказов:**
   - `anonymous_email` (Email)
   - `preferred_communication` (Textarea)

3. **Добавьте поля для данных доставки:**
   - `delivery_data` (Textarea)
   - Отдельные поля адреса (если используете)

4. **Обновите существующие поля:**
   - `user` (сделать необязательным)

## Проверка после добавления

После добавления полей проверьте:

1. ✅ В админке WordPress при редактировании заказа видны все новые поля
2. ✅ Поля корректно заполняются при создании заказа через API
3. ✅ Данные доставки (`delivery_data`) сохраняются в виде упорядоченной текстовой строки
4. ✅ Для анонимных заказов заполняется `anonymous_email`
5. ✅ Поле `order_status` автоматически устанавливается в `pending_confirmation` при создании заказа

## Пример данных в `delivery_data`

Для разных способов доставки `delivery_data` содержит упорядоченную текстовую строку со всеми заполненными полями:

### Самовывоз с Удельного рынка:
```
Имя: Иван Иванов
Желаемая дата получения: 2025-12-25
```

### Пункт выдачи ОЗОН:
```
Город: Санкт-Петербург
Адрес пункта выдачи ОЗОН: ул. Невский проспект, д. 1, пункт выдачи ОЗОН
Телефон получателя: +7 (999) 123-45-67
```

### Пункт выдачи СДЭК:
```
Фамилия: Иванов
Имя: Иван
Телефон: +7 (999) 123-45-67
Адрес пункта выдачи СДЭК: ул. Невский проспект, д. 1, пункт выдачи СДЭК
```

### Курьер СДЭК:
```
Адрес доставки: г. Санкт-Петербург, ул. Невский проспект, д. 1, кв. 10
```

### Почта России:
```
Страна: Россия
Город: Санкт-Петербург
Адрес: ул. Невский проспект, д. 1, кв. 10
Индекс: 191186
```

## Примечания

- Поле `delivery_data` сохраняется как упорядоченная текстовая строка (не JSON), все поля конкатенируются в правильной последовательности
- Технические поля (`order_status_history`, `is_anonymous`) сохраняются только в post_meta, не добавляются в PODS, так как админы не используют их в интерфейсе
- Для анонимных заказов поле `user` будет равно 0 или пустое
- Поле `anonymous_email` очищается после закрытия заказа (переход в статус `completed` или `rejected`)

## Краткая сводка: что нужно добавить/изменить в PODS

### Новые поля (добавить):
1. ✅ `order_status` (Select) - детальный статус заказа
2. ✅ `anonymous_email` (Email) - email для анонимных заказов
3. ✅ `preferred_communication` (Textarea) - предпочитаемые способы связи
4. ✅ `delivery_data` (Textarea) - полные данные доставки в виде упорядоченной текстовой строки

### Существующие поля (обновить):
1. ✅ `user` (Relationship) - сделать необязательным (Required: Нет)
2. ✅ `delivery_method` (Text/Select) - обновить опции, если используется Select

### Поля, которые уже должны быть (проверить наличие):
- `order_number` (Text)
- `total_amount` (Currency)
- `subtotal` (Currency)
- `discount_amount` (Currency)
- `fee_amount` (Currency)
- `delivery_address` (Textarea)
- `payment_method` (Text/Select)
- `payment_details` (Textarea)
- `notes` (Textarea) - примечания к заказу
- `created_at` (Date/Time)
- `toy_instance_items` (Relationship)
- `ny_accessory_items` (Relationship)
- `delivery_country`, `delivery_region`, `delivery_city`, `delivery_street`, `delivery_postal_code` (Text) - если используете отдельные поля адреса


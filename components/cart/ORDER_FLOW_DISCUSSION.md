# –û–±—Å—É–∂–¥–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã Flow –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞

–î–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞.

## üìã –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è

### 1. –®–∞–≥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (step-auth)

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –º–µ–∂–¥—É "–í–æ–π—Ç–∏" –∏ "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è"
- –ü—Ä–∏ –≤—ã–±–æ—Ä–µ "–í–æ–π—Ç–∏" –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –ü—Ä–∏ –≤—ã–±–æ—Ä–µ "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è" –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —à–∞–≥—É 2 (–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)

**–¢—Ä–µ–±—É–µ–º–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ:**
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫—É "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è"
- –ü–æ –∫–ª–∏–∫—É –æ—Ç–∫—Ä—ã–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ **–±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã**:
  - –û–±–Ω–æ–≤–∏—Ç—å `window.app.auth` (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
  - –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è
  - –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º—É —à–∞–≥—É

**–†–µ—à–µ–Ω–∏—è:**
1. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `window.app.auth` –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏:
   - –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∫ `/wp-json/wp/v2/users/me` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –û–±–Ω–æ–≤–∏—Ç—å `window.app.auth` –≤—Ä—É—á–Ω—É—é

2. ‚úÖ Cookies –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
   - WordPress —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç cookies —á–µ—Ä–µ–∑ `credentials: 'same-origin'` –≤ fetch –∑–∞–ø—Ä–æ—Å–µ
   - Cookies —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

3. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
   - –°–ª—É—à–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ `elkaretro:auth:login`
   - –û–±–Ω–æ–≤–∏—Ç—å `window.app.auth`
   - –ü–æ–∫–∞–∑–∞—Ç—å –≤–æ–ø—Ä–æ—Å: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è?" –∏–ª–∏ "–ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å –Ω—É–ª—è?"
   - –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±–æ—Ä–∞: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `determineNextStep()` –∏–ª–∏ –Ω–∞—á–∞—Ç—å —Å —à–∞–≥–∞ 2

4. ‚úÖ –ö–Ω–æ–ø–∫–∞ –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö:
   - –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"
   - –ü–æ–¥–ø–∏—Å—å: "—É–∫–∞–∑–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞"
   - –ü–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É 2 (–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ) –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

---

### 2. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞ (determineNextStep)

**–¢—Ä–µ–±—É–µ–º–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
–°–æ–∑–¥–∞—Ç—å –º–µ—Ç–æ–¥ `OrderWizard.determineNextStep()`, –∫–æ—Ç–æ—Ä—ã–π –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω–∞ –∫–∞–∫–æ–π —à–∞–≥ –Ω–∞–ø—Ä–∞–≤–∏—Ç—å:

**–ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- ‚úÖ `phone` / `phone_number` - –µ—Å—Ç—å –ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω?
- ‚úÖ `first_name` / `last_name` - –µ—Å—Ç—å –ª–∏ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—è?
- ‚úÖ `delivery_address` - –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏?
- ‚úÖ `delivery_method` (–∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞) - –µ—Å—Ç—å –ª–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ?
- ‚úÖ `payment_method` (–∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞) - –µ—Å—Ç—å –ª–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –ø–æ –æ–ø–ª–∞—Ç–µ?

**–õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —à–∞–≥–∞:**

```javascript
determineNextStep() {
  const user = window.app.auth?.user;
  if (!user || !window.app.auth.authenticated) {
    return 1; // –®–∞–≥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  }
  
  const userMeta = user.meta || {};
  const phone = user.phone || userMeta.phone || userMeta.phone_number || '';
  const hasPhone = phone && String(phone).trim() !== '';
  
  const firstName = user.first_name || userMeta.first_name || '';
  const lastName = user.last_name || userMeta.last_name || '';
  const hasName = firstName && lastName;
  
  const deliveryAddress = userMeta.delivery_address || '';
  const hasDeliveryAddress = deliveryAddress && String(deliveryAddress).trim() !== '';
  
  // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑ –¥–ª—è –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
  const lastOrder = this.getLastOrder(); // TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å
  const hasDeliveryPreference = lastOrder?.delivery_method;
  const hasPaymentPreference = lastOrder?.payment_method;
  
  // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞ - —à–∞–≥ 2 (–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
  if (!hasPhone) {
    return 2;
  }
  
  // –ï—Å–ª–∏ –Ω–µ—Ç –∞–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ - —à–∞–≥ 3 (–õ–æ–≥–∏—Å—Ç–∏–∫–∞)
  if (!hasDeliveryAddress) {
    return 3;
  }
  
  // –ï—Å–ª–∏ –Ω–µ—Ç —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã (–∏ –Ω–µ—Ç –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ –∑–∞–∫–∞–∑–∞) - —à–∞–≥ 4 (–û–ø–ª–∞—Ç–∞)
  if (!hasPaymentPreference) {
    return 4;
  }
  
  // –ï—Å–ª–∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å - –º–æ–∂–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  // –∏–ª–∏ —Å—Ä–∞–∑—É –ø–µ—Ä–µ–π—Ç–∏ –∫ —à–∞–≥—É 5 (–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ)
  // TODO: –æ–±—Å—É–¥–∏—Ç—å UX - –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ —à–∞–≥–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–ª–∏ —Å—Ä–∞–∑—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ?
  
  return 5; // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
}
```

**–†–µ—à–µ–Ω–∏—è:**
1. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞:
   - –î–∞, –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è—Ç—å `delivery_method` –∏ `payment_method` –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞
   - –¢–∞–∫–∂–µ –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è—Ç—å –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞

2. ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ —à–∞–≥–∏ –ª–æ–≥–∏—Å—Ç–∏–∫–∏/–æ–ø–ª–∞—Ç—ã:
   - **–†–µ—à–µ–Ω–∏–µ:** –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–µ —à–∞–≥–∏, –¥–∞–∂–µ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –µ—Å—Ç—å
   - –î–∞–≤–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ª—é–±–æ–º—É —à–∞–≥—É –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è
   - –ü—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏/–æ—Ç–∫—Ä—ã—Ç–∏–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö - —è–≤–Ω–æ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å:
     - "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è?" ‚Üí –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ —à–∞–≥–∏
     - "–ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å –Ω—É–ª—è" ‚Üí –Ω–∞—á–∞—Ç—å —Å —à–∞–≥–∞ 2 (–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)

3. ‚úÖ –ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
   - **–†–µ—à–µ–Ω–∏–µ:** –ö–æ–º–±–∏–Ω–∞—Ü–∏—è:
     - –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ ‚Üí –≤ user meta (`delivery_address`, `delivery_country`, –∏ —Ç.–¥.)
     - –°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏/–æ–ø–ª–∞—Ç—ã ‚Üí –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞ (–Ω–µ —Ö—Ä–∞–Ω–∏—Ç—å –≤ user meta, —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è)

---

### 3. –°—Ç—Ä–æ–≥–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:**
–ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–ª–∂–Ω—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —à–∞–≥–∏ —Å—Ç—Ä–æ–≥–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞.

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- –®–∞–≥ 1: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–≤—ã–±–æ—Ä: –≤–æ–π—Ç–∏ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è)
- –®–∞–≥ 2: –õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: email, username, password, confirm_password, phone, first_name, last_name)
- –®–∞–≥ 3: –õ–æ–≥–∏—Å—Ç–∏–∫–∞
- –®–∞–≥ 4: –û–ø–ª–∞—Ç–∞
- –®–∞–≥ 5: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –®–∞–≥ 1: –¢–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∞ "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è" (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ)
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–ª—Å—è —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –∫ `determineNextStep()`
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–ª—Å—è ‚Üí –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ —à–∞–≥–µ 1 –∏–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —à–∞–≥—É 2 –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏?
  - **–í–æ–ø—Ä–æ—Å:** –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø–∞–¥–∞–µ—Ç –Ω–∞ —à–∞–≥ 2 –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –µ—Å–ª–∏ –≤ —à–∞–≥–µ 1 —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∞ "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è"?
  - **–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É "–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è" –ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π, –∫–æ—Ç–æ—Ä–∞—è –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –Ω–∞ —à–∞–≥ 2.

**–í–∞–ª–∏–¥–∞—Ü–∏—è:**
- –ö–∞–∂–¥—ã–π —à–∞–≥ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `UIFormController.validate()` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª–µ–π
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–æ–ª–µ–π —á–µ—Ä–µ–∑ `field.showError()`

---

### 4. –†–∞–∑–Ω—ã–µ –Ω–∞–±–æ—Ä—ã –ø–æ–ª–µ–π –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö/–Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**

**–ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ (`order-personal.js`):**
- `email` (required)
- `username` (required)
- `password` (required)
- `confirm_password` (required)
- `phone` (required)
- `first_name` (optional)
- `last_name` (optional)

**–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ (`order-personal-authorized.js`):**
- `phone` (required)
- `first_name` (optional)
- `last_name` (optional)
- `email` –∏ `username` –±–µ—Ä—É—Ç—Å—è –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è

**–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ:**
‚úÖ –ü–æ–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º. –î–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö - –ø–æ–ª–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö - —Ç–æ–ª—å–∫–æ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö.

---

### 5. –†–∞–∑–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- –û–¥–∏–Ω —ç–Ω–¥–ø–æ–∏–Ω—Ç: `POST /wp-json/elkaretro/v1/orders`
- –õ–æ–≥–∏–∫–∞ —Ä–∞–∑–ª–∏—á–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ `Order_Service::create_order()`:
  - –ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Üí —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ `register_user_for_order()`
  - –ï—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —á–µ—Ä–µ–∑ `update_missing_user_profile_fields()`

**–¢—Ä–µ–±—É–µ–º–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ:**
–†–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –¥–≤–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞:

**–í–∞—Ä–∏–∞–Ω—Ç A: –†–∞–∑–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã**
```
POST /wp-json/elkaretro/v1/orders/guest
  - –î–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
  - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç: cart, personal (—Å email, username, password), logistics, payment
  - –°–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∑–∞—Ç–µ–º –∑–∞–∫–∞–∑

POST /wp-json/elkaretro/v1/orders
  - –î–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
  - –¢—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç: cart, personal (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —Ç–æ–ª—å–∫–æ phone, first_name, last_name), logistics, payment
  - –û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, —Å–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑
```

**–í–∞—Ä–∏–∞–Ω—Ç B: –û–¥–∏–Ω —ç–Ω–¥–ø–æ–∏–Ω—Ç —Å —Ä–∞–∑–Ω–æ–π –ª–æ–≥–∏–∫–æ–π (—Ç–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥)**
```
POST /wp-json/elkaretro/v1/orders
  - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
  - –ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Üí —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è + —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
  - –ï—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è + —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
```

**–†–µ—à–µ–Ω–∏–µ:**
1. ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤:
   - **–†–µ—à–µ–Ω–∏–µ:** –†–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –¥–≤–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞
   - –î–≤–∞ —á–∏—Å—Ç—ã—Ö –º–µ—Ç–æ–¥–∞ —Å –ø—Ä–æ—Å—Ç–æ–π –ª–æ–≥–∏–∫–æ–π
   - –ù–µ –¥–µ–ª–∞—Ç—å —Å–ª–æ–∂–Ω—É—é —É—Å–ª–æ–≤–Ω—É—é –ª–æ–≥–∏–∫—É –≤ –æ–¥–Ω–æ–º –º–µ—Ç–æ–¥–µ

**–ù–æ–≤—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:**
```
POST /wp-json/elkaretro/v1/orders/guest
  - –î–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç: cart, personal (email, username, password, phone, first_name, last_name), logistics, payment
  - –õ–æ–≥–∏–∫–∞: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
  - –ú–µ—Ç–æ–¥: Order_Service::create_guest_order()

POST /wp-json/elkaretro/v1/orders
  - –î–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  - –¢—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (permission_callback)
  - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç: cart, personal (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: phone, first_name, last_name), logistics, payment
  - –õ–æ–≥–∏–∫–∞: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
  - –ú–µ—Ç–æ–¥: Order_Service::create_authenticated_order()
```

---

### 6. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–ª–µ–π —Ñ–æ—Ä–º –∏ PODS

**–ü–æ–ª—è –≤ PODS (–∏–∑ PODS_SETUP.md):**

**–ó–∞–∫–∞–∑:**
- `order_number` ‚úÖ
- `user` ‚úÖ
- `toy_instance_items` ‚úÖ
- `ny_accessory_items` ‚úÖ
- `total_amount` ‚úÖ
- `subtotal` ‚úÖ
- `discount_amount` ‚úÖ
- `fee_amount` ‚úÖ
- `delivery_method` ‚úÖ
- `delivery_address` (textarea) ‚ö†Ô∏è
- `delivery_country` (–æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ) ‚ö†Ô∏è
- `delivery_region` (–æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ) ‚ö†Ô∏è
- `delivery_city` (–æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ) ‚ö†Ô∏è
- `delivery_street` (–æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ) ‚ö†Ô∏è
- `delivery_postal_code` (–æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ) ‚ö†Ô∏è
- `payment_method` ‚úÖ
- `payment_details` ‚úÖ
- `notes` ‚úÖ
- `created_at` ‚úÖ

**–ü–æ–ª—è –≤ —Ñ–æ—Ä–º–µ –ª–æ–≥–∏—Å—Ç–∏–∫–∏ (`order-logistics.js`):**
- `delivery_method` ‚úÖ
- `country` ‚úÖ (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç `delivery_country`)
- `region` ‚úÖ (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç `delivery_region`)
- `city` ‚úÖ (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç `delivery_city`)
- `street` ‚úÖ (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç `delivery_street`)
- `postal_code` ‚úÖ (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç `delivery_postal_code`)

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í PODS –µ—Å—Ç—å –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞:
1. `delivery_address` (textarea) - –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π
2. –û—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: `delivery_country`, `delivery_region`, `delivery_city`, `delivery_street`, `delivery_postal_code`

**–í–æ–ø—Ä–æ—Å—ã:**
1. ‚úÖ –ö–∞–∫–∏–µ –ø–æ–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ PODS?
   - **–í–∞—Ä–∏–∞–Ω—Ç A:** –¢–æ–ª—å–∫–æ `delivery_address` (textarea) - –ø—Ä–æ—â–µ, –Ω–æ –º–µ–Ω–µ–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ
   - **–í–∞—Ä–∏–∞–Ω—Ç B:** –û—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è - –±–æ–ª–µ–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ, —É–¥–æ–±–Ω–µ–µ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –ø–æ–∏—Å–∫–∞
   - **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í–∞—Ä–∏–∞–Ω—Ç B (–æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è) - —Ñ–æ—Ä–º–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è, —ç—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–µ

2. ‚úÖ –ö–∞–∫ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∞–¥—Ä–µ—Å –≤ –∑–∞–∫–∞–∑–µ?
   - **–†–µ—à–µ–Ω–∏–µ:** –°–æ—Ö—Ä–∞–Ω—è—Ç—å –∏ –≤ `delivery_address` (–ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è), –∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ–ª—è—Ö (–¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
   - –§–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å `delivery_address` –∏–∑ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π: `"${country}, ${region}, ${city}, ${street}, ${postal_code}"`

3. ‚úÖ –ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—å –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?
   - **–í–∞—Ä–∏–∞–Ω—Ç A:** –í user meta –∫–∞–∫ `delivery_address` (textarea)
   - **–í–∞—Ä–∏–∞–Ω—Ç B:** –í user meta –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (`delivery_country`, `delivery_region`, –∏ —Ç.–¥.)
   - **–í–∞—Ä–∏–∞–Ω—Ç C:** –ö–æ–º–±–∏–Ω–∞—Ü–∏—è: –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è + —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π `delivery_address`
   - **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í–∞—Ä–∏–∞–Ω—Ç C - –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã, `delivery_address` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

---

## üìù –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. –ú–µ—Ç–æ–¥ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞

```javascript
// –í OrderWizard
async determineNextStep(useProfileData = false) {
  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª "–ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å –Ω—É–ª—è" - –Ω–∞—á–∏–Ω–∞–µ–º —Å —à–∞–≥–∞ 2
  if (!useProfileData) {
    return 2; // –®–∞–≥ –ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  if (!window.app?.auth?.user || !window.app.auth.authenticated) {
    return 1; // –®–∞–≥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  }
  
  const user = window.app.auth.user;
  const userMeta = user.meta || {};
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
  const phone = user.phone || userMeta.phone || userMeta.phone_number || '';
  if (!phone || String(phone).trim() === '') {
    return 2; // –®–∞–≥ –ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  }
  
  // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —à–∞–≥–∏, –Ω–æ –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
  // –ù–∞—á–∏–Ω–∞–µ–º —Å —à–∞–≥–∞ 2 (–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ) –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏/–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
  return 2;
}

async getLastOrderData() {
  // –ó–∞–ø—Ä–æ—Å –∫ API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞
  // GET /wp-json/elkaretro/v1/orders?per_page=1
  // –í–µ—Ä–Ω—É—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞ (delivery_method, payment_method, –∞–¥—Ä–µ—Å)
}
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏

```javascript
// –í OrderWizard –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Å–µ—Ä–≤–∏—Å–µ
async refreshAuthState() {
  try {
    const response = await fetch('/wp-json/wp/v2/users/me', {
      credentials: 'same-origin',
      headers: {
        'X-WP-Nonce': window.wpApiSettings?.nonce || '',
      },
    });
    
    if (response.ok) {
      const user = await response.json();
      // –û–±–Ω–æ–≤–ª—è–µ–º window.app.auth
      if (window.app) {
        window.app.auth = {
          authenticated: true,
          user: user,
        };
      }
      return user;
    }
  } catch (error) {
    console.error('[OrderWizard] Failed to refresh auth state:', error);
  }
  return null;
}
```

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ Wizard

```javascript
// –í OrderWizard.connectedCallback()
connectedCallback() {
  super.connectedCallback();
  
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
  
  // –°–ª—É—à–∞–µ–º —É—Å–ø–µ—à–Ω—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
  this._handleAuthSuccess = async () => {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    const user = await this.refreshAuthState();
    if (user) {
      this.setState({ isAuthorized: true });
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –∏–ª–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Å –Ω—É–ª—è?
      const useProfileData = await this.askUseProfileData();
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥
      const nextStep = await this.determineNextStep(useProfileData);
      this.goToStep(nextStep);
    }
  };
  
  window.addEventListener('elkaretro:auth:login', this._handleAuthSuccess);
}

async askUseProfileData() {
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–ª–∏ –∏–Ω–ª–∞–π–Ω-–≤–æ–ø—Ä–æ—Å
  // "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è?" –∏–ª–∏ "–ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å –Ω—É–ª—è?"
  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º boolean
  return new Promise((resolve) => {
    // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å UI –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞
    // –ü–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º true (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è)
    resolve(true);
  });
}

disconnectedCallback() {
  if (this._handleAuthSuccess) {
    window.removeEventListener('elkaretro:auth:login', this._handleAuthSuccess);
  }
}
```

### 4. –ò–∑–º–µ–Ω–µ–Ω–∏–µ step-auth

```javascript
// –í step-auth.js
render() {
  const { isAuthorized } = this.state;
  
  if (isAuthorized) {
    // –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —à–∞–≥
    this.dispatchEvent(new CustomEvent('wizard:step:next'));
    return;
  }
  
  // –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
  this.innerHTML = step_auth_template({
    isAuthorized: false,
  });
}

handleLogin() {
  // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  if (window.app?.events) {
    window.app.events.emit('user.showSignInModal', { source: 'order-wizard' });
  } else {
    window.app?.services?.userUi?.showSignInModal();
  }
  
  // –°–ª—É—à–∞–µ–º —É—Å–ø–µ—à–Ω—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
  const handleAuthSuccess = () => {
    window.removeEventListener('elkaretro:auth:login', handleAuthSuccess);
    // Wizard —Å–∞–º –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ —á–µ—Ä–µ–∑ determineNextStep()
  };
  
  window.addEventListener('elkaretro:auth:login', handleAuthSuccess, { once: true });
}

handleContinueWithoutAuth() {
  // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É 2 (–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ) –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  this.dispatchEvent(new CustomEvent('wizard:step:goto', {
    detail: { step: 2 },
  }));
}
```

**–®–∞–±–ª–æ–Ω step-auth:**
```html
<div class="step-auth">
  <h3>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
  <p>–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞</p>
  
  <ui-button 
    type="primary"
    label="–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è"
    event="step-auth:login-click"
  ></ui-button>
  
  <div class="step-auth_divider">
    <span>–∏–ª–∏</span>
  </div>
  
  <ui-button 
    type="secondary"
    label="–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"
    event="step-auth:continue-without-auth-click"
  ></ui-button>
  <p class="step-auth_hint">
    —É–∫–∞–∑–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞
  </p>
</div>
```

---

## ‚úÖ –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö—Ä–∏—Ç–∏—á–Ω–æ)
- [ ] –ò–∑–º–µ–Ω–∏—Ç—å `step-auth`:
  - –ö–Ω–æ–ø–∫–∞ "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è" (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ)
  - –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏" —Å –ø–æ–¥–ø–∏—Å—å—é
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `OrderWizard.refreshAuthState()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `OrderWizard.askUseProfileData()` - –≤–æ–ø—Ä–æ—Å: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –∏–ª–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Å –Ω—É–ª—è?
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `OrderWizard.determineNextStep(useProfileData)` - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞
- [ ] –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ `elkaretro:auth:login` –≤ Wizard –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞
- [ ] –†–∞–∑–¥–µ–ª–∏—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:
  - `POST /wp-json/elkaretro/v1/orders/guest` - –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
  - `POST /wp-json/elkaretro/v1/orders` - –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
- [ ] –°–æ–∑–¥–∞—Ç—å –¥–≤–∞ –º–µ—Ç–æ–¥–∞ –≤ `Order_Service`:
  - `create_guest_order()` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è + —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
  - `create_authenticated_order()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è + —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í–∞–∂–Ω–æ)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `OrderWizard.getLastOrderData()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞
- [ ] –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è/–ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã –ª–æ–≥–∏—Å—Ç–∏–∫–∏ –∏ PODS
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ user meta (–æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è + –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `step-confirmation.js` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ)
- [ ] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —à–∞–≥–∞ - –∫–µ—à–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ü–∏—é –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —à–∞–≥–æ–≤ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] –£–ª—É—á—à–∏—Ç—å UX –≤–æ–ø—Ä–æ—Å–∞ "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è?" - —Å–¥–µ–ª–∞—Ç—å –∫—Ä–∞—Å–∏–≤—ã–π UI

---

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–û–±—Å—É–¥–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è** - —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è
2. **–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã** - –∫–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –¥–µ–ª–∞—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å
3. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è** - –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º
4. **–û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é** - –ø–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

**–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω:** 2024  
**–°—Ç–∞—Ç—É—Å:** –û–±—Å—É–∂–¥–µ–Ω–∏–µ


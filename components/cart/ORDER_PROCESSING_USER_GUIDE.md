# Руководство по процессу оформления заказа

## Общий процесс

Процесс оформления заказа проходит через несколько шагов, каждый из которых собирает необходимую информацию и проверяет её корректность.

---

## Шаг 1: Авторизация

**Что происходит:**
- Система проверяет, авторизован ли пользователь
- Если пользователь авторизован → переход к шагу 2
- Если не авторизован → показывается экран с кнопками:
  - **"Авторизация"** — открывает форму входа
  - **"Продолжить без авторизации"** — переход к регистрации на следующем шаге

**Важно:** После успешной авторизации система автоматически определяет, какие шаги можно пропустить на основе данных профиля пользователя.

---

## Шаг 2: Личные данные

**Для неавторизованных пользователей:**
- Заполнение полей: Email, Логин, Пароль, Подтверждение пароля, Телефон, Имя, Фамилия
- Эти данные будут использованы для создания аккаунта

**Для авторизованных пользователей:**
- Показываются только поля: Телефон, Имя, Фамилия
- Поля предзаполняются данными из профиля (если есть)
- Email и Логин уже в профиле, не требуются

**Валидация:**
- Обязательные поля должны быть заполнены
- Телефон проверяется на корректность формата
- Пароль должен совпадать с подтверждением

---

## Шаг 3: Доставка

**Что собирается:**
- Способ доставки (курьером, самовывоз, почта)
- Адрес доставки (страна, регион, город, улица, индекс)

**Валидация:**
- Все поля адреса должны быть заполнены
- Индекс проверяется на корректность

---

## Шаг 4: Оплата

**Что собирается:**
- Способ оплаты (банковская карта, перевод, наличные при получении)
- Дополнительные детали (если требуются)

---

## Шаг 5: Подтверждение

**Что показывается:**
- Сводка всех данных заказа
- Личные данные
- Данные доставки
- Способ оплаты
- Итоговая стоимость (сумма товаров, скидка, сбор, итого)

**При нажатии "Завершить заказ":**
1. Кнопка сразу блокируется (нельзя нажать повторно)
2. Показывается оверлей с сообщением "Создание заказа..."
3. Начинается процесс создания заказа на сервере

---

## Процесс создания заказа на сервере

### 1. Бронирование товаров

**Что происходит:**
- Каждый товар из корзины проверяется на доступность
- Если товар доступен → он сразу "бронируется" (временно резервируется)
- Это защищает от ситуации, когда два пользователя одновременно заказывают последний экземпляр

**Если товар недоступен:**
- Все уже забронированные товары освобождаются
- Заказ не создается
- Пользователю показывается ошибка

### 2. Проверка и пересчет цен

**Что происходит:**
- Система получает актуальные цены товаров из базы данных
- Сравнивает с ценами, которые были в корзине
- Пересчитывает итоговую сумму на основе актуальных цен

**Если цена изменилась:**
- Заказ создается с актуальной ценой из базы данных
- Пользователю показывается уведомление: "За время оформления заказа цена изменилась. Актуальную стоимость всех товаров и общую сумму заказа вы увидите в письме."

### 3. Создание заказа

**Что происходит:**
- Создается запись заказа в системе
- Сохраняются все данные: личные данные, доставка, оплата, товары, суммы
- Товары переводятся в статус "Зарезервировано"
- Для аксессуаров уменьшается остаток на складе

**Если создание не удалось:**
- Все забронированные товары освобождаются
- Заказ не создается
- Пользователю показывается ошибка

### 4. Очистка корзины

**Что происходит:**
- Корзина очищается на сервере (для авторизованных пользователей)
- Корзина очищается в браузере (для всех пользователей)
- Прогресс оформления заказа удаляется

### 5. Отправка уведомлений

**Что происходит:**
- Отправляется письмо клиенту с деталями заказа
- Отправляется письмо администратору о новом заказе
- Если отправка администратору не удалась → отправляется на резервный адрес

**Статус отправки сохраняется:**
- Для каждого письма сохраняется информация: отправлено ли успешно и когда

---

## Потенциальные проблемы и их решения

### 1. Товар стал недоступен во время оформления

**Ситуация:** Пользователь добавил товар в корзину, но пока оформлял заказ, товар был заказан другим пользователем или изменен администратором.

**Что происходит:**
- Система проверяет доступность товара перед созданием заказа
- Если товар недоступен → заказ не создается
- Пользователю показывается ошибка с указанием, какой товар недоступен

**Рекомендация:** Пользователю нужно обновить корзину и удалить недоступный товар.

---

### 2. Цена изменилась во время оформления

**Ситуация:** Администратор изменил цену товара после того, как пользователь добавил его в корзину.

**Что происходит:**
- Система всегда использует актуальную цену из базы данных
- Заказ создается с актуальной ценой
- Пользователю показывается уведомление об изменении цены
- Актуальная цена указана в письме с деталями заказа

**Рекомендация:** Это нормальное поведение. Пользователь получает заказ по актуальной цене.

---

### 3. Ошибка при отправке письма

**Ситуация:** Письмо клиенту или администратору не удалось отправить (проблемы с почтовым сервером, неверный email и т.д.).

**Что происходит:**
- Заказ все равно создается успешно
- Статус отправки письма сохраняется (можно проверить в админке)
- Если письмо администратору не отправилось → автоматически отправляется на резервный адрес

**Рекомендация:** Проверить настройки почтового сервера и логи отправки.

---

### 4. Товар остался в статусе "Бронируется"

**Ситуация:** Товар был забронирован, но заказ не создался из-за ошибки, и товар остался в статусе "Бронируется" вместо возврата в "Доступно".

**Что происходит:**
- В нормальной ситуации товар автоматически освобождается при ошибке
- Если произошел сбой → товар может остаться в статусе "Бронируется"

**Рекомендация:** Проверить логи ошибок. При необходимости вручную изменить статус товара в админке.

---

### 5. Двойной заказ

**Ситуация:** Пользователь случайно дважды нажал "Завершить заказ".

**Что происходит:**
- Кнопка блокируется сразу при первом нажатии
- Показывается оверлей, который блокирует повторные действия
- Создается только один заказ

**Рекомендация:** Это защищено на уровне интерфейса. Если все же создались два заказа → проверить логи и удалить дубликат вручную.

---

### 6. Корзина не очистилась после заказа

**Ситуация:** После успешного создания заказа товары остались в корзине.

**Что происходит:**
- Корзина должна очищаться автоматически на сервере и в браузере
- Если этого не произошло → возможно, произошла ошибка после создания заказа

**Рекомендация:** Проверить, был ли заказ создан. Если да → очистить корзину вручную. Если нет → проверить логи ошибок.

---

## Рекомендации по тестированию

### Базовое тестирование

1. **Тест полного цикла для неавторизованного пользователя:**
   - Открыть корзину с товарами
   - Нажать "Оформить заказ"
   - Пройти все шаги визарда
   - Заполнить все обязательные поля
   - Завершить заказ
   - Проверить, что заказ создан
   - Проверить, что корзина очищена
   - Проверить, что письма отправлены

2. **Тест для авторизованного пользователя:**
   - Войти в систему
   - Открыть корзину
   - Пройти визард (должны быть предзаполнены данные)
   - Завершить заказ
   - Проверить, что данные из профиля использованы

### Тестирование защиты от проблем

3. **Тест race condition:**
   - Открыть два браузера с одним аккаунтом
   - В обоих добавить один и тот же товар в корзину
   - В обоих начать оформление заказа одновременно
   - Один заказ должен создатьсь, второй должен показать ошибку о недоступности товара

4. **Тест изменения цены:**
   - Добавить товар в корзину
   - Запомнить цену
   - Изменить цену товара в админке
   - Продолжить оформление заказа
   - Проверить, что заказ создан с новой ценой
   - Проверить уведомление об изменении цены

5. **Тест дублирования заказа:**
   - Нажать "Завершить заказ" несколько раз быстро
   - Проверить, что кнопка заблокировалась
   - Проверить, что создан только один заказ

6. **Тест недоступного товара:**
   - Добавить товар в корзину
   - В админке изменить статус товара на "Зарезервировано" или "Продано"
   - Попытаться завершить заказ
   - Проверить, что показана ошибка о недоступности товара

7. **Тест очистки корзины:**
   - Создать заказ
   - Обновить страницу
   - Проверить, что корзина пуста
   - Для авторизованного пользователя: проверить в админке, что корзина очищена в профиле

### Тестирование граничных случаев

8. **Тест с пустой корзиной:**
   - Попытаться открыть визард с пустой корзиной
   - Проверить, что показывается ошибка

9. **Тест с невалидными данными:**
   - Попытаться отправить форму с пустыми обязательными полями
   - Проверить, что показываются ошибки валидации
   - Попытаться ввести невалидный телефон
   - Проверить, что показывается ошибка

10. **Тест с изменением данных во время оформления:**
    - Начать оформление заказа
    - В другом окне изменить данные профиля
    - Завершить заказ
    - Проверить, что использованы данные, введенные в визарде

---

## Что проверить после создания заказа

1. **В админке WordPress:**
   - Заказ создан с правильным номером
   - Все данные заказа сохранены корректно
   - Товары переведены в статус "Зарезервировано"
   - Для аксессуаров уменьшен остаток на складе
   - Статусы отправки писем сохранены

2. **В почте:**
   - Клиент получил письмо с деталями заказа
   - Администратор получил письмо о новом заказе
   - В письмах указаны правильные данные и актуальные цены

3. **В системе:**
   - Корзина очищена
   - Прогресс оформления удален
   - Пользователь может начать новый заказ

---

## Частые вопросы

**В: Почему заказ не создается, хотя все поля заполнены?**
О: Возможно, один из товаров стал недоступен. Проверьте сообщение об ошибке — там указано, какой товар недоступен.

**В: Почему итоговая сумма отличается от той, что была в корзине?**
О: Цена товара изменилась во время оформления заказа. Заказ создан с актуальной ценой. Подробности в письме.

**В: Можно ли отменить заказ?**
О: После создания заказа его можно отменить только через администратора. Свяжитесь с поддержкой.

**В: Почему товар остался в корзине после заказа?**
О: Это ошибка. Проверьте, был ли заказ создан. Если да — очистите корзину вручную. Если нет — повторите оформление.

**В: Что делать, если не пришло письмо с заказом?**
О: Проверьте папку "Спам". Если письма нет — свяжитесь с поддержкой. Заказ создан, даже если письмо не пришло.

---

## Контрольный список перед продакшеном

- [ ] Протестирован полный цикл для неавторизованного пользователя
- [ ] Протестирован полный цикл для авторизованного пользователя
- [ ] Проверена защита от race conditions
- [ ] Проверена обработка изменения цен
- [ ] Проверена защита от дублирования заказов
- [ ] Проверена очистка корзины
- [ ] Проверена отправка писем
- [ ] Проверено сохранение статусов отправки писем
- [ ] Проверена обработка ошибок
- [ ] Проверено отображение статуса "Бронируется" в админке
- [ ] Проверена работа с аксессуарами (уменьшение остатка)
- [ ] Проверена работа с экземплярами (изменение статуса)


# Flow ะพัะพัะผะปะตะฝะธั ะทะฐะบะฐะทะฐ

ะะพะบัะผะตะฝั ะพะฟะธััะฒะฐะตั ะฟะพะปะฝัะน ะฟัะพัะตัั ะพัะพัะผะปะตะฝะธั ะทะฐะบะฐะทะฐ ั ะผะพะผะตะฝัะฐ ะฝะฐะถะฐัะธั ะบะฝะพะฟะบะธ "ะัะพัะผะธัั ะทะฐะบะฐะท" ะฒ ะบะพัะทะธะฝะต ะดะพ ัะพะทะดะฐะฝะธั ะทะฐะบะฐะทะฐ ะฝะฐ ัะตัะฒะตัะต.

## ๐ฏ ะขะพัะบะฐ ะฒัะพะดะฐ: ะะฝะพะฟะบะฐ "ะัะพัะผะธัั ะทะฐะบะฐะท"

**ะะฐัะฟะพะปะพะถะตะฝะธะต:** `components/cart/cart-page/cart-page-template.js`  
**ะะพะผะฟะพะฝะตะฝั:** `<ui-button event="cart-page:checkout-click">`

### ะะฑัะฐะฑะพััะธะบ ัะพะฑััะธั

**ะคะฐะนะป:** `components/cart/cart-page/cart-page.js`  
**ะะตัะพะด:** `startCheckout()`

```javascript
async startCheckout() {
  // 1. ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั ัะพะฒะฐัะพะฒ ะฒ ะบะพัะทะธะฝะต
  const items = this.state.items;
  if (!items || items.length === 0) {
    this.showNotification('ะะพัะทะธะฝะฐ ะฟัััะฐ', 'error');
    return;
  }

  // 2. ะะธะฝะฐะผะธัะตัะบะฐั ะทะฐะณััะทะบะฐ ะบะพะผะฟะพะฝะตะฝัะฐ order-wizard
  await import('../order-wizard/order-wizard.js');

  // 3. ะกะพะทะดะฐะฝะธะต ัะปะตะผะตะฝัะฐ Wizard
  const wizard = document.createElement('order-wizard');
  wizard.setAttribute('wizard-id', 'order-wizard-main');

  // 4. ะะฐะผะตะฝะฐ ัะพะดะตัะถะธะผะพะณะพ ัััะฐะฝะธัั ะฝะฐ Wizard
  const content = this.closest('.site_content') || this.parentElement;
  content.innerHTML = '';
  content.appendChild(wizard);
}
```

---

## ๐ ะจะฐะณะธ Order Wizard

**ะคะฐะนะป:** `components/cart/order-wizard/order-wizard.js`

### ะกัััะบัััะฐ ัะฐะณะพะฒ

```javascript
this.steps = [
  { id: 'auth', name: 'ะะฒัะพัะธะทะฐัะธั', component: 'step-auth', skipIfAuthorized: true },
  { id: 'personal', name: 'ะะธัะฝัะต ะดะฐะฝะฝัะต', component: 'step-personal', skipIfAuthorized: false },
  { id: 'logistics', name: 'ะะพััะฐะฒะบะฐ', component: 'step-logistics', skipIfAuthorized: false },
  { id: 'payment', name: 'ะะฟะปะฐัะฐ', component: 'step-payment', skipIfAuthorized: false },
  { id: 'confirmation', name: 'ะะพะดัะฒะตัะถะดะตะฝะธะต', component: 'step-confirmation', skipIfAuthorized: false },
];
```

### ะะฝะธัะธะฐะปะธะทะฐัะธั Wizard

**ะะตัะพะด:** `connectedCallback()`

```javascript
connectedCallback() {
  super.connectedCallback();
  
  // 1. ะะฝะธัะธะฐะปะธะทะฐัะธั ะดะฐะฝะฝัั ะทะฐะบะฐะทะฐ (ะทะฐะณััะทะบะฐ ะธะท LocalStorage, ะตัะปะธ ะตััั)
  this.initOrderData();
  
  // 2. ะัะพะฒะตัะบะฐ ะฐะฒัะพัะธะทะฐัะธะธ ะฟะพะปัะทะพะฒะฐัะตะปั
  this.checkAuth();
  
  // 3. ะะตะฝะดะตัะธะฝะณ ะธะฝัะตััะตะนัะฐ
  this.render();
  
  // 4. ะะฐะณััะทะบะฐ ัะตะบััะตะณะพ ัะฐะณะฐ
  this.loadStep();
}
```

---

## ๐ ะจะฐะณ 1: ะัะพะฒะตัะบะฐ ะฐะฒัะพัะธะทะฐัะธะธ

**ะะพะผะฟะพะฝะตะฝั:** `step-auth`  
**ะคะฐะนะป:** `components/cart/order-wizard/steps/step-auth.js`

### ะะพะณะธะบะฐ ะฒะตัะฒะปะตะฝะธั

**ะะตัะพะด:** `OrderWizard.checkAuth()`

```javascript
async checkAuth() {
  // ะัะพะฒะตัะบะฐ ัะตัะตะท window.app.auth (ะดะฐะฝะฝัะต ะธะท PHP)
  if (window.app?.auth?.user && window.app.auth.authenticated) {
    const user = window.app.auth.user;
    
    // ะะพะปัะทะพะฒะฐัะตะปั ะฐะฒัะพัะธะทะพะฒะฐะฝ
    this.setState({ isAuthorized: true });
    
    // ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั ัะตะปะตัะพะฝะฐ ะฒ ะฟัะพัะธะปะต
    const phone = user.phone || user.meta?.phone || user.meta?.phone_number || '';
    const hasPhone = phone && String(phone).trim() !== '';
    
    if (hasPhone) {
      // ะขะตะปะตัะพะฝ ะตััั โ ะฟะตัะตัะพะดะธะผ ะบ ัะฐะณั 3 (ะะพะณะธััะธะบะฐ)
      this.goToStep(3);
    } else {
      // ะขะตะปะตัะพะฝะฐ ะฝะตั โ ะฟะพะบะฐะทัะฒะฐะตะผ ัะฐะณ 2 (ะะธัะฝัะต ะดะฐะฝะฝัะต) ะดะปั ะทะฐะฟะพะปะฝะตะฝะธั
      this.goToStep(2);
    }
  } else {
    // ะะพะปัะทะพะฒะฐัะตะปั ะฝะต ะฐะฒัะพัะธะทะพะฒะฐะฝ โ ะฝะฐัะธะฝะฐะตะผ ั ัะฐะณะฐ 1 (ะะฒัะพัะธะทะฐัะธั)
    this.setState({ isAuthorized: false });
    this.goToStep(1);
  }
}
```

### ะะพะทะผะพะถะฝัะต ััะตะฝะฐัะธะธ

#### ะกัะตะฝะฐัะธะน A: ะะตะฐะฒัะพัะธะทะพะฒะฐะฝะฝัะน ะฟะพะปัะทะพะฒะฐัะตะปั
1. ะะพะบะฐะทัะฒะฐะตััั ัะฐะณ **ะะฒัะพัะธะทะฐัะธั** (`step-auth`)
2. ะะพะปัะทะพะฒะฐัะตะปั ะผะพะถะตั:
   - ะะฐะถะฐัั "ะะฒัะพัะธะทะฐัะธั" โ ะพัะบััะฒะฐะตััั ะผะพะดะฐะปัะฝะพะต ะพะบะฝะพ ะฐะฒัะพัะธะทะฐัะธะธ
   - ะะฐะถะฐัั "ะัะพะดะพะปะถะธัั ะฑะตะท ะฐะฒัะพัะธะทะฐัะธะธ" โ ะฟะตัะตัะพะด ะบ ัะฐะณั 2 (ะะธัะฝัะต ะดะฐะฝะฝัะต) ะดะปั ัะตะณะธัััะฐัะธะธ

#### ะกัะตะฝะฐัะธะน B: ะะฒัะพัะธะทะพะฒะฐะฝะฝัะน ะฟะพะปัะทะพะฒะฐัะตะปั (ะฟัะธ ะพัะบัััะธะธ Wizard)
1. ะจะฐะณ **ะะฒัะพัะธะทะฐัะธั** ะฟัะพะฟััะบะฐะตััั (`skipIfAuthorized: true`)
2. ะะพะบะฐะทัะฒะฐะตััั ะฒะพะฟัะพั: **"ะัะฟะพะปัะทะพะฒะฐัั ะดะฐะฝะฝัะต ะธะท ะฟัะพัะธะปั?"** ะธะปะธ **"ะะฐะฟะพะปะฝะธัั ั ะฝัะปั?"**
3. ะัะปะธ ะฒัะฑัะฐะฝะพ "ะัะฟะพะปัะทะพะฒะฐัั ะดะฐะฝะฝัะต ะธะท ะฟัะพัะธะปั":
   - ะะตัะตัะพะด ะบ ัะฐะณั 2 (ะะธัะฝัะต ะดะฐะฝะฝัะต) ั ะฟัะตะดะทะฐะฟะพะปะฝะตะฝะฝัะผะธ ะดะฐะฝะฝัะผะธ
   - ะัะต ะฟะพัะปะตะดัััะธะต ัะฐะณะธ ัะฐะบะถะต ะฟัะตะดะทะฐะฟะพะปะฝััััั ะธะท ะฟัะพัะธะปั/ะฟะพัะปะตะดะฝะตะณะพ ะทะฐะบะฐะทะฐ
4. ะัะปะธ ะฒัะฑัะฐะฝะพ "ะะฐะฟะพะปะฝะธัั ั ะฝัะปั":
   - ะะตัะตัะพะด ะบ ัะฐะณั 2 (ะะธัะฝัะต ะดะฐะฝะฝัะต) ั ะฟััััะผะธ ัะพัะผะฐะผะธ
   - ะัะพัะพะถะดะตะฝะธะต ะฒัะตั ัะฐะณะพะฒ ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพ

#### ะกัะตะฝะฐัะธะน C: ะะฒัะพัะธะทะฐัะธั ะฒ ะฟัะพัะตััะต ะพัะพัะผะปะตะฝะธั
1. ะะตะฐะฒัะพัะธะทะพะฒะฐะฝะฝัะน ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะฐะถะธะผะฐะตั "ะะฒัะพัะธะทะฐัะธั"
2. ะัะบััะฒะฐะตััั ะผะพะดะฐะปัะฝะพะต ะพะบะฝะพ ะฐะฒัะพัะธะทะฐัะธะธ
3. ะะพัะปะต ััะฟะตัะฝะพะน ะฐะฒัะพัะธะทะฐัะธะธ:
   - ะะฑะฝะพะฒะปัะตััั `window.app.auth` ะฑะตะท ะฟะตัะตะทะฐะณััะทะบะธ ัััะฐะฝะธัั
   - ะะพะบะฐะทัะฒะฐะตััั ะฒะพะฟัะพั: "ะัะฟะพะปัะทะพะฒะฐัั ะดะฐะฝะฝัะต ะธะท ะฟัะพัะธะปั?" ะธะปะธ "ะะฐะฟะพะปะฝะธัั ั ะฝัะปั?"
   - ะะตัะตัะพะด ะบ ัะพะพัะฒะตัััะฒัััะตะผั ัะฐะณั

---

## ๐ค ะจะฐะณ 2: ะะธัะฝัะต ะดะฐะฝะฝัะต

**ะะพะผะฟะพะฝะตะฝั:** `step-personal`  
**ะคะฐะนะป:** `components/cart/order-wizard/steps/step-personal.js`

### ะฃัะปะพะฒะฝะฐั ะปะพะณะธะบะฐ

**ะจะฐะฑะปะพะฝ:** `components/cart/order-wizard/steps/step-personal-template.js`

```javascript
// ะะปั ะฝะตะฐะฒัะพัะธะทะพะฒะฐะฝะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน
config-path="window.app.forms.orderPersonal"
// ะะพะปั: email, login, password, confirm_password, phone, first_name, last_name

// ะะปั ะฐะฒัะพัะธะทะพะฒะฐะฝะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน
config-path="window.app.forms.orderPersonalAuthorized"
// ะะพะปั: phone, first_name, last_name (email ะธ login ัะถะต ะฒ ะฟัะพัะธะปะต)
```

### ะะฑัะฐะฑะพัะบะฐ ะดะฐะฝะฝัั

**ะะตัะพะด:** `step-personal.js._initForm()`

```javascript
if (this.state.isAuthorized) {
  // ะะฒัะพัะธะทะพะฒะฐะฝะฝัะน ะฟะพะปัะทะพะฒะฐัะตะปั
  // ะัะตะดะทะฐะฟะพะปะฝะตะฝะธะต ะดะฐะฝะฝัั ะธะท ะฟัะพัะธะปั
  const user = window.app.auth.user;
  const userMeta = user.meta || {};
  
  if (userMeta.phone) {
    this._formController.setFieldValue('phone', userMeta.phone);
  }
  if (userMeta.first_name) {
    this._formController.setFieldValue('first_name', userMeta.first_name);
  }
  if (userMeta.last_name) {
    this._formController.setFieldValue('last_name', userMeta.last_name);
  }
} else {
  // ะะตะฐะฒัะพัะธะทะพะฒะฐะฝะฝัะน ะฟะพะปัะทะพะฒะฐัะตะปั
  // ะคะพัะผะฐ ัะตะณะธัััะฐัะธะธ (ะฒัะต ะฟะพะปั ะฟััััะต)
}
```

### ะะฐะปะธะดะฐัะธั

**ะะตัะพะด:** `step-personal.js.validate()`

```javascript
async validate() {
  const formController = this._formController;
  if (!formController) return false;
  
  // ะะฐะปะธะดะฐัะธั ัะตัะตะท UIFormController
  const isValid = await formController.validate();
  return isValid;
}
```

### ะกะพััะฐะฝะตะฝะธะต ะดะฐะฝะฝัั

**ะะตัะพะด:** `step-personal.js.getData()`

```javascript
getData() {
  const formController = this._formController;
  if (!formController) return null;
  
  const values = formController.getValues();
  
  if (this.state.isAuthorized) {
    // ะะปั ะฐะฒัะพัะธะทะพะฒะฐะฝะฝัั ะดะพะฑะฐะฒะปัะตะผ email ะธ username ะธะท ะฟัะพัะธะปั
    return {
      ...values,
      email: window.app.auth.user.email,
      username: window.app.auth.user.username,
    };
  }
  
  return values;
}
```

---

## ๐ ะจะฐะณ 3: ะะพะณะธััะธะบะฐ

**ะะพะผะฟะพะฝะตะฝั:** `step-logistics`  
**ะคะฐะนะป:** `components/cart/order-wizard/steps/step-logistics.js`

### ะะพะฝัะธะณััะฐัะธั ัะพัะผั

**ะคะฐะนะป:** `app/forms/order-logistics.js`

**ะะพะปั:**
- `delivery_method` - ัะฟะพัะพะฑ ะดะพััะฐะฒะบะธ (select-single)
- `delivery_address` - ะฐะดัะตั ะดะพััะฐะฒะบะธ (textarea)

### ะัะตะดะทะฐะฟะพะปะฝะตะฝะธะต ะดะฐะฝะฝัั

**ะะตัะพะด:** `step-logistics.js.initForm()`

```javascript
initForm() {
  const formController = this._formController;
  if (!formController) return;
  
  // ะัะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะฐะฒัะพัะธะทะพะฒะฐะฝ, ะทะฐะณััะถะฐะตะผ ะฐะดัะตั ะธะท ะฟัะพัะธะปั
  if (this.state.isAuthorized) {
    const userMeta = window.app.auth.user.meta || {};
    if (userMeta.delivery_address) {
      formController.setFieldValue('delivery_address', userMeta.delivery_address);
    }
  }
  
  // ะะฐะณััะถะฐะตะผ ัะพััะฐะฝะตะฝะฝัะต ะดะฐะฝะฝัะต ะธะท orderData
  if (this.state.orderData?.logistics) {
    const { delivery_method, delivery_address } = this.state.orderData.logistics;
    if (delivery_method) {
      formController.setFieldValue('delivery_method', delivery_method);
    }
    if (delivery_address) {
      formController.setFieldValue('delivery_address', delivery_address);
    }
  }
}
```

---

## ๐ณ ะจะฐะณ 4: ะะฟะปะฐัะฐ

**ะะพะผะฟะพะฝะตะฝั:** `step-payment`  
**ะคะฐะนะป:** `components/cart/order-wizard/steps/step-payment.js`

### ะะพะฝัะธะณััะฐัะธั ัะพัะผั

**ะคะฐะนะป:** `app/forms/order-payment.js`

**ะะพะปั:**
- `payment_method` - ัะฟะพัะพะฑ ะพะฟะปะฐัั (select-single)

### ะะฝะธัะธะฐะปะธะทะฐัะธั

**ะะตัะพะด:** `step-payment.js.initForm()`

```javascript
initForm() {
  const formController = this._formController;
  if (!formController) return;
  
  // ะะฐะณััะถะฐะตะผ ัะพััะฐะฝะตะฝะฝัะต ะดะฐะฝะฝัะต
  if (this.state.orderData?.payment) {
    const { payment_method } = this.state.orderData.payment;
    if (payment_method) {
      formController.setFieldValue('payment_method', payment_method);
    }
  }
}
```

---

## โ ะจะฐะณ 5: ะะพะดัะฒะตัะถะดะตะฝะธะต

**ะะพะผะฟะพะฝะตะฝั:** `step-confirmation`  
**ะคะฐะนะป:** `components/cart/order-wizard/steps/step-confirmation.js`

### ะัะพะฑัะฐะถะตะฝะธะต ะดะฐะฝะฝัั

**ะะตัะพะด:** `step-confirmation.js.loadOrderData()`

```javascript
loadOrderData() {
  const wizard = this.closest('order-wizard');
  if (!wizard) return;
  
  // ะกะพะฑะธัะฐะตะผ ะดะฐะฝะฝัะต ัะพ ะฒัะตั ัะฐะณะพะฒ
  const orderData = {
    cart: getCartStore().getCart(),
    personal: wizard.state.orderData?.personal,
    logistics: wizard.state.orderData?.logistics,
    payment: wizard.state.orderData?.payment,
  };
  
  this.setState({ orderData });
}
```

### ะกะพะทะดะฐะฝะธะต ะทะฐะบะฐะทะฐ

**ะะตัะพะด:** `step-confirmation.js.createOrder()`

```javascript
async createOrder() {
  this.setState({ isSubmitting: true, error: '' });
  
  try {
    // 1. ะะพะดะณะพัะพะฒะบะฐ ะดะฐะฝะฝัั ะทะฐะบะฐะทะฐ
    const orderData = this.prepareOrderData();
    
    // 2. ะัะฟัะฐะฒะบะฐ ะฝะฐ ัะตัะฒะตั
      // ะะฟัะตะดะตะปัะตะผ ัะฝะดะฟะพะธะฝั ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั ะฐะฒัะพัะธะทะฐัะธะธ
      const isAuthorized = window.app?.auth?.authenticated;
      const endpoint = isAuthorized 
        ? '/wp-json/elkaretro/v1/orders'
        : '/wp-json/elkaretro/v1/orders/guest';
      
      const response = await fetch(endpoint, {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
        'X-WP-Nonce': window.wpApiSettings?.nonce || '',
      },
      body: JSON.stringify(orderData),
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.message || 'ะัะธะฑะบะฐ ัะพะทะดะฐะฝะธั ะทะฐะบะฐะทะฐ');
    }
    
    const result = await response.json();
    
    if (result.success && result.order) {
      // 3. ะฃัะฟะตัะฝะพะต ัะพะทะดะฐะฝะธะต ะทะฐะบะฐะทะฐ
      this.setState({
        orderId: result.order.id,
        isSubmitting: false,
      });
      
      // 4. ะัะธััะบะฐ ะบะพัะทะธะฝั
      const store = getCartStore();
      store.clearCart();
      
      // 5. ะัะธััะบะฐ ะฟัะพะณัะตััะฐ Wizard
      localStorage.removeItem('elkaretro_order_wizard_progress');
      
      // 6. ะฃะฒะตะดะพะผะปะตะฝะธะต ะพ ัะพะทะดะฐะฝะธะธ ะทะฐะบะฐะทะฐ
      window.dispatchEvent(
        new CustomEvent('elkaretro:order:created', {
          detail: { order: result.order },
        })
      );
    }
  } catch (error) {
    // ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ
    this.setState({
      isSubmitting: false,
      error: error.message || 'ะัะธะฑะบะฐ ัะพะทะดะฐะฝะธั ะทะฐะบะฐะทะฐ',
    });
  }
}
```

### ะกัััะบัััะฐ ะดะฐะฝะฝัั ะทะฐะบะฐะทะฐ

**ะะตัะพะด:** `step-confirmation.js.prepareOrderData()`

```javascript
prepareOrderData() {
  return {
    cart: {
      items: this.state.orderData.cart.items.map(item => ({
        id: item.id,
        type: item.type,
      })),
    },
    personal: this.state.orderData.personal,
    logistics: this.state.orderData.logistics,
    payment: this.state.orderData.payment,
  };
}
```

---

## ๐ ะกะพััะฐะฝะตะฝะธะต ะฟัะพะณัะตััะฐ

**ะะตัะพะด:** `OrderWizard.saveProgress()`

```javascript
saveProgress() {
  try {
    localStorage.setItem('elkaretro_order_wizard_progress', JSON.stringify({
      currentStep: this.state.currentStep,
      orderData: this.state.orderData,
    }));
  } catch (error) {
    console.error('[OrderWizard] Failed to save progress:', error);
  }
}
```

**ะะพะณะดะฐ ัะพััะฐะฝัะตััั:**
- ะัะธ ะฟะตัะตัะพะดะต ะฝะฐ ัะปะตะดัััะธะน ัะฐะณ (`nextStep()`)
- ะัะธ ะฟะตัะตัะพะดะต ะฝะฐ ะฟัะตะดัะดััะธะน ัะฐะณ (`prevStep()`)
- ะัะธ ัะฒะฝะพะผ ะฒัะทะพะฒะต `goToStep()`

**ะะพะณะดะฐ ะพัะธัะฐะตััั:**
- ะะพัะปะต ััะฟะตัะฝะพะณะพ ัะพะทะดะฐะฝะธั ะทะฐะบะฐะทะฐ (`step-confirmation.js.createOrder()`)

---

## ๐ ะะฐะฒะธะณะฐัะธั ะผะตะถะดั ัะฐะณะฐะผะธ

### ะะตัะตัะพะด ะบ ัะปะตะดัััะตะผั ัะฐะณั

**ะะตัะพะด:** `OrderWizard.nextStep()`

```javascript
async nextStep() {
  const currentStep = this.state.currentStep;
  const step = this.steps[currentStep - 1];
  
  // 1. ะะฐะปะธะดะฐัะธั ัะตะบััะตะณะพ ัะฐะณะฐ
  const isValid = await this.validateStep(step);
  if (!isValid) {
    return false; // ะััะฐะตะผัั ะฝะฐ ัะตะบััะตะผ ัะฐะณะต
  }
  
  // 2. ะกะพััะฐะฝะตะฝะธะต ะดะฐะฝะฝัั ัะฐะณะฐ
  await this.saveStepData(step);
  
  // 3. ะะฟัะตะดะตะปะตะฝะธะต ัะปะตะดัััะตะณะพ ัะฐะณะฐ (ั ััะตัะพะผ skipIfAuthorized)
  let nextStepNumber = currentStep + 1;
  
  if (this.state.isAuthorized) {
    // ะัะพะฟััะบะฐะตะผ ัะฐะณะธ, ะบะพัะพััะต ะฝัะถะฝะพ ะฟัะพะฟัััะธัั ะดะปั ะฐะฒัะพัะธะทะพะฒะฐะฝะฝัั
    while (nextStepNumber <= this.steps.length) {
      const nextStep = this.steps[nextStepNumber - 1];
      if (!nextStep || !nextStep.skipIfAuthorized) {
        break;
      }
      nextStepNumber++;
    }
  }
  
  // 4. ะะตัะตัะพะด ะบ ัะปะตะดัััะตะผั ัะฐะณั
  if (nextStepNumber <= this.steps.length) {
    this.goToStep(nextStepNumber);
    return true;
  }
  
  return false;
}
```

### ะะตัะตัะพะด ะบ ะฟัะตะดัะดััะตะผั ัะฐะณั

**ะะตัะพะด:** `OrderWizard.prevStep()`

```javascript
prevStep() {
  if (this.state.currentStep > 1) {
    this.goToStep(this.state.currentStep - 1);
  }
}
```

---

## ๐ ะะธะฐะณัะฐะผะผะฐ Flow

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ะะพะปัะทะพะฒะฐัะตะปั ะฝะฐะถะธะผะฐะตั "ะัะพัะผะธัั ะทะฐะบะฐะท" ะฒ ะบะพัะทะธะฝะต          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  CartPage.startCheckout()                                   โ
โ  - ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั ัะพะฒะฐัะพะฒ                                 โ
โ  - ะะฐะณััะทะบะฐ order-wizard ะบะพะผะฟะพะฝะตะฝัะฐ                         โ
โ  - ะะฐะผะตะฝะฐ ัะพะดะตัะถะธะผะพะณะพ ัััะฐะฝะธัั ะฝะฐ Wizard                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  OrderWizard.connectedCallback()                            โ
โ  - initOrderData() (ะทะฐะณััะทะบะฐ ะธะท LocalStorage)              โ
โ  - checkAuth() (ะฟัะพะฒะตัะบะฐ ะฐะฒัะพัะธะทะฐัะธะธ)                       โ
โ  - render() (ะพััะธัะพะฒะบะฐ ะธะฝัะตััะตะนัะฐ)                          โ
โ  - loadStep() (ะทะฐะณััะทะบะฐ ัะตะบััะตะณะพ ัะฐะณะฐ)                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
                    โโโโโโโโโดโโโโโโโโ
                    โ               โ
                    โผ               โผ
        โโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโ
        โ ะะฒัะพัะธะทะพะฒะฐะฝ?      โ  โ ะะต ะฐะฒัะพัะธะทะพะฒะฐะฝ    โ
        โ ะขะตะปะตัะพะฝ ะตััั?     โ  โ                   โ
        โโโโโโโโโฌโโโโโโโโโโโโ  โโโโโโโโโโโฌโโโโโโโโโโ
                โ                       โ
        โโโโโโโโโดโโโโโโโโ               โ
        โ               โ               โ
        โผ               โผ               โผ
โโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโ
โ ะจะฐะณ 3:       โ  โ ะจะฐะณ 2:        โ  โ ะจะฐะณ 1:        โ
โ ะะพะณะธััะธะบะฐ    โ  โ ะะธัะฝัะต ะดะฐะฝะฝัะต โ  โ ะะฒัะพัะธะทะฐัะธั   โ
โโโโโโโโโฌโโโโโโโโ  โโโโโโโโโฌโโโโโโโโ  โโโโโโโโโฌโโโโโโโโ
        โ                  โ                  โ
        โ                  โโโโโโโโโโฌโโโโโโโโโโ
        โ                           โ
        โผ                           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ะจะฐะณ 3: ะะพะณะธััะธะบะฐ (ะะพััะฐะฒะบะฐ)                  โ
โ  - delivery_method                             โ
โ  - delivery_address                            โ
โโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ
                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ะจะฐะณ 4: ะะฟะปะฐัะฐ                                โ
โ  - payment_method                              โ
โโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ
                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ะจะฐะณ 5: ะะพะดัะฒะตัะถะดะตะฝะธะต                         โ
โ  - ะัะพะฑัะฐะถะตะฝะธะต ะฒัะตั ะดะฐะฝะฝัั                     โ
โ  - ะะฝะพะฟะบะฐ "ะะพะดัะฒะตัะดะธัั ะทะฐะบะฐะท"                  โ
โโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ
                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  step-confirmation.createOrder()               โ
โ  - ะะพะดะณะพัะพะฒะบะฐ ะดะฐะฝะฝัั ะทะฐะบะฐะทะฐ                    โ
โ  - ะะฟัะตะดะตะปะตะฝะธะต ัะฝะดะฟะพะธะฝัะฐ (guest ะธะปะธ auth)      โ
โ  - POST /wp-json/elkaretro/v1/orders/guest    โ
โ    ะธะปะธ                                         โ
โ  - POST /wp-json/elkaretro/v1/orders          โ
โโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ
                    โผ
        โโโโโโโโโโโโโดโโโโโโโโโโโโ
        โ                       โ
        โผ                       โผ
โโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโ
โ ะฃัะฟะตั         โ      โ ะัะธะฑะบะฐ        โ
โ - ะัะธััะบะฐ     โ      โ - ะะพะบะฐะท       โ
โ   ะบะพัะทะธะฝั     โ      โ   ะพัะธะฑะบะธ      โ
โ - ะัะธััะบะฐ     โ      โ - ะะพะทะผะพะถะฝะพััั โ
โ   ะฟัะพะณัะตััะฐ   โ      โ   ะฟะพะฒัะพัะธัั    โ
โ - ะกะพะฑััะธะต     โ      โ                โ
โ   elkaretro:  โ      โ                โ
โ   order:      โ      โ                โ
โ   created     โ      โ                โ
โโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโโ
```

---

## ๐ง Backend ะพะฑัะฐะฑะพัะบะฐ

**ะคะฐะนะป:** `core/orders/order-service.php`  
**ะญะฝะดะฟะพะธะฝัั:** 
- `POST /wp-json/elkaretro/v1/orders/guest` โ `Order_Service::create_guest_order()`
- `POST /wp-json/elkaretro/v1/orders` โ `Order_Service::create_authenticated_order()`

### ะัะพัะตัั ัะพะทะดะฐะฝะธั ะทะฐะบะฐะทะฐ ะดะปั ะฝะตะฐะฒัะพัะธะทะพะฒะฐะฝะฝัั (`create_guest_order()`)

1. **ะะฐะปะธะดะฐัะธั ะดะฐะฝะฝัั ัะตะณะธัััะฐัะธะธ**
   - ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั `email`, `username`, `password`
   - ะัะพะฒะตัะบะฐ ัะฝะธะบะฐะปัะฝะพััะธ email ะธ username

2. **ะะตะณะธัััะฐัะธั ะฟะพะปัะทะพะฒะฐัะตะปั**
   - ะกะพะทะดะฐะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั ัะตัะตะท `wp_create_user()`
   - ะกะพััะฐะฝะตะฝะธะต ะดะพะฟะพะปะฝะธัะตะปัะฝัั ะดะฐะฝะฝัั (phone, first_name, last_name) ะฒ user meta

3. **ะะฐะปะธะดะฐัะธั ะบะพัะทะธะฝั**
   - ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั ัะพะฒะฐัะพะฒ
   - ะัะพะฒะตัะบะฐ ััััะบัััั ะดะฐะฝะฝัั

4. **ะะตะฝะตัะฐัะธั ะฝะพะผะตัะฐ ะทะฐะบะฐะทะฐ**
   - ะฃะฝะธะบะฐะปัะฝัะน ะฝะพะผะตั ัะตัะตะท `generate_order_number()`

5. **ะะพะดะณะพัะพะฒะบะฐ ะดะฐะฝะฝัั ะดะปั PODS**
   - ะัะตะพะฑัะฐะทะพะฒะฐะฝะธะต ะดะฐะฝะฝัั ะทะฐะบะฐะทะฐ ะฒ ัะพัะผะฐั PODS
   - ะะฐะทะดะตะปะตะฝะธะต ัะพะฒะฐัะพะฒ ะฝะฐ `toy_instance_items` ะธ `ny_accessory_items`

6. **ะกะพะทะดะฐะฝะธะต ะทะฐะฟะธัะธ ะทะฐะบะฐะทะฐ**
   - `wp_insert_post()` ั ัะธะฟะพะผ `elkaretro_order`
   - ะกะพััะฐะฝะตะฝะธะต ะฟะพะปะตะน ัะตัะตะท PODS

7. **ะัะฟัะฐะฒะบะฐ email ัะฒะตะดะพะผะปะตะฝะธะน**
   - ะะดะผะธะฝะธัััะฐัะพัะฐะผ
   - ะะปะธะตะฝัั

### ะัะพัะตัั ัะพะทะดะฐะฝะธั ะทะฐะบะฐะทะฐ ะดะปั ะฐะฒัะพัะธะทะพะฒะฐะฝะฝัั (`create_authenticated_order()`)

1. **ะัะพะฒะตัะบะฐ ะฐะฒัะพัะธะทะฐัะธะธ**
   - ะะพะปััะตะฝะธะต `user_id` ัะตัะตะท `get_current_user_id()`
   - ะัะปะธ ะฝะต ะฐะฒัะพัะธะทะพะฒะฐะฝ โ ะพัะธะฑะบะฐ

2. **ะะฑะฝะพะฒะปะตะฝะธะต ะฟัะพัะธะปั (ะตัะปะธ ะฝัะถะฝะพ)**
   - ะัะปะธ ะฟะตัะตะดะฐะฝั `personal` ะดะฐะฝะฝัะต โ ะพะฑะฝะพะฒะปะตะฝะธะต ัะตัะตะท `update_missing_user_profile_fields()`
   - ะกะพััะฐะฝะตะฝะธะต phone, first_name, last_name ะฒ user meta

3. **ะะฐะปะธะดะฐัะธั ะบะพัะทะธะฝั**
   - ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั ัะพะฒะฐัะพะฒ
   - ะัะพะฒะตัะบะฐ ััััะบัััั ะดะฐะฝะฝัั

4. **ะะตะฝะตัะฐัะธั ะฝะพะผะตัะฐ ะทะฐะบะฐะทะฐ**
   - ะฃะฝะธะบะฐะปัะฝัะน ะฝะพะผะตั ัะตัะตะท `generate_order_number()`

5. **ะะพะดะณะพัะพะฒะบะฐ ะดะฐะฝะฝัั ะดะปั PODS**
   - ะัะตะพะฑัะฐะทะพะฒะฐะฝะธะต ะดะฐะฝะฝัั ะทะฐะบะฐะทะฐ ะฒ ัะพัะผะฐั PODS
   - ะะฐะทะดะตะปะตะฝะธะต ัะพะฒะฐัะพะฒ ะฝะฐ `toy_instance_items` ะธ `ny_accessory_items`

6. **ะกะพะทะดะฐะฝะธะต ะทะฐะฟะธัะธ ะทะฐะบะฐะทะฐ**
   - `wp_insert_post()` ั ัะธะฟะพะผ `elkaretro_order`
   - ะกะพััะฐะฝะตะฝะธะต ะฟะพะปะตะน ัะตัะตะท PODS

7. **ะกะพััะฐะฝะตะฝะธะต ะฐะดัะตัะฐ ะดะพััะฐะฒะบะธ ะฒ user meta**
   - ะกะพััะฐะฝะตะฝะธะต ะพัะดะตะปัะฝัั ะฟะพะปะตะน ะฐะดัะตัะฐ (`delivery_country`, `delivery_region`, ะธ ั.ะด.)
   - ะคะพัะผะธัะพะฒะฐะฝะธะต ะธ ัะพััะฐะฝะตะฝะธะต ะฟะพะปะฝะพะณะพ ะฐะดัะตัะฐ (`delivery_address`)

8. **ะัะฟัะฐะฒะบะฐ email ัะฒะตะดะพะผะปะตะฝะธะน**
   - ะะดะผะธะฝะธัััะฐัะพัะฐะผ
   - ะะปะธะตะฝัั

---

## ๐ ะัะธะผะตัะฐะฝะธั

### ะะพััะตะฒะพะณะพ ะพัะพัะผะปะตะฝะธั ะฝะตั
- ะัะตะณะดะฐ ััะตะฑัะตััั ัะตะณะธัััะฐัะธั ะธะปะธ ะฐะฒัะพัะธะทะฐัะธั
- ะะตะฐะฒัะพัะธะทะพะฒะฐะฝะฝัะต ะฟะพะปัะทะพะฒะฐัะตะปะธ ัะตะณะธัััะธัััััั ะฝะฐ ัะฐะณะต 2

### ะกะพััะฐะฝะตะฝะธะต ะฟัะพะณัะตััะฐ
- ะัะพะณัะตัั ัะพััะฐะฝัะตััั ะฒ `localStorage` (`elkaretro_order_wizard_progress`)
- ะัะธัะฐะตััั ะฟะพัะปะต ััะฟะตัะฝะพะณะพ ัะพะทะดะฐะฝะธั ะทะฐะบะฐะทะฐ
- ะะพะทะฒะพะปัะตั ะฒะตัะฝััััั ะบ ะพัะพัะผะปะตะฝะธั ะฟะพะทะถะต

### ะะฐะปะธะดะฐัะธั
- ะะฐะถะดัะน ัะฐะณ ะฒะฐะปะธะดะธััะตััั ะฟะตัะตะด ะฟะตัะตัะพะดะพะผ ะบ ัะปะตะดัััะตะผั
- ะัะฟะพะปัะทัะตััั `UIFormController.validate()`
- ะัะธะฑะบะธ ะพัะพะฑัะฐะถะฐัััั ะฝะฐ ััะพะฒะฝะต ะฟะพะปะตะน ัะตัะตะท `showError()`

### ะกะพะฑััะธั
- `elkaretro:order:created` - ะทะฐะบะฐะท ััะฟะตัะฝะพ ัะพะทะดะฐะฝ
- `elkaretro:cart:updated` - ะบะพัะทะธะฝะฐ ะพะฑะฝะพะฒะปะตะฝะฐ (ะฟะพัะปะต ะพัะธััะบะธ)

---

**ะะพะบัะผะตะฝั ะฐะบััะฐะปะตะฝ ะฝะฐ:** 2024  
**ะะตััะธั:** 1.0


# User Profile Module

## ⚠️ ВАЖНО: Документация устарела

**Статус:** Эта документация описывает **устаревшую реализацию** системы авторизации и регистрации.

**Актуальная документация:** См. `components/cart/AUTH_REGISTRATION.md` для описания текущих проблем и планов на изменение.

**Примечание:** Документация помечена как устаревшая, но сохранена для справки.

---

Модуль функциональности личного профиля пользователя на сайте ElkaRetro.

## Обзор

Модуль предоставляет:
- Модальные формы авторизации, регистрации и восстановления пароля
- Страницу профиля с вкладками (табами)
- Интеграцию с WordPress пользовательской системой через REST API

## Конфигурации форм

**Важно:** Конфигурации форм вынесены в централизованное хранилище `app/forms/`.

- Все конфигурации форм находятся в `app/forms/` (часть логики приложения, а не компонентов)
- Формы инициализируются через атрибут `config-path` в шаблоне
- Компоненты не должны программно управлять формой после создания в DOM

**См. документацию:**
- [`app/forms/README.md`](../../app/forms/README.md) — подробная документация по работе с формами
- [`app/forms/TODO.md`](../../app/forms/TODO.md) — задачи по миграции старых форм

## Структура

```
components/user-profile/
├── README.md                          # Эта документация
├── BACKLOG.md                         # Список задач и планов развития
├── modals/
│   └── auth-modals-styles.css         # Общие стили блоков внутри auth-модалок
├── profile-page/                      # Страница профиля
│   ├── profile-page.js                # Главный компонент страницы
│   ├── profile-page-template.js
│   ├── profile-page-styles.css
│   ├── tabs/                          # Компоненты вкладок
│   │   ├── profile-settings/          # Вкладка настроек профиля
│   │   │   ├── profile-settings.js
│   │   │   ├── profile-settings-template.js
│   │   │   └── profile-settings-styles.css
│   │   ├── order-history/              # Вкладка истории заказов
│   │   │   ├── order-history.js
│   │   │   ├── order-history-template.js
│   │   │   └── order-history-styles.css
│   │   └── contact-form/               # Вкладка формы обратной связи
│   │       ├── contact-form.js
│   │       ├── contact-form-template.js
│   │       └── contact-form-styles.css
│   └── tab-navigation/                # Навигация по вкладкам
│       ├── tab-navigation.js
│       ├── tab-navigation-template.js
│       └── tab-navigation-styles.css
└── services/                          # Сервисы для работы с API и UI
    ├── auth-service.js                 # Сервис авторизации (REST)
    ├── user-service.js                 # Сервис работы с пользователем (REST)
    ├── profile-api-adapter.js          # Адаптер для WordPress REST API
    └── user-ui-service.js              # Декларации модалок и действий UI
```

## Компоненты и декларации

### Auth-модали

Модальные окна авторизации больше не реализованы отдельными web-компонентами.  
Их декларации описаны в `services/user-ui-service.js` и работают через универсальный API `app.modal`.

- Каждая схема содержит `id`, `title/size/closable`, функцию `body()` и обработчик `onBodyReady`.
- `app.modal.open(schemaId)` создаёт `<ui-modal>` в `UIModalArea`, подставляет шаблон и показывает окно.
- Формы внутри модалей остаются декларативными (`<ui-form-controller config-path="app.forms.signIn" mode="modal">`).
- Стили для блоков (`.auth-modal__content`, `.register-modal__links`, `.password-reset-modal__success`) подключаются один раз из `modals/auth-modals-styles.css`.

Публичные методы UI-сервиса:

```js
app.services.userUi.showSignInModal();
app.services.userUi.showRegisterModal();
app.services.userUi.showPasswordResetModal();
```

Эти методы вызываются из `site-header`, `user-menu`, шага авторизации в checkout и других сценариев приложения, не дублируя код.

#### Декларативные действия (план внедрения)

Чтобы упростить обслуживание UI и подготовиться к конфигурации действий из админки, auth-модалки переходят на событийную шину приложения:

- шаблоны содержат только `data-app-action="user.showRegisterModal"` / `user.showPasswordResetModal`;
- глобальный делегат кликов срабатывает на `data-app-action` и отправляет событие в `app.events`;
- `userUiService` регистрирует свои действия (`showSignInModal`, `showRegisterModal`, `showPasswordResetModal`) через `app.events.register('user', handlers)`.

Документация: [`app/events/README.md`](../../app/events/README.md).

План миграции описан в разделе **"Event Actions"** файла [`components/user-profile/BACKLOG.md`](./BACKLOG.md).

### Страница профиля

#### profile-page
Главный компонент страницы профиля с вкладками.

**Атрибуты:**
- `user-id` (number) - ID пользователя (опционально, по умолчанию текущий пользователь)

**События:**
- `profile-page:tab-changed` - смена вкладки

**Использование:**
```html
<profile-page></profile-page>
```

#### Вкладки профиля

##### profile-settings
Вкладка настроек профиля. Позволяет редактировать:
- Имя (редактируемое)
- Фамилия (редактируемое)
- Display Name (редактируемое)
- Email (редактируемое, обязательное)
- Phone (редактируемое, обязательное)
- Адрес доставки (многострочное поле, редактируемое)
- Ссылка на аккаунт в мессенджере (редактируемое, например Телеграмм, Макс)
- Пароль (отдельная форма смены пароля)

**Обязательные поля (Email, Login, Phone):** Не редактируются напрямую через форму, требуют отдельного процесса (смена email требует верификации - не в MVP).

**Требования к паролю при смене:**
- Минимум 16 символов
- Должен содержать: маленькие буквы, большие буквы, цифры, спецсимволы

**Особенности:**
- Использует `ui-form-controller` для управления формой
- Автосохранение через REST API
- Валидация полей

##### order-history
Вкладка истории заказов.

**Структура заказа:**
- Список заказанных экземпляров игрушек
- Список заказанных новогодних аксессуаров
- Адрес доставки
- Предпочитаемая форма оплаты
- Общая сумма заказа
- ID пользователя который оформил заказ

**Особенности:**
- Отображает список заказов пользователя
- Сортировка: старые/новые
- Подгрузка при скролле (infinite scroll)
- Детальный просмотр заказа
- Возможность отмены заказа

**Примечание:** Сущность "заказ" будет реализована позже (сегодня, но несколько позже). Статусы заказов будут определены коллегой позже.

##### contact-form
Вкладка формы обратной связи.

**Форма отправки:**
- Тема сообщения (обязательное)
- Текст сообщения (обязательное, многострочное)

**Особенности:**
- Отправка на email: zakaz@elka-retro.ru
- Валидация полей
- Обработка ошибок отправки
- Уведомление об успешной отправке

**Примечание:** Прикрепление файлов (картинки, PDF, до 10 МБ), история сообщений, статусы - не в MVP.

## Интеграция с WordPress

### REST API Endpoints

Модуль использует стандартные WordPress REST API endpoints:

- **Авторизация:** `/wp-json/wp/v2/users/me` (GET) + WordPress nonce для проверки
- **Регистрация:** `/wp-json/wp/v2/users` (POST)
- **Восстановление пароля:** `/wp-json/wp/v2/users/lostpassword` (POST) или стандартный WP механизм
- **Обновление профиля:** `/wp-json/wp/v2/users/me` (POST)
- **Получение данных пользователя:** `/wp-json/wp/v2/users/me` (GET)

### Кастомные endpoints (если потребуются)

Для расширенной функциональности могут быть добавлены кастомные endpoints в `core/user-profile/`:
- `/wp-json/elkaretro/v1/user/profile` - расширенные данные профиля
- `/wp-json/elkaretro/v1/user/orders` - история заказов
- `/wp-json/elkaretro/v1/user/contact-messages` - сообщения обратной связи

### WordPress Nonce

Для безопасности все запросы, изменяющие данные, должны использовать WordPress nonce:
- Nonce передаётся в заголовке `X-WP-Nonce`
- Получается через `wp_create_nonce('wp_rest')` на сервере
- Передаётся в JavaScript через `window.wpApiSettings.nonce`

## Сервисы

### auth-service.js
Сервис для работы с авторизацией:
- `login(email, password)` - авторизация
- `logout()` - выход
- `checkAuth()` - проверка статуса авторизации
- `getCurrentUser()` - получение текущего пользователя

### user-service.js
Сервис для работы с данными пользователя:
- `getProfile(userId)` - получение профиля
- `updateProfile(data)` - обновление профиля
- `changePassword(oldPassword, newPassword)` - смена пароля

### profile-api-adapter.js
Адаптер для преобразования данных между форматом WordPress REST API и форматом, используемым компонентами.

## Состояние авторизации

Состояние авторизации хранится в:
- `window.app.auth` - объект с информацией о текущем пользователе
- `localStorage` - для сохранения сессии (если используется)
- WordPress cookies - стандартные WordPress cookies для авторизации

## События

Модуль генерирует глобальные события:
- `elkaretro:auth:login` - пользователь авторизовался
- `elkaretro:auth:logout` - пользователь вышел
- `elkaretro:auth:error` - ошибка авторизации
- `elkaretro:profile:updated` - профиль обновлён

## Интеграция в навигацию

Модальные формы авторизации должны быть доступны из:
- Хедера сайта (иконка в правой части хедера)
- Страницы профиля (если пользователь не авторизован)

**Для неавторизованных пользователей:**
- Иконка "Войти" / "Регистрация" в правой части хедера
- При клике открывается соответствующее модальное окно

**Для авторизованных пользователей:**
- Кружочек с одной/двумя первыми буквами display name в правой части хедера
- При клике открывается выпадающее меню:
  - Профиль (ссылка на `/profile/`)
  - Выйти (выход из системы)

Страница профиля доступна по URL `/profile/` или через шаблон `page-profile.php`.

## Безопасность

- Все формы используют WordPress nonce (CSRF защита)
- Пароли не передаются в открытом виде
- Валидация на клиенте и сервере
- Защита от брутфорса (ограничение попыток входа)
- XSS защита через санитизацию данных (стандартная WordPress защита)
- Проверка прав доступа (capabilities) для всех REST API запросов
- Защита страницы профиля (только для авторизованных пользователей)

## Требования к паролю

**Минимальные требования:**
- Длина: минимум 16 символов
- Должен содержать:
  - Маленькие буквы (a-z)
  - Большие буквы (A-Z)
  - Цифры (0-9)
  - Спецсимволы (!@#$%^&*()_+-=[]{}|;:,.<>?)

**Применяется для:**
- Регистрации новых пользователей
- Смены пароля в профиле

## Будущие возможности

См. [BACKLOG.md](./BACKLOG.md) для списка планируемых функций:
- OAuth (социальные сети) - после MVP
- Двухфакторная аутентификация (2FA) - после MVP
- Верификация email - после MVP
- Капча при регистрации - после MVP
- Аватар пользователя - после MVP
- День рождения - после MVP
- Прикрепление файлов к обратной связи (картинки, PDF, до 10 МБ) - после MVP
- История сообщений обратной связи - после MVP
- Интеграция с платежами - после MVP
- WishList (избранное, синхронизация между устройствами) - после MVP
- Кастомные запросы - после MVP
- Интеграция с аукционом (активные ставки в профиле)
- Продажа своих экземпляров (модерация, редактирование/удаление)
- Автоматическое удаление аккаунтов через 3 года (152 ФЗ РФ) - см. [BACKLOG.md](./BACKLOG.md)

## Соответствие 152 ФЗ РФ

В соответствии с требованиями 152 ФЗ РФ (срок хранения персональных данных - 3 года), необходимо реализовать функцию автоматического удаления аккаунтов пользователей через 3 года неактивности.

**Планируемая реализация (Post-MVP):**
- Cron-задача для проверки и удаления устаревших аккаунтов
- Уведомление пользователей перед удалением (за 30 дней, за 7 дней)
- Экспорт данных пользователя перед удалением (если требуется)
- Логирование удалений аккаунтов

Подробнее см. раздел "Post-MVP: Автоматическое удаление аккаунтов" в [BACKLOG.md](./BACKLOG.md).


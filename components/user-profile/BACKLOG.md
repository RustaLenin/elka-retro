# User Profile Module - Backlog

## ⚠️ ВАЖНО: Документация устарела

**Статус:** Эта документация описывает **устаревшие планы** по реализации системы авторизации и регистрации.

**Актуальная документация:** См. `components/cart/AUTH_REGISTRATION.md` для описания текущих проблем и планов на изменение.

**Примечание:** Документация помечена как устаревшая, но сохранена для справки.

---

Список задач и планов развития модуля профиля пользователя.

## MVP (Минимально жизнеспособный продукт)

### Фаза 1: Модальные формы авторизации

#### 1.1. Модальное окно авторизации
- [ ] Создать компонент `auth-modal`
- [ ] Интегрировать с `ui-modal` и `ui-form-controller`
- [ ] Реализовать форму авторизации (email, password, remember me)
- [ ] Интеграция с WordPress REST API для авторизации
- [ ] Обработка ошибок авторизации
- [ ] Редирект после успешной авторизации
- [ ] Ссылки на регистрацию и восстановление пароля

#### 1.2. Модальное окно регистрации
- [ ] Создать компонент `register-modal`
- [ ] Форма регистрации:
  - [ ] Email (обязательное)
  - [ ] Login (обязательное)
  - [ ] Phone (обязательное)
  - [ ] Password (обязательное, минимум 16 символов)
  - [ ] Confirm Password (обязательное, совпадение с паролем)
- [ ] Валидация полей:
  - [ ] Email формат
  - [ ] Сложность пароля (маленькие/большие буквы, цифры, спецсимволы, минимум 16 символов)
  - [ ] Совпадение паролей
  - [ ] Формат телефона
- [ ] Интеграция с WordPress REST API для регистрации
- [ ] Обработка ошибок (email/login уже существует и т.д.)
- [ ] Автоматическая авторизация после регистрации
- [ ] Ссылка на форму авторизации
- [ ] **Примечание:** Верификация email и капча - не в MVP

#### 1.3. Модальное окно восстановления пароля
- [ ] Создать компонент `password-reset-modal`
- [ ] Форма восстановления (email)
- [ ] Интеграция с WordPress механизмом восстановления пароля
- [ ] Сообщение об отправке письма
- [ ] Обработка ошибок

#### 1.4. Сервисы авторизации
- [ ] Создать `auth-service.js`
- [ ] Реализовать методы: `login()`, `logout()`, `checkAuth()`, `getCurrentUser()`
- [ ] Управление состоянием авторизации в `window.app.auth`
- [ ] Глобальные события авторизации

### Фаза 2: Страница профиля

#### 2.1. Базовый компонент страницы профиля
- [ ] Создать `profile-page.js`
- [ ] Создать шаблон `page-profile.php`
- [ ] Реализовать систему вкладок (табов)
- [ ] Компонент навигации по вкладкам `tab-navigation`
- [ ] Защита страницы (только для авторизованных пользователей)
- [ ] Редирект неавторизованных на главную с модалкой авторизации

#### 2.2. Вкладка "Настройки профиля"
- [ ] Создать компонент `profile-settings`
- [ ] Форма редактирования профиля:
  - [ ] Имя (редактируемое)
  - [ ] Фамилия (редактируемое)
  - [ ] Display Name (редактируемое)
  - [ ] Email (редактируемое, обязательное)
  - [ ] Phone (редактируемое, обязательное)
  - [ ] Адрес доставки (многострочное поле, редактируемое)
  - [ ] Ссылка на аккаунт в мессенджере (редактируемое, например Телеграмм, Макс)
- [ ] Отдельная форма смены пароля:
  - [ ] Старый пароль
  - [ ] Новый пароль (минимум 16 символов, сложный)
  - [ ] Подтверждение нового пароля
- [ ] Обязательные поля (Email, Login, Phone) - не редактируются напрямую
- [ ] Валидация всех полей
- [ ] Интеграция с WordPress REST API
- [ ] Автосохранение изменений
- [ ] Уведомления об успешном сохранении
- [ ] **Примечание:** Верификация email при смене - не в MVP, аватар - не в MVP, день рождения - не в MVP

#### 2.3. Вкладка "История заказов"
- [ ] Создать компонент `order-history`
- [ ] Структура заказа:
  - [ ] Список заказанных экземпляров игрушек
  - [ ] Список заказанных новогодних аксессуаров
  - [ ] Адрес доставки
  - [ ] Предпочитаемая форма оплаты
  - [ ] Общая сумма заказа
  - [ ] ID пользователя который оформил заказ
- [ ] Список заказов пользователя:
  - [ ] Отображение списка заказов
  - [ ] Сортировка: старые/новые
  - [ ] Подгрузка при скролле (infinite scroll)
  - [ ] Детальный просмотр заказа
  - [ ] Возможность отмены заказа
- [ ] Статусы заказов (будет определён коллегой позже)
- [ ] **Примечание:** Сущность "заказ" будет реализована позже (сегодня, но несколько позже). Интеграция с платежами - не в MVP.

#### 2.4. Вкладка "Форма обратной связи"
- [ ] Создать компонент `contact-form`
- [ ] Форма отправки сообщения:
  - [ ] Тема сообщения (обязательное)
  - [ ] Текст сообщения (обязательное, многострочное)
- [ ] Отправка на email: zakaz@elka-retro.ru
- [ ] Валидация полей
- [ ] Обработка ошибок отправки
- [ ] Уведомление об успешной отправке
- [ ] **Примечание:** Прикрепление файлов (картинки, PDF, до 10 МБ), история сообщений, статусы - не в MVP

#### 2.5. Сервисы профиля
- [ ] Создать `user-service.js`
- [ ] Реализовать методы: `getProfile()`, `updateProfile()`, `changePassword()`
- [ ] Создать `profile-api-adapter.js` для преобразования данных

### Фаза 3: Интеграция

#### 3.1. Интеграция в навигацию
- [ ] Добавить иконку "Войти" / "Регистрация" в правой части хедера
- [ ] Для авторизованных пользователей:
  - [ ] Кружочек с одной/двумя первыми буквами display name
  - [ ] Выпадающее меню пользователя (при клике на кружочек)
  - [ ] Пункты меню: "Профиль", "Выйти"
- [ ] Открытие модальных окон авторизации/регистрации при клике на иконку
- [ ] Регистрация компонентов в `components/components.js`
- [ ] Добавление в фильтр `elkaretro_required_components`
- [ ] URL страницы профиля: `/profile/`

#### 3.2. REST API endpoints (PHP)
- [ ] Создать `core/user-profile/user-profile-rest-controller.php`
- [ ] Endpoint для получения расширенного профиля
- [ ] Endpoint для обновления профиля
- [ ] Endpoint для смены пароля
- [ ] Endpoint для сохранения сообщений обратной связи
- [ ] Endpoint для получения истории сообщений
- [ ] Регистрация endpoints в `core/user-profile/user-profile-loader.php`

#### 3.3. Защита и безопасность
- [ ] Проверка WordPress nonce для всех запросов (CSRF защита)
- [ ] Проверка прав доступа (capabilities)
- [ ] Санитизация всех входных данных
- [ ] Валидация на сервере
- [ ] Защита от XSS (стандартная WordPress защита)
- [ ] Защита от брутфорса (ограничение попыток входа)
- [ ] Защита страницы профиля (только для авторизованных)

## Post-MVP (Будущие возможности)

### WishList (Избранное)
- [ ] Сущность "WishList" в дата-модели
- [ ] Компонент списка избранного
- [ ] Добавление/удаление товаров в избранное
- [ ] Синхронизация между устройствами
- [ ] Экспорт списка избранного

### Кастомные запросы
- [ ] Форма создания кастомного запроса
- [ ] Указание параметров поиска (фильтры, цена, состояние)
- [ ] История запросов
- [ ] Уведомления о новых товарах, соответствующих запросу
- [ ] REST API для управления запросами

### Интеграция с аукционом
- [ ] Отображение активных ставок пользователя
- [ ] История участия в аукционах
- [ ] Уведомления о статусе ставок
- [ ] Страница детального просмотра аукциона
- [ ] REST API для работы со ставками

### Продажа своих экземпляров
- [ ] Форма добавления экземпляра на продажу
- [ ] Загрузка фотографий
- [ ] Указание параметров (состояние, цена, описание)
- [ ] Модерация перед публикацией
- [ ] Управление своими объявлениями
- [ ] Статистика продаж
- [ ] **Примечание:** Это большая функциональность, требует отдельного планирования

## Технические улучшения

### Производительность
- [ ] Ленивая загрузка вкладок профиля (требование MVP)
- [ ] Время загрузки страницы профиля до 4 секунд (требование MVP)
- [ ] Адаптивность для мобильных устройств (требование MVP)
- [ ] Кэширование данных профиля (не в MVP)
- [ ] Оптимизация запросов к REST API
- [ ] Debounce для автосохранения

### UX улучшения
- [ ] Анимации переходов между вкладками
- [ ] Skeleton loaders для загрузки данных
- [ ] Toast уведомления для действий
- [ ] Подтверждение деструктивных действий (смена email, удаление аккаунта)
- [ ] Показывать overlay поверх экрана после нажатия на "Выйти" (визуальная обратная связь во время процесса выхода)

### Доступность (A11y)
- [ ] ARIA атрибуты для всех форм
- [ ] Навигация с клавиатуры
- [ ] Screen reader поддержка
- [ ] Фокус-менеджмент в модальных окнах

### Локализация
- [ ] Переводы всех строк
- [ ] Форматирование дат и чисел
- [ ] Поддержка RTL (если потребуется)

## Post-MVP: Автоматическое удаление аккаунтов

### Соответствие 152 ФЗ РФ
- [ ] Реализовать функцию автоматического удаления аккаунтов через 3 года (срок хранения персональных данных)
- [ ] Создать cron-задачу для проверки и удаления устаревших аккаунтов
- [ ] Уведомление пользователей перед удалением (за 30 дней, за 7 дней)
- [ ] Экспорт данных пользователя перед удалением (если требуется)
- [ ] Логирование удалений аккаунтов

## Приоритеты

**Высокий приоритет (MVP):**
- Модальные формы авторизации (email, login, phone, пароль 16+ символов)
- Страница профиля с настройками (редактирование: имя, фамилия, email, phone, display name, адрес, мессенджер)
- Базовая форма обратной связи (тема, текст → zakaz@elka-retro.ru)
- Интеграция в хедер (иконка, кружочек с буквами, выпадающее меню)
- Защита и безопасность (nonce, брутфорс защита, валидация)

**Средний приоритет:**
- История заказов (после реализации сущности заказа)
- Сортировка заказов (старые/новые), подгрузка при скролле
- Отмена заказа

## Рефакторинг (текущая работа)

### Миграция форм на централизованные конфигурации

**Контекст:** Формы должны использовать централизованные конфигурации в `app/forms/` вместо программной инициализации в компонентах.

**Документация:** [`app/forms/README.md`](../../app/forms/README.md)  
**TODO:** [`app/forms/TODO.md`](../../app/forms/TODO.md)

#### Задачи:
- [x] Создать документацию по работе с формами (`app/forms/README.md`)
- [x] Создать TODO список для рефакторинга форм (`app/forms/TODO.md`)
- [x] Вынести auth-модали в `user-ui-service` + `app.modal`
- [x] Мигрировать `register` и `password-reset` формы в `app/forms/`
- [ ] Мигрировать `profile-settings` на `app/forms/profile-edit.js` и `app/forms/profile-change-password.js`
- [ ] Мигрировать `contact-form` на `app/forms/contact.js`
- [ ] Обновить все места, где используется программная инициализация форм (`_initForm`, `setState`, `configure`)

**Детальные задачи и инструкции по миграции см. в [`app/forms/TODO.md`](../../app/forms/TODO.md)**

### Event Actions & App Event Bus (новый подход)

**Цель:** отказаться от ручного навешивания обработчиков в модалях/компонентах и перейти на событийную шину (`app.events`) + декларативные `data-app-action`.

#### Фаза 0 — Документация и план (текущий статус)
- [x] Подготовить архитектурный документ (`app/events/README.md`).
- [x] Обновить UI-kit и user-profile документацию с ссылками на новую архитектуру.
- [x] Согласовать единый формат `data-app-action`, `data-app-payload`, `namespace.action`.

#### Фаза 1 — Инфраструктура
- [x] Реализовать `app/events/index.js` (регистрация, emit, DOM-диспетчеризация).
- [x] Подключить глобальный делегат кликов/клавиш в `app/app.js`.
- [ ] Обновить `app/modal-manager.js` (если потребуется) для работы с событиями без `onBodyReady`.

#### Фаза 2 — Auth UI (пилот)
- [x] Добавить `data-app-action` в шаблоны auth-модалей вместо ручных `addEventListener`.
- [x] `userUiService` регистрирует действия через `app.events.register('user', {...})`.
- [x] Удалить `onBodyReady`-обработчики и промежуточную логику.

#### Фаза 3 — Расширение
- [x] Перевести `user-menu`, `site-header`, `step-auth` на `data-app-action`.
- [x] Описать дополнительные действия (`user.logout`, `user.openProfile`, `cart.openAuthStep`, и т.д.).
- [x] Добавить гайдлайн в UI-kit о работе с `data-app-action`.

**Низкий приоритет (Post-MVP):**
- OAuth (социальные сети)
- Двухфакторная аутентификация (2FA)
- Верификация email
- Капча при регистрации
- Аватар пользователя
- День рождения
- Прикрепление файлов к обратной связи
- История сообщений обратной связи
- Интеграция с платежами
- WishList (после MVP, синхронизация между устройствами)
- Кастомные запросы (после MVP)
- Интеграция с аукционом (активные ставки в профиле)
- Продажа своих экземпляров (модерация, редактирование/удаление)
- Автоматическое удаление аккаунтов через 3 года (152 ФЗ РФ)


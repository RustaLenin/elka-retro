# Архитектура каталога новогодних аксессуаров

## Контекст

Нужно реализовать каталог новогодних аксессуаров (`ny_accessory`), который:
- **Похож на каталог игрушек**, но без переключения между типами и экземплярами (один режим)
- **Показывает остатки** (`stock` поле) на карточках
- **Не должен ломать** существующий каталог игрушек

## Отличия от каталога игрушек

| Аспект | Каталог игрушек | Каталог аксессуаров |
|--------|----------------|---------------------|
| Post Type | `toy_type`, `toy_instance` | `ny_accessory` |
| Режимы | `type` / `instance` (переключение) | Один режим (без переключения) |
| REST Endpoint | `/catalog/types`, `/catalog/instances` | `/catalog/accessories` (новый) |
| Фильтры | Разные для type/instance | Специфичные для аксессуаров |
| Остатки | Нет поля stock | Поле `stock` (показывать на карточке) |
| Категории | Иерархическая `category-of-toys` | Плоская `ny_category` |

## Варианты архитектуры

### Вариант 1: Полное дублирование (не рекомендуется)

**Идея:** Создать полностью отдельную структуру `components/accessory-catalog/`

**Плюсы:**
- ✅ Полная изоляция - невозможно сломать каталог игрушек
- ✅ Независимая разработка

**Минусы:**
- ❌ Дублирование ~80% кода
- ❌ Сложность поддержки (баги нужно фиксить в двух местах)
- ❌ Нарушение принципа DRY

---

### Вариант 2: Расширение существующего каталога (рискованно)

**Идея:** Добавить `mode='accessory'` в существующий `CatalogStore` и условную логику везде

**Плюсы:**
- ✅ Переиспользование всего кода
- ✅ Единая точка истины

**Минусы:**
- ❌ **ВЫСОКИЙ РИСК** поломать существующий каталог
- ❌ Усложнение кода условными проверками
- ❌ Сложность тестирования

---

### Вариант 3: Гибридный подход через конфигурацию (РЕКОМЕНДУЕМЫЙ) ✅

**Идея:** Создать базовые классы/утилиты и специализированные компоненты для аксессуаров

**Структура:**
```
components/
  catalog/                    # Каталог игрушек (не трогаем!)
    catalog-page.js
    catalog-store.js
    ...
  
  accessory-catalog/          # Каталог аксессуаров (новый)
    accessory-catalog-page.js  # Наследует базовую логику
    shared/                    # Общие утилиты
      catalog-base-page.js     # Базовая логика оркестратора
      catalog-base-results.js  # Базовая логика результатов
    ...
  
  catalog-shared/             # Общие утилиты для обоих каталогов (новый)
    catalog-url-state.js       # (можно переиспользовать текущий)
    result-card-adapter.js     # Адаптер для карточек
    ...
```

**Плюсы:**
- ✅ Изоляция - невозможно сломать каталог игрушек
- ✅ Переиспользование общей логики (URL, результаты, toolbar)
- ✅ Легко расширять в будущем
- ✅ Понятная структура

**Минусы:**
- ⚠️ Нужен рефакторинг общих частей (но можно делать постепенно)

---

### Вариант 4: Композиция через фабрики (сложный, но гибкий)

**Идея:** Создать фабрику каталогов, которая собирает компоненты по конфигурации

**Плюсы:**
- ✅ Максимальная гибкость
- ✅ Переиспользование кода
- ✅ Легко добавлять новые типы каталогов

**Минусы:**
- ❌ Сложность реализации
- ❌ Избыточность для текущих задач
- ❌ Нужен большой рефакторинг

---

## Рекомендуемый подход: Вариант 3 (Гибридный)

### Фаза 1: Подготовка общих утилит

1. **Вынести общие утилиты:**
   - `catalog-url-state.js` → можно переиспользовать как есть
   - `result-card-adapter.js` → расширить для аксессуаров
   - Логика infinite scroll → вынести в базовый класс

2. **Создать базовые классы:**
   - `BaseCatalogPage` - базовая логика оркестратора (URL, infinite scroll, состояние)
   - `BaseCatalogResults` - базовая логика результатов

### Фаза 2: Реализация каталога аксессуаров

1. **Backend:**
   - Новый endpoint `/catalog/accessories` в `Catalog_REST_Controller`
   - Новый сервис `Catalog_Accessory_Service` (аналог `Catalog_Toy_Type_Service`)
   - Адаптер ответов для аксессуаров

2. **Frontend:**
   - `AccessoryCatalogPage` - наследует `BaseCatalogPage` или использует композицию
   - `AccessoryCatalogSidebar` - без mode-toggle, только фильтры аксессуаров
   - `AccessoryCatalogResults` - показывает остатки на карточках
   - Новый компонент карточки или расширить существующий

3. **Карточки с остатками:**
   - Расширить `ny-accessory-card` для показа `stock`
   - Или создать новый компонент `accessory-catalog-card`

### Фаза 3: Интеграция

1. **Новая страница/шаблон:**
   - WordPress шаблон для страницы каталога аксессуаров
   - Web Component `<accessory-catalog-page>`

2. **Загрузка скриптов:**
   - Условная загрузка в `components.js` (как сейчас для `catalog-page`)
   - Отдельный loader или общий с условиями

---

## Детальный план реализации (Вариант 3)

### Шаг 1: Backend API

**Файлы:**
- `core/catalog/catalog-accessory-service.php` (новый)
- `core/catalog/catalog-rest-controller.php` (добавить endpoint)
- `core/catalog/catalog-response-adapter.php` (расширить для аксессуаров)
- `core/catalog/catalog-query-manager.php` (добавить метод `build_accessory_query_args`)

**Endpoint:**
```php
GET /wp-json/elkaretro/v1/catalog/accessories?offset=0&limit=30&sort=newest&ny_category=1,2
```

### Шаг 2: Frontend - Общие утилиты

**Создать `components/catalog-shared/`:**
- `catalog-url-state.js` (скопировать/переиспользовать текущий)
- `catalog-base-page.js` (базовая логика оркестратора)
- `catalog-base-results.js` (базовая логика результатов)

### Шаг 3: Frontend - Компоненты каталога аксессуаров

**Структура:**
```
components/accessory-catalog/
  accessory-catalog-page.js       # Главный оркестратор
  accessory-catalog-page-template.js
  accessory-catalog-page-styles.css
  sidebar/
    accessory-catalog-sidebar.js  # Без mode-toggle
    accessory-sidebar-template.js
    accessory-sidebar-styles.css
    accessory-filter-registry.js  # Фильтры для аксессуаров
  toolbar/
    accessory-catalog-toolbar.js  # Переиспользовать общий
  results/
    accessory-catalog-results.js  # С поддержкой остатков
    accessory-results-template.js
```

### Шаг 4: Карточки с остатками

**Варианты:**
1. Расширить существующий `ny-accessory-card` компонент
2. Создать новый `accessory-catalog-card` для каталога

**Нужно показывать:**
- Остаток `stock` (если > 0)
- Индикатор "Нет в наличии" (если stock = 0)
- Возможно, визуальное отличие (серый, disabled) для отсутствующих

### Шаг 5: Интеграция

1. **WordPress шаблон:** создать шаблон страницы каталога аксессуаров
2. **Web Component:** `<accessory-catalog-page endpoint="..." data-per-page="30">`
3. **Script loader:** добавить в `components.js` условную загрузку

---

## Решения (зафиксировано)

1. **REST Endpoint:** ✅ **Новый** `/catalog/accessories` (отдельный endpoint)

2. **Store:** ✅ **Новый** `AccessoryCatalogStore` (отдельный store для изоляции)

3. **URL формат:** Использовать тот же формат (`/accessories/?ny_category=1,2&material=1,2`)

4. **Карточки:** ✅ Использовать существующий `ny-accessory-card` компонент

5. **Фильтры:** Показывать все перечисленные **кроме собственности (property)**:
   - `ny_category` (плоская таксономия)
   - `lot_configurations` (множественный выбор)
   - `condition` (множественный выбор)
   - `material` (множественный выбор)
   - `year_of_production` (множественный выбор)

6. **Остатки:** ✅ Бейдж с текстом **"Остаток: ${stock}"** на карточке

7. **Архитектура:** ✅ **Вариант 3 (Гибридный)** - базовые классы + отдельные компоненты

---

## Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Поломка каталога игрушек | Низкая | Высокое | Полная изоляция через отдельные файлы |
| Дублирование кода | Средняя | Среднее | Вынесение общих утилит в `catalog-shared/` |
| Сложность поддержки | Средняя | Среднее | Чёткая документация и структура |
| Производительность | Низкая | Низкое | Переиспользование проверенных компонентов |

---

## Следующие шаги

1. ✅ Обсудить и выбрать вариант архитектуры
2. Реализовать Backend API (endpoint, сервис, адаптер)
3. Вынести общие утилиты в `catalog-shared/`
4. Реализовать Frontend компоненты каталога аксессуаров
5. Добавить отображение остатков на карточках
6. Интегрировать в WordPress (шаблоны, загрузка скриптов)
7. Прокинуть ссылки на каталог со страницы аксессуара и с главной
8. Тестирование и проверка изоляции от каталога игрушек

